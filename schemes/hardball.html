<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta name="generator" content="REBOL" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

  <title>Hardball</title>

<style type="text/css">
/*<![CDATA[*/
html, body, p, li {font-family: Georgia, Times New Roman, serif; text-align: justify;}
.code, .code p {font-family: Trebuchet MS, Arial, Helvetica, sans-serif;}
.code .string, .code .tag, .code .issue {font-family: Lucida Console, Courier New, Courier, fixed;}
.code .word, .code .set-word, .code .lit-word, .code .get-word, .code .refinement {font-style: italic;}
.code .key {font-style: normal; font-weight: bold;}
.code .function {font-weight: bold; font-style: normal;}
.code .ref a {text-decoration: none; color: black;}
.code .ref a:hover {text-decoration: underline; color: blue;}
.code .issue, .code .tag, .code .datatype {color: green;}
.code .datatype {font-style: normal;}
.code .url, .code .file, .code .refinement, .code .lit-word {color: brown;}
.code .integer, .code .decimal, .code .tuple, .code .pair {color: blue;}
.code .comment {color: gray;}
div.code {margin-left: 95pt;}
div.code p.sectdef {font-style: normal; margin: 0 0 0 -30pt;}
div.code p {margin: 0;}
div.code span.tab {padding-left: .75cm; border-left: dotted thin #CCCCCC;}
div.code span.directive {background-color: #F0FFF0; border: dotted thin black;}
#header {margin: 34pt 140pt 140pt 140pt; padding: 0;}
#title {text-align: center; margin: 0 0 34pt 0;}
#author {text-align: center; margin: 13pt 0 0 0; font-size: 13pt;}
#dateversion {text-align: center; margin: 0 0 24pt 0; font-size: 12pt;}
#purpose {text-align: justify; font-style: italic;}
#license {font-size: 7pt; color: gray; margin: 2pt 10pt 2pt 10pt; width: 200pt; float: right; white-space: pre;}
#history {width: 60%; font-size: 10pt; margin-left: auto; margin-right: auto;}
#history thead tr {background-color: #E0E0E0;}
#history td.date {text-align: right;}
#history td.version {text-align: center;}
#history td.desc {width: 100%; text-align: justify;}
#history td.name {text-align: left;}
#toc {margin: 70pt;}
#toc li {list-style: none;}
.section {margin: 70pt 70pt 70pt 100pt;}
.section h2, .section h3 {margin-left: -30pt;}
pre {font-family: Lucida Console; overflow: scroll;}
.center {margin-left: auto; margin-right: auto; text-align: center;}
span.bra {font-family: Arial Unicode MS;}
div.note {margin: 3pt; margin-bottom: 14pt; padding: 0 12pt 6pt 12pt; background-color: #E0E0E0;}
div.note h2 {
    margin: 0 -12pt 12pt -12pt;
    padding: 5pt;
    text-align: center;
    background-color: #606060;
    color: white;
    font-size: 14pt;
}
div.image {text-align: center;}
div.image img {padding: 10px; border: dashed thin black;}
/*]]>*/
</style>
</head>

<body>
    <div id="header"><h1 id="title">Hardball</h1><h2 id="author">Gabriele Santilli</h2><h2 id="dateversion">1.0.6</h2><p id="purpose">
        Allows working with remote modules, by calling their exported functions
        via RPC over a TCP connection.
    </p><div id="license">
        =================================
        A message from Qtask about this source code:

        We have selected the MIT license (as of 2010-Jan-1) because
        it is the closest “standard” license to our intent.  If we had our way,
        we would declare this source as public domain, with absolutely no
        strings attached, not even the string that says you have to have
        strings.  We want to help people, so please feel free to contact us
        at API@Qtask.com if you have questions.
         

        (you only need to include the standard license text below in your
        homage to this source code)
        =================================

        Copyright 2010 Qtask, Inc.

        Permission is hereby granted, free of charge, to any person obtaining
        a copy of this software and associated documentation files
        (the "Software"), to deal in the Software without restriction, including
        without limitation the rights to use, copy, modify, merge, publish,
        distribute, sublicense, and/or sell copies of the Software, and to
        permit persons to whom the Software is furnished to do so, subject
        to the following conditions:

        The above copyright notice and this permission notice shall be included
        in all copies or substantial portions of the Software.

        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
        OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
        FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
        THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
        OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
        ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
        OTHER DEALINGS IN THE SOFTWARE.
    </div></div><div id="toc"><h2>Contents:</h2><ul><li><a href="#section-1">1. Introduction</a></li><li><a href="#section-2">2. Overview</a></li><li><a href="#section-3">3. Set up the default configuration values for the client and the server</a></li><li><a href="#section-4">4. Export <span class="code"><span class="word">modules</span></span> over the network by listening on TCP port <span class="code"><span class="word">port-id</span></span> and executing requests</a></li><ul><li><a href="#section-4.1">4.1 <span class="code"><span class="word">serve-modules</span></span> support functions</a></li></ul><li><a href="#section-5">5. Hardball scheme handler functions</a></li><li><a href="#section-6">6. Low level client-side functions</a></li><ul><li><a href="#section-6.1">6.1 Create a client configuration object</a></li><li><a href="#section-6.2">6.2 Open TCP connection to <span class="code"><span class="word">server</span></span>, perform the handshake, and return the port</a></li><li><a href="#section-6.3">6.3 List the modules exported by the server</a></li><li><a href="#section-6.4">6.4 List the functions exported by <span class="code"><span class="word">module</span></span> on <span class="code"><span class="word">server</span></span></a></li><li><a href="#section-6.5">6.5 Call the function specified by <span class="code"><span class="word">block</span></span> in <span class="code"><span class="word">module</span></span> on <span class="code"><span class="word">server</span></span> and return its result</a></li><li><a href="#section-6.6">6.6 Client-side support functions</a></li></ul><li><a href="#section-7">7. Functions common to server and client</a></li><ul><li><a href="#section-7.1">7.1 List of error values</a></li></ul></ul></div><div class="section"><h2 id="section-1">1. Introduction</h2><p>Hardball is Rugby's successor. It is a simple RPC broker for REBOL that allows importing
a "remote" module and using it just like it was local.</p><p>For example, if you have <span class="code"><span class="file">%my-module.r</span></span> that you are importing in your program, like:</p><div class="code"><p><span class="word">module</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">Imports:</span> [<span class="file">%my-module.r</span>]<br />] [<br /><span class="tab">&nbsp;</span><span class="word">do-something</span><br />]</p></div><p>but you want to move it to a separate process, perhaps on a remote computer, you just
need to change that to:</p><div class="code"><p><span class="word">module</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">Imports:</span> [<span class="url">hardball://somehost/my-module.r</span>]<br />] [<br /><span class="tab">&nbsp;</span><span class="word">do-something</span><br />]</p></div><p>Provided you're running:</p><div class="code"><p><span class="word">serve-modules</span> <span class="file">%my-module.r</span></p></div><p>on "somehost".</p></div><div class="section"><h2 id="section-2">2. Overview</h2><p>Basically, we just define the <span class="code"><span class="url">hardball://</span></span> scheme, which generates a local stub module
that calls the remote system, and the <span class="code"><span class="word">serve-modules</span></span> function which starts a Hardball server.</p><p><span class="code"><span class="word">configure-hardball</span></span> can be used to set the default values for the configuration. This is
necessary on the client side because you don't have any chance to specify a configuration
when using a URL like <span class="code"><span class="url">hardball://somehost/somemodule.r</span></span>.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Overview<span class="bra">&#9002;</span> &#8801;</p><p><span class="ref"><span class="bra">&#9001;</span><a href="#section-7">Functions common to server and client</a><span class="bra">&#9002;</span></span><br /><span class="set-word">configure-hardball:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Set up default values for Harball's configuration"</span> [<span class="word key"title="CATCH block /name word">catch</span>]<br /><span class="tab">&nbsp;</span><span class="word">config</span> [<span class="word datatype"title="">block!</span>]<br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3">Set up the default configuration values for the client and the server</a><span class="bra">&#9002;</span></span><br />]<br /><br /><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.1"><span class="code"><span class="word">serve-modules</span></span> support functions</a><span class="bra">&#9002;</span></span><br /><span class="set-word">serve-modules:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">{Start the Hardball server, giving access to the given modules}</span> [<span class="word key"title="CATCH block /name word">catch</span>]<br /><span class="tab">&nbsp;</span><span class="word">config</span> [<span class="word datatype"title="">file!</span> <span class="word datatype"title="">object!</span> <span class="word datatype"title="">url!</span> <span class="word datatype"title="">block!</span>] <span class="string">{Module or list of modules to export over the network, or list of configuration values}</span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-4">Export <span class="code"><span class="word">modules</span></span> over the network by listening on TCP port <span class="code"><span class="word">port-id</span></span> and executing requests</a><span class="bra">&#9002;</span></span><br />]</p></div><p>The client side is a <em>pass-thru</em> protocol handler. It actually just returns a stub module
that calls the remote functions. (This currently also means that two connections to the servers
are actually created: one when the stub is created - and this is usually closed just after that -
and another one - which is used when calling functions - when the stub module is actually loaded.)</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Overview<span class="bra">&#9002;</span> +&#8801;</p><p><span class="word key"title="MAKE type spec">make</span> <span class="word">Root-Protocol</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">port-flags:</span> <span class="path"><span class="word">system</span>/<span class="word">standard</span>/<span class="word">port-flags</span>/<span class="word">pass-thru</span></span><br /><br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-5">Hardball scheme handler functions</a><span class="bra">&#9002;</span></span><br /><br /><span class="tab">&nbsp;</span><span class="path"><span class="word">net-utils</span>/<span class="word">net-install</span></span> <span class="word">Hardball</span> <span class="word">self</span> <span class="integer">1025</span><br />]</p></div><p>When using the client at a lower level, you can use <span class="code"><span class="word">make-hardball-configuration</span></span>,
<span class="code"><span class="word">open-hardball-connection</span></span>, <span class="code"><span class="word">list-exported-modules</span></span>, <span class="code"><span class="word">list-exported-functions</span></span> and
<span class="code"><span class="word">call-remote-function</span></span>.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Overview<span class="bra">&#9002;</span> +&#8801;</p><p><span class="ref"><span class="bra">&#9001;</span><a href="#section-6.6">Client-side support functions</a><span class="bra">&#9002;</span></span><br /><span class="set-word">make-hardball-configuration:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Return a Hardball client configuration object"</span> [<span class="word key"title="CATCH block /name word">catch</span>]<br /><span class="tab">&nbsp;</span><span class="word">config</span> [<span class="word datatype"title="">block!</span>]<br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-6.1">Create a client configuration object</a><span class="bra">&#9002;</span></span><br />]<br /><span class="set-word">open-hardball-connection:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Open a connection to a Hardball server"</span> [<span class="word key"title="CATCH block /name word">catch</span>]<br /><span class="tab">&nbsp;</span><span class="word">config</span> [<span class="word datatype"title="">object!</span>] <span class="string">"Client configuration object"</span><br /><span class="tab">&nbsp;</span><span class="word">server</span> [<span class="word datatype"title="">url!</span> <span class="word datatype"title="">port!</span> <span class="word datatype"title="">block!</span>] <span class="string">"TCP URL or port spec"</span><br /><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="ref"><span class="bra">&#9001;</span><a href="#section-6.2.1"><span class="code"><span class="word">open-hardball-connection</span></span>'s locals</a><span class="bra">&#9002;</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-6.2">Open TCP connection to <span class="code"><span class="word">server</span></span>, perform the handshake, and return the port</a><span class="bra">&#9002;</span></span><br />]<br /><span class="set-word">list-exported-modules:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"List the modules exported by the server"</span> [<span class="word key"title="CATCH block /name word">catch</span>]<br /><span class="tab">&nbsp;</span><span class="word">server</span> [<span class="word datatype"title="">port!</span>] <span class="string">"Connection to the Hardball server"</span><br /><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="ref"><span class="bra">&#9001;</span><a href="#section-6.3.1"><span class="code"><span class="word">list-exported-modules</span></span>'s locals</a><span class="bra">&#9002;</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-6.3">List the modules exported by the server</a><span class="bra">&#9002;</span></span><br />]<br /><span class="set-word">list-exported-functions:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"List the functions exported by a remote module"</span> [<span class="word key"title="CATCH block /name word">catch</span>]<br /><span class="tab">&nbsp;</span><span class="word">server</span> [<span class="word datatype"title="">port!</span>] <span class="string">"Connection to the Hardball server"</span><br /><span class="tab">&nbsp;</span><span class="word">module</span> [<span class="word datatype"title="">file!</span>] <span class="string">"Module name"</span><br /><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="ref"><span class="bra">&#9001;</span><a href="#section-6.4.1"><span class="code"><span class="word">list-exported-functions</span></span>'s locals</a><span class="bra">&#9002;</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-6.4">List the functions exported by <span class="code"><span class="word">module</span></span> on <span class="code"><span class="word">server</span></span></a><span class="bra">&#9002;</span></span><br />]<br /><span class="set-word">call-remote-function:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Call a function in a module on a Hardball server"</span> [<span class="word key"title="CATCH block /name word">catch</span>]<br /><span class="tab">&nbsp;</span><span class="word">server</span> [<span class="word datatype"title="">port!</span>] <span class="string">"Connection to the Hardball server"</span><br /><span class="tab">&nbsp;</span><span class="word">module</span> [<span class="word datatype"title="">file!</span>] <span class="string">"Module name"</span><br /><span class="tab">&nbsp;</span><span class="word">block</span> [<span class="word datatype"title="">block!</span>] <span class="string">{Function name followed by arguments (will be reduced)}</span><br /><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="ref"><span class="bra">&#9001;</span><a href="#section-6.5.1"><span class="code"><span class="word">call-remote-function</span></span>'s locals</a><span class="bra">&#9002;</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-6.5">Call the function specified by <span class="code"><span class="word">block</span></span> in <span class="code"><span class="word">module</span></span> on <span class="code"><span class="word">server</span></span> and return its result</a><span class="bra">&#9002;</span></span><br />]</p></div></div><div class="section"><h2 id="section-3">3. Set up the default configuration values for the client and the server</h2><p>Note that no checking is done at this point. Also note that only values common
to both server and client (like the RSA keys) can be set here.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Set up the default configuration values for the client and the server<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">server-config!:</span> <span class="word">parse-config</span> <span class="word">server-config!</span> <span class="word">config</span><br /><span class="set-word">client-config!:</span> <span class="word">parse-config</span> <span class="word">client-config!</span> <span class="word">config</span><br /><span class="word">none</span></p></div></div><div class="section"><h2 id="section-4">4. Export <span class="code"><span class="word">modules</span></span> over the network by listening on TCP port <span class="code"><span class="word">port-id</span></span> and executing requests</h2><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Export <span class="code"><span class="word">modules</span></span> over the network by listening on TCP port <span class="code"><span class="word">port-id</span></span> and executing requests<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">configuration:</span> <span class="word">parse-server-config</span> <span class="word">config</span><br /><span class="word">setup-logging</span> <span class="path"><span class="word">configuration</span>/<span class="word">logging</span></span><br /><span class="word">append-log</span> <span class="lit-word">'info</span> [<span class="string">"Hardball server starting"</span>]<br /><span class="word">append-log</span> <span class="lit-word">'debug</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Exporting"</span> <span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="BLOCK? value">block?</span> <span class="path"><span class="word">configuration</span>/<span class="word">modules</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="DIVIDE value1 value2">divide</span> <span class="word key"title="LENGTH? series">length?</span> <span class="path"><span class="word">configuration</span>/<span class="word">modules</span></span> <span class="integer">2</span><br /><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="integer">1</span><br /><span class="tab">&nbsp;</span>] <span class="string">"module(s)"</span><br />]<br /><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"Public key:^/"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="path"><span class="word">configuration</span>/<span class="word">public-key</span></span>]<br /><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"Allowed peers:^/"</span> <span class="path"><span class="word key"title="MOLD value /only /all /flat">mold</span>/<span class="word">only</span></span> <span class="path"><span class="word">configuration</span>/<span class="word">allowed-peers</span></span>]<br /><span class="word">log-errors</span> [<br /><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"Listening to port"</span> <span class="path"><span class="word">configuration</span>/<span class="word">port-id</span></span>]<br /><span class="tab">&nbsp;</span><span class="set-word">listen:</span> <span class="path"><span class="word key"title="OPEN spec /binary /string /direct /seek /new /read /write /no-wait /lines /with end-of-line /allow access /mode args /custom params /skip length">open</span>/<span class="word">binary</span>/<span class="word">no-wait</span></span> [<span class="set-word">scheme:</span> <span class="lit-word">'tcp</span> <span class="set-word">port-id:</span> <span class="path"><span class="word">configuration</span>/<span class="word">port-id</span></span>]<br /><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'listening</span><br /><span class="tab">&nbsp;</span><span class="set-word">connections:</span> <span class="word key"title="REDUCE value /only words">reduce</span> [<span class="word">listen</span>]<br /><span class="tab">&nbsp;</span><span class="set-path">listen/awake:</span> <span class="get-word">:listen-awake</span><br /><span class="tab">&nbsp;</span><span class="word key"title="WAIT value /all">wait</span> <span class="word">connections</span><br />] [<br /><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'info</span> [<span class="string">"Hardball server shutting down"</span>]<br /><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'quitting</span><br /><span class="tab">&nbsp;</span><span class="word key"title="FOREACH 'word data body">foreach</span> <span class="word">connection</span> <span class="word">connections</span> [<span class="word key"title="ATTEMPT value">attempt</span> [<span class="word key"title="CLOSE port">close</span> <span class="word">connection</span>]]<br /><span class="tab">&nbsp;</span><span class="word key"title="CLEAR series">clear</span> <span class="word">connections</span><br />]<br /><span class="word">none</span></p></div><h3 id="section-4.1">4.1 <span class="code"><span class="word">serve-modules</span></span> support functions</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">serve-modules</span></span> support functions<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">connections:</span> [ ]<br /><span class="set-word">log-errors:</span> <span class="word key"title="FUNC spec body">func</span> [[<span class="word key"title="THROW value /name word">throw</span>] <span class="word">code</span> <span class="word">cleanup</span> <span class="refinement">/local</span> <span class="word">error</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="ERROR? value">error?</span> <span class="path"><span class="word key"title="SET word value /any /pad">set</span>/<span class="word key"title="ANY block">any</span></span> <span class="lit-word">'error</span> <span class="word key"title="TRY block">try</span> <span class="word">code</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'fatal</span> [<span class="string">"Fatal error:^/"</span> <span class="path"><span class="word">form-error</span>/<span class="word key"title="ALL block">all</span></span> <span class="word key"title="DISARM error">disarm</span> <span class="word">error</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="ATTEMPT value">attempt</span> <span class="word">cleanup</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">error</span><br /><span class="tab">&nbsp;</span>] <span class="word">cleanup</span><br />]<br /><span class="set-word">server-config!:</span> <span class="word key"title="MAKE type spec">make</span> <span class="word">config!</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">modules:</span> <span class="word">none</span><br /><span class="tab">&nbsp;</span><span class="set-word">port-id:</span> <span class="integer">1025</span><br /><span class="tab">&nbsp;</span><span class="set-word">logging:</span> [<span class="word">only</span> [<span class="word">fatal</span> <span class="word">error</span> <span class="word">info</span>] <span class="word key"title="TO type spec">to</span> <span class="word">output</span>]<br />]<br /><span class="set-word">listen-awake:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span> <span class="refinement">/local</span> <span class="word">conn</span> <span class="word">error</span>] [<br /><span class="tab">&nbsp;</span><span class="comment">; we have a new connection</span><br /><span class="tab">&nbsp;</span><span class="set-word">conn:</span> <span class="word key"title="FIRST series">first</span> <span class="word">port</span><br /><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'info</span> [<span class="string">"Hello to"</span> <span class="path"><span class="word">conn</span>/<span class="word">remote-ip</span></span> <span class="string">":"</span> <span class="path"><span class="word">conn</span>/<span class="word">remote-port</span></span>]<br /><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'got-connection</span><br /><span class="tab">&nbsp;</span><span class="comment">; set it up, send greeting</span><br /><span class="tab">&nbsp;</span><span class="set-path">conn/locals:</span> <span class="word key"title="CONTEXT blk">context</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">session:</span> <span class="word">make-messages-session</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">buffer:</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="binary">#{}</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="set-path">conn/awake:</span> <span class="get-word">:server-awake</span><br /><span class="tab">&nbsp;</span><span class="comment">; if we get an error here, we just close the connection</span><br /><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="ERROR? value">error?</span> <span class="set-word">error:</span> <span class="word key"title="TRY block">try</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'greeting</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">greet-messages-peer</span> <span class="word">conn</span> <span class="path"><span class="word">conn</span>/<span class="word">locals</span>/<span class="word">session</span></span> <span class="word">configuration</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="APPEND series value /only">append</span> <span class="word">connections</span> <span class="word">conn</span><br /><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'error-sending-greeting</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'error</span> [<span class="string">"Error sending greeting, closing connection:"</span> <span class="word">form-error</span> <span class="word key"title="DISARM error">disarm</span> <span class="word">error</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="ATTEMPT value">attempt</span> [<span class="word key"title="CLOSE port">close</span> <span class="word">conn</span>]<br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word">false</span><br />]<br /><span class="set-word">server-awake:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span> <span class="refinement">/local</span> <span class="word">data</span> <span class="word">message</span> <span class="word">error</span>] [<br /><span class="tab">&nbsp;</span><span class="comment">; incoming data</span><br /><span class="tab">&nbsp;</span><span class="word key"title="UNLESS condition block">unless</span> <span class="set-word">data:</span> <span class="word key"title="ATTEMPT value">attempt</span> [<span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">port</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'info</span> [<span class="string">"Goodbye to"</span> <span class="path"><span class="word">port</span>/<span class="word">remote-ip</span></span> <span class="string">":"</span> <span class="path"><span class="word">port</span>/<span class="word">remote-port</span></span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'client-close</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="CLOSE port">close</span> <span class="word">port</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="REMOVE series /part range">remove</span> <span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span> <span class="word">connections</span> <span class="word">port</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="RETURN value">return</span> <span class="word">false</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word">with</span> <span class="path"><span class="word">port</span>/<span class="word">locals</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="APPEND series value /only">append</span> <span class="word">buffer</span> <span class="word">data</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="ERROR? value">error?</span> <span class="set-word">error:</span> <span class="word key"title="TRY block">try</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="WHILE cond-block body-block">while</span> [<span class="set-word">message:</span> <span class="word">receive-message</span> <span class="word">buffer</span> <span class="word">session</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'got-message</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word">handle-message</span> <span class="word">port</span> <span class="word">session</span> <span class="word">message</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> [<span class="lit-word">'handle-message</span> <span class="lit-word">'returned</span> <span class="lit-word">'true</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="RETURN value">return</span> <span class="word">true</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> [<span class="lit-word">'error</span> <span class="lit-word">'during</span> <span class="lit-word">'receive-message</span> <span class="lit-word">'or</span> <span class="lit-word">'handle-message</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'error</span> [<span class="string">"Error while receiving/handling message:"</span> <span class="word">form-error</span> <span class="word key"title="DISARM error">disarm</span> <span class="word">error</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'info</span> [<span class="string">"Closing connection with"</span> <span class="path"><span class="word">port</span>/<span class="word">remote-ip</span></span> <span class="string">":"</span> <span class="path"><span class="word">port</span>/<span class="word">remote-port</span></span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="ATTEMPT value">attempt</span> [<span class="word key"title="CLOSE port">close</span> <span class="word">port</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="REMOVE series /part range">remove</span> <span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span> <span class="word">connections</span> <span class="word">port</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word">false</span><br />]<br /><span class="set-word">parse-server-config:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">config</span> <span class="refinement">/local</span> <span class="word">cfg</span> <span class="word">here</span> <span class="word">word</span>] [<br /><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'parsing-config</span><br /><span class="tab">&nbsp;</span><span class="word key"title="SWITCH value cases /default case">switch</span> <span class="path"><span class="word key"title="TYPE? value /word">type?</span>/<span class="word">word</span></span> <span class="word">config</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word datatype"title="">file!</span> <span class="word datatype"title="">url!</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'config-is-one-module</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="MAKE type spec">make</span> <span class="word">server-config!</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">modules:</span> <span class="word">prepare-module</span> <span class="word">load-module</span> <span class="word">config</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word datatype"title="">object!</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="UNLESS condition block">unless</span> <span class="word">module?</span> <span class="word">config</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">invalid-arg</span> <span class="word">config</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'config-is-one-module-object</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="MAKE type spec">make</span> <span class="word">server-config!</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">modules:</span> <span class="word">config</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word datatype"title="">block!</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'config-is-block</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">cfg:</span> <span class="word key"title="MAKE type spec">make</span> <span class="word">server-config!</span> [ ]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word">config</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">some</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word datatype"title="">file!</span> <span class="word">opt</span> [<span class="lit-word">'as</span> <span class="word datatype"title="">file!</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word datatype"title="">url!</span> <span class="lit-word">'as</span> <span class="word datatype"title="">file!</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word datatype"title="">word!</span> <span class="lit-word">'as</span> <span class="word datatype"title="">file!</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">end</span> (<span class="word">append-test-trace</span> <span class="lit-word">'config-is-list-of-modules</span> <span class="set-path">cfg/modules:</span> <span class="word">config</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">here:</span> (<span class="word">invalid-arg</span> <span class="word">here</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<span class="word">append-test-trace</span> <span class="lit-word">'config-is-setting-values</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="ANY block">any</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SET word value /any /pad">set</span> <span class="word">word</span> <span class="word datatype"title="">set-word!</span> <span class="word">do-next</span> (<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="UNLESS condition block">unless</span> <span class="set-word">word:</span> <span class="word key"title="IN object word">in</span> <span class="word">cfg</span> <span class="word">word</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">invalid-arg</span> <span class="word">word</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SET word value /any /pad">set</span> <span class="word">word</span> <span class="word">pop-result</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> [<span class="lit-word">'config</span> <span class="word">word</span> <span class="path"><span class="word key"title="MOLD value /only /all /flat">mold</span>/<span class="word key"title="ALL block">all</span></span> <span class="word key"title="GET word /any">get</span> <span class="word">word</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<span class="word">end</span> <span class="word">|</span> <span class="set-word">here:</span> (<span class="word">invalid-arg</span> <span class="word">here</span>)]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="SWITCH value cases /default case">switch</span>/<span class="word">default</span></span> <span class="path"><span class="word key"title="TYPE? value /word">type?</span>/<span class="word">word</span></span> <span class="path"><span class="word">cfg</span>/<span class="word">modules</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word datatype"title="">file!</span> <span class="word datatype"title="">url!</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'modules-is-one-file</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">cfg/modules:</span> <span class="word">prepare-module</span> <span class="word">load-module</span> <span class="path"><span class="word">cfg</span>/<span class="word">modules</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word datatype"title="">object!</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'modules-is-one-module</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="UNLESS condition block">unless</span> <span class="word">module?</span> <span class="path"><span class="word">cfg</span>/<span class="word">modules</span></span> [<span class="word">invalid-arg</span> <span class="path"><span class="word">cfg</span>/<span class="word">modules</span></span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word datatype"title="">block!</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'modules-is-a-block</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">cfg/modules:</span> <span class="word">parse-module-list</span> <span class="path"><span class="word">cfg</span>/<span class="word">modules</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">invalid-arg</span> <span class="path"><span class="word">cfg</span>/<span class="word">modules</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="UNLESS condition block">unless</span> <span class="word key"title="INTEGER? value">integer?</span> <span class="path"><span class="word">cfg</span>/<span class="word">port-id</span></span> [<span class="word">invalid-arg</span> <span class="path"><span class="word">cfg</span>/<span class="word">port-id</span></span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">cfg</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="set-word">parse-module-list:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">modules</span> <span class="refinement">/local</span> <span class="word key"title="MOD a b">mod</span> <span class="word">name</span>] [<br /><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'parsing-module-list</span><br /><span class="tab">&nbsp;</span><span class="word">collect</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word">modules</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">some</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SET word value /any /pad">set</span> <span class="word key"title="MOD a b">mod</span> <span class="word datatype"title="">file!</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'as</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">name</span> <span class="word datatype"title="">file!</span> (<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> [<span class="lit-word">'file</span> <span class="word key"title="MOD a b">mod</span> <span class="lit-word">'as</span> <span class="word">name</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">keep</span> <span class="word">name</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">keep</span> <span class="word">prepare-module</span> <span class="word">load-module</span> <span class="word key"title="MOD a b">mod</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> [<span class="lit-word">'file</span> <span class="word key"title="MOD a b">mod</span> <span class="lit-word">'as</span> <span class="word key"title="MOD a b">mod</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">keep</span> <span class="word key"title="MOD a b">mod</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">keep</span> <span class="word">prepare-module</span> <span class="word">load-module</span> <span class="word key"title="MOD a b">mod</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SET word value /any /pad">set</span> <span class="word key"title="MOD a b">mod</span> <span class="word datatype"title="">url!</span> <span class="lit-word">'as</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">name</span> <span class="word datatype"title="">file!</span> (<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> [<span class="lit-word">'url</span> <span class="word key"title="MOD a b">mod</span> <span class="lit-word">'as</span> <span class="word">name</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">keep</span> <span class="word">name</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">keep</span> <span class="word">prepare-module</span> <span class="word">load-module</span> <span class="word key"title="MOD a b">mod</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SET word value /any /pad">set</span> <span class="word key"title="MOD a b">mod</span> <span class="word datatype"title="">word!</span> <span class="lit-word">'as</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">name</span> <span class="word datatype"title="">file!</span> (<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> [<span class="lit-word">'word</span> <span class="word key"title="MOD a b">mod</span> <span class="lit-word">'as</span> <span class="word">name</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="UNLESS condition block">unless</span> <span class="word">module?</span> <span class="path"><span class="word key"title="GET word /any">get</span>/<span class="word key"title="ANY block">any</span></span> <span class="word key"title="MOD a b">mod</span> [<span class="word">invalid-arg</span> <span class="word key"title="MOD a b">mod</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">keep</span> <span class="word">name</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">keep</span> <span class="word">prepare-module</span> <span class="word key"title="GET word /any">get</span> <span class="word key"title="MOD a b">mod</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">here:</span> <span class="word key"title="SKIP series offset">skip</span> (<span class="word">invalid-arg</span> <span class="word">here</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="set-word">prepare-module:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">module</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="MAKE type spec">make</span> <span class="word">module</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">callable:</span> <span class="word key"title="USE words body">use</span> <span class="word key"title="FIRST series">first</span> <span class="word">export-ctx</span> <span class="word key"title="REDUCE value /only words">reduce</span> [<span class="lit-word">'bind?</span> <span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">lit-word!</span> <span class="word key"title="FIRST series">first</span> <span class="word key"title="FIRST series">first</span> <span class="word">export-ctx</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="FOREACH 'word data body">foreach</span> <span class="word">word</span> <span class="word key"title="BIND words known-word /copy">bind</span> <span class="word key"title="FIRST series">first</span> <span class="word">callable</span> <span class="word">export-ctx</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="FUNCTION? value">function?</span> <span class="word key"title="GET word /any">get</span> <span class="word">word</span> [<span class="word key"title="SET word value /any /pad">set</span> <span class="word key"title="IN object word">in</span> <span class="word">callable</span> <span class="word">word</span> <span class="word">prepare-function</span> <span class="word key"title="GET word /any">get</span> <span class="word">word</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="set-word">prepare-function:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">f</span> <span class="refinement">/local</span> <span class="word">spec</span> <span class="word">types</span> <span class="word">ref?</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">function!</span> <span class="word">collect</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">spec:</span> <span class="word key"title="THIRD series">third</span> <span class="get-word">:f</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">ref?:</span> <span class="word">no</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="FOREACH 'word data body">foreach</span> <span class="word">word</span> <span class="word key"title="FIRST series">first</span> <span class="get-word">:f</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word">word</span> <span class="word key"title="= value1 value2">=</span> <span class="refinement">/local</span> [<span class="word key"title="BREAK /return value">break</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">keep</span> <span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">get-word!</span> <span class="word">word</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="REFINEMENT? value">refinement?</span> <span class="word">word</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word">keep</span>/<span class="word">only</span></span> [<span class="word datatype"title="">logic!</span> <span class="word datatype"title="">none!</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">ref?:</span> <span class="word">yes</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="BLOCK? value">block?</span> <span class="set-word">types:</span> <span class="word key"title="SELECT series value /part range /only /case /any /with wild /skip size">select</span> <span class="word">spec</span> <span class="word">word</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word">keep</span>/<span class="word">only</span></span> <span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word">ref?</span> [<span class="word key"title="JOIN value rest">join</span> <span class="word">types</span> <span class="word datatype"title="">none!</span>] [<span class="word">types</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="set-word">local:</span> <span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span> <span class="word key"title="FIRST series">first</span> <span class="get-word">:f</span> <span class="refinement">/local</span> [<span class="word">keep</span> <span class="word">local</span>]<br /><span class="tab">&nbsp;</span>] <span class="word key"title="SECOND series">second</span> <span class="get-word">:f</span><br />]<br /><span class="set-word">keep-module:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">name</span> <span class="word">module</span>] [<br /><span class="tab">&nbsp;</span><span class="word">keep</span> <span class="word">name</span><br /><span class="tab">&nbsp;</span><span class="path"><span class="word">keep</span>/<span class="word">only</span></span> <span class="path"><span class="word key"title="COMPOSE value /deep /only">compose</span>/<span class="word">only</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">Title:</span> (<span class="path"><span class="word">module</span>/<span class="word">title</span></span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">Author:</span> (<span class="word key"title="GET word /any">get</span> <span class="word key"title="IN object word">in</span> <span class="word">module</span> <span class="lit-word">'author</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">Version:</span> (<span class="word key"title="GET word /any">get</span> <span class="word key"title="IN object word">in</span> <span class="word">module</span> <span class="lit-word">'version</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">Purpose:</span> (<span class="path"><span class="word">module</span>/<span class="word">purpose</span></span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">Exports:</span> (<span class="path"><span class="word">module</span>/<span class="word">exports</span></span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">Globals:</span> (<span class="path"><span class="word">module</span>/<span class="word">globals</span></span>)<br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="set-word">handle-message:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span> [<span class="word datatype"title="">port!</span>] <span class="word">session</span> [<span class="word datatype"title="">object!</span>] <span class="word">message</span> [<span class="word datatype"title="">block!</span>] <span class="refinement">/local</span> <span class="word">module</span> <span class="word key"title="FUNCTION spec vars body">function</span> <span class="word">arguments</span> <span class="word key"title="MOD a b">mod</span> <span class="word">f</span> <span class="word">args</span> <span class="word">res</span>] [<br /><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'handling-message</span><br /><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"Handle message: state:"</span> <span class="path"><span class="word">session</span>/<span class="word">state</span></span> <span class="string">"message:"</span> <span class="path"><span class="word key"title="MOLD value /only /all /flat">mold</span>/<span class="word">only</span></span> <span class="word">message</span>]<br /><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="SWITCH value cases /default case">switch</span>/<span class="word">default</span></span> <span class="path"><span class="word">session</span>/<span class="word">state</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">data</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word">message</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'list</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">module</span> <span class="word datatype"title="">file!</span> (<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> [<span class="lit-word">'list</span> <span class="word">module</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">mod:</span> <span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="BLOCK? value">block?</span> <span class="path"><span class="word">configuration</span>/<span class="word">modules</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SELECT series value /part range /only /case /any /with wild /skip size">select</span> <span class="path"><span class="word">configuration</span>/<span class="word">modules</span></span> <span class="word">module</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word">configuration</span>/<span class="word">modules</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">send-message</span> <span class="word">port</span> <span class="word">session</span> <span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="MOD a b">mod</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">collect</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">keep</span> <span class="lit-word">'Module</span> <span class="word">keep</span> <span class="word">module</span> <span class="word">keep</span> <span class="lit-word">'Exports</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="FOREACH 'word data body">foreach</span> <span class="word">word</span> <span class="word key"title="BIND words known-word /copy">bind</span> <span class="word key"title="FIRST series">first</span> <span class="path"><span class="word key"title="MOD a b">mod</span>/<span class="word">export-ctx</span></span> <span class="path"><span class="word key"title="MOD a b">mod</span>/<span class="word">export-ctx</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="FUNCTION? value">function?</span> <span class="set-word">function:</span> <span class="word key"title="GET word /any">get</span> <span class="word">word</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">keep</span> <span class="word">word</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word">keep</span>/<span class="word">only</span></span> <span class="path"><span class="word key"title="COPY value /part range /deep">copy</span>/<span class="word">part</span></span> <span class="set-word">args:</span> <span class="word key"title="THIRD series">third</span> <span class="get-word">:function</span> <span class="word key"title="ANY block">any</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span> <span class="word">args</span> <span class="refinement">/local</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="TAIL series">tail</span> <span class="word">args</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<span class="word">Error</span> <span class="word">Unknown-Module</span> <span class="string">"I don't have that module here"</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'list</span> (<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> [<span class="lit-word">'list</span> <span class="lit-word">'modules</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">send-message</span> <span class="word">port</span> <span class="word">session</span> <span class="word">collect</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">keep</span> [<span class="word">Modules</span> <span class="word">List</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="BLOCK? value">block?</span> <span class="path"><span class="word">configuration</span>/<span class="word">modules</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="FOREACH 'word data body">foreach</span> [<span class="word">name</span> <span class="word">module</span>] <span class="path"><span class="word">configuration</span>/<span class="word">modules</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">keep-module</span> <span class="word">name</span> <span class="word">module</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">keep-module</span> <span class="word">none</span> <span class="path"><span class="word">configuration</span>/<span class="word">modules</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'call</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">module</span> <span class="word datatype"title="">file!</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word key"title="FUNCTION spec vars body">function</span> <span class="word datatype"title="">word!</span> <span class="set-word">arguments:</span> <span class="word key"title="TO type spec">to</span> <span class="word">end</span> (<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> [<span class="lit-word">'call</span> <span class="word">module</span> <span class="word key"title="FUNCTION spec vars body">function</span> <span class="path"><span class="word key"title="MOLD value /only /all /flat">mold</span>/<span class="word key"title="ALL block">all</span></span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">arguments</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">mod:</span> <span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="BLOCK? value">block?</span> <span class="path"><span class="word">configuration</span>/<span class="word">modules</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SELECT series value /part range /only /case /any /with wild /skip size">select</span> <span class="path"><span class="word">configuration</span>/<span class="word">modules</span></span> <span class="word">module</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word">configuration</span>/<span class="word">modules</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">send-message</span> <span class="word">port</span> <span class="word">session</span> <span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="MOD a b">mod</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'module-ok</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="set-word">f:</span> <span class="word key"title="IN object word">in</span> <span class="path"><span class="word key"title="MOD a b">mod</span>/<span class="word">callable</span></span> <span class="word key"title="FUNCTION spec vars body">function</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="FUNCTION? value">function?</span> <span class="set-word">f:</span> <span class="word key"title="GET word /any">get</span> <span class="word">f</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'function-ok</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">args:</span> <span class="word key"title="FIRST series">first</span> <span class="get-word">:f</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="EQUAL? value1 value2">equal?</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">arguments</span> <span class="integer">-1</span> <span class="word key"title="+ value1 value2">+</span> <span class="word key"title="INDEX? series /xy">index?</span> <span class="word key"title="ANY block">any</span> [<span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span> <span class="word">args</span> <span class="refinement">/local</span> <span class="word key"title="TAIL series">tail</span> <span class="word">args</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'arguments-ok</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="ERROR? value">error?</span> <span class="path"><span class="word key"title="SET word value /any /pad">set</span>/<span class="word key"title="ANY block">any</span></span> <span class="lit-word">'res</span> <span class="word key"title="TRY block">try</span> <span class="word key"title="APPEND series value /only">append</span> <span class="word key"title="REDUCE value /only words">reduce</span> [<span class="get-word">:f</span>] <span class="word">arguments</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'error-thrown</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">res:</span> <span class="word key"title="DISARM error">disarm</span> <span class="word">res</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="comment">; don't reveal</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">res/near:</span> <span class="word">none</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">res/where:</span> <span class="word">none</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="ALL block">all</span> [<span class="path"><span class="word">res</span>/<span class="word">type</span></span> <span class="word key"title="= value1 value2">=</span> <span class="lit-word">'script</span> <span class="path"><span class="word">res</span>/<span class="word">id</span></span> <span class="word key"title="= value1 value2">=</span> <span class="lit-word">'expect-arg</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">res/arg1:</span> <span class="word key"title="FUNCTION spec vars body">function</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">res/arg2:</span> <span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">word!</span> <span class="path"><span class="word">res</span>/<span class="word">arg2</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="REDUCE value /only words">reduce</span> [<span class="lit-word">'Error</span> <span class="lit-word">'REBOL-Error</span> <span class="word">res</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'call-ok</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="REDUCE value /only words">reduce</span> [<span class="lit-word">'Result</span> <span class="word">module</span> <span class="word key"title="FUNCTION spec vars body">function</span> <span class="path"><span class="word key"title="GET word /any">get</span>/<span class="word key"title="ANY block">any</span></span> <span class="lit-word">'res</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'invalid-arguments</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<span class="word">Error</span> <span class="word">Invalid-Arguments</span> <span class="string">"Invalid argument list for that function"</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'unknown-function</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<span class="word">Error</span> <span class="word">Unknown-Function</span> <span class="string">"The module does not export that function"</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'unknown-function</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<span class="word">Error</span> <span class="word">Unknown-Function</span> <span class="string">"The module does not export that function"</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'unknown-module</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<span class="word">Error</span> <span class="word">Unknown-Module</span> <span class="string">"I don't have that module here"</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'quit</span> (<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'quit</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="RETURN value">return</span> <span class="word">true</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'unknown-command</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'error</span> [<span class="string">"Unknown command:"</span> <span class="path"><span class="word key"title="COPY value /part range /deep">copy</span>/<span class="word">part</span></span> <span class="path"><span class="word key"title="MOLD value /only /all /flat">mold</span>/<span class="word">only</span></span> <span class="word">message</span> <span class="integer">30</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">send-message</span> <span class="word">port</span> <span class="word">session</span> [<span class="word">Error</span> <span class="word">Unknown-Command</span> <span class="string">"I don't know what you're talking about"</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'still-handshake</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">message:</span> <span class="word">handle-handshake-message</span> <span class="word">session</span> <span class="word">configuration</span> <span class="word">message</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="BLOCK? value">block?</span> <span class="word">message</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'sending-handshake-response</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">send-message</span> <span class="word">port</span> <span class="word">session</span> <span class="word">message</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word">false</span><br />]</p></div></div><div class="section"><h2 id="section-5">5. Hardball scheme handler functions</h2><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Hardball scheme handler functions<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">open:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span>] [<br /><span class="tab">&nbsp;</span><span class="word">setup-logging</span> <span class="path"><span class="word">client-config!</span>/<span class="word">logging</span></span><br /><span class="tab">&nbsp;</span><span class="set-path">port/sub-port:</span> <span class="word">open-hardball-connection</span> <span class="word key"title="MAKE type spec">make</span> <span class="word">client-config!</span> [ ] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">scheme:</span> <span class="lit-word">'tcp</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">host:</span> <span class="path"><span class="word">port</span>/<span class="word">host</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">port-id:</span> <span class="path"><span class="word">port</span>/<span class="word">port-id</span></span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="set-path">port/state/tail:</span> <span class="integer">1</span><br /><span class="tab">&nbsp;</span><span class="set-path">port/state/index:</span> <span class="integer">0</span><br /><span class="tab">&nbsp;</span><span class="set-path">port/state/flags:</span> <span class="path"><span class="word">port</span>/<span class="word">state</span>/<span class="word">flags</span></span> <span class="word key"title="OR value1 value2">or</span> <span class="word">port-flags</span><br />]<br /><span class="set-word">close:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span>] [<br /><span class="tab">&nbsp;</span><span class="word">close*</span> <span class="path"><span class="word">port</span>/<span class="word">sub-port</span></span><br />]<br /><span class="set-word">copy:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span> <span class="refinement">/local</span> <span class="word">module</span>] [<br /><span class="tab">&nbsp;</span><span class="word">generate-stub-module</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">list-exported-functions</span> <span class="path"><span class="word">port</span>/<span class="word">sub-port</span></span> <span class="set-word">module:</span> <span class="word key"title="APPEND series value /only">append</span> <span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">file!</span> <span class="word key"title="ANY block">any</span> [<span class="path"><span class="word">port</span>/<span class="word key"title="PATH value selector">path</span></span> <span class="string">""</span>] <span class="path"><span class="word">port</span>/<span class="word">target</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word">port</span>/<span class="word">host</span></span> <span class="path"><span class="word">port</span>/<span class="word">port-id</span></span> <span class="word">module</span><br />]</p></div></div><div class="section"><h2 id="section-6">6. Low level client-side functions</h2><p>This section contains the implementation of the lower lever client-side functions.</p><h3 id="section-6.1">6.1 Create a client configuration object</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Create a client configuration object<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">parse-config</span> <span class="word">client-config!</span> <span class="word">config</span></p></div><h3 id="section-6.2">6.2 Open TCP connection to <span class="code"><span class="word">server</span></span>, perform the handshake, and return the port</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Open TCP connection to <span class="code"><span class="word">server</span></span>, perform the handshake, and return the port<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">server:</span> <span class="path"><span class="word key"title="OPEN spec /binary /string /direct /seek /new /read /write /no-wait /lines /with end-of-line /allow access /mode args /custom params /skip length">open</span>/<span class="word">binary</span>/<span class="word">no-wait</span></span> <span class="word">server</span><br /><span class="word">with</span> <span class="set-path">server/locals:</span> <span class="word key"title="CONTEXT blk">context</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">buffer:</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="binary">#{}</span><br /><span class="tab">&nbsp;</span><span class="set-word">session:</span> <span class="word">make-messages-session</span><br /><span class="tab">&nbsp;</span><span class="comment">; TODO: fix this</span><br /><span class="tab">&nbsp;</span><span class="set-path">session/role:</span> <span class="lit-word">'client</span><br /><span class="tab">&nbsp;</span><span class="set-path">session/max-block-length:</span> <span class="integer">1024</span> <span class="word key"title="* value1 value2">*</span> <span class="integer">1024</span><br /><span class="tab">&nbsp;</span><span class="set-word">configuration:</span> <span class="word">config</span><br />] [<br /><span class="tab">&nbsp;</span><span class="word">greet-messages-peer</span> <span class="word">server</span> <span class="word">session</span> <span class="word">configuration</span><br /><span class="tab">&nbsp;</span><span class="word key"title="FOREVER body">forever</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="WAIT value /all">wait</span> <span class="word">server</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="UNLESS condition block">unless</span> <span class="set-word">data:</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">server</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">throw-error</span> [<span class="lit-word">'Unexpected-Close</span> <span class="string">"during handshake"</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="APPEND series value /only">append</span> <span class="word">buffer</span> <span class="word">data</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="WHILE cond-block body-block">while</span> [<span class="set-word">message:</span> <span class="word">receive-message</span> <span class="word">buffer</span> <span class="word">session</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">message:</span> <span class="word">handle-handshake-message</span> <span class="word">session</span> <span class="word">configuration</span> <span class="word">message</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word">message</span> <span class="word key"title="= value1 value2">=</span> <span class="word">true</span> [<span class="word key"title="BREAK /return value">break</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="BLOCK? value">block?</span> <span class="word">message</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">send-message</span> <span class="word">server</span> <span class="word">session</span> <span class="word">message</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word">message</span> <span class="word key"title="= value1 value2">=</span> <span class="word">true</span> [<span class="word key"title="BREAK /return value">break</span>]<br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="word">server</span></p></div><h4 id="section-6.2.1">6.2.1 <span class="code"><span class="word">open-hardball-connection</span></span>'s locals</h4><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">open-hardball-connection</span></span>'s locals<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">data</span> <span class="word">message</span></p></div><h3 id="section-6.3">6.3 List the modules exported by the server</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>List the modules exported by the server<span class="bra">&#9002;</span> &#8801;</p><p><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word">send-and-receive</span> <span class="word">server</span> [<span class="word">List</span>] [<br /><span class="tab">&nbsp;</span><span class="lit-word">'Modules</span> <span class="lit-word">'List</span> <span class="set-word">list:</span> (<span class="word key"title="RETURN value">return</span> <span class="word">list</span>)<br /><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="set-word">list:</span> (<span class="word">throw-error</span> [<span class="lit-word">'Unexpected-Response</span> <span class="word">list</span>])<br />]</p></div><h4 id="section-6.3.1">6.3.1 <span class="code"><span class="word">list-exported-modules</span></span>'s locals</h4><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">list-exported-modules</span></span>'s locals<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">list</span></p></div><h3 id="section-6.4">6.4 List the functions exported by <span class="code"><span class="word">module</span></span> on <span class="code"><span class="word">server</span></span></h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>List the functions exported by <span class="code"><span class="word">module</span></span> on <span class="code"><span class="word">server</span></span><span class="bra">&#9002;</span> &#8801;</p><p><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word">send-and-receive</span> <span class="word">server</span> <span class="word key"title="REDUCE value /only words">reduce</span> [<span class="lit-word">'List</span> <span class="word">module</span>] [<br /><span class="tab">&nbsp;</span><span class="lit-word">'Module</span> <span class="word">module</span> <span class="lit-word">'Exports</span> <span class="set-word">list:</span> (<span class="word key"title="RETURN value">return</span> <span class="word">list</span>)<br /><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="set-word">list:</span> (<span class="word">throw-error</span> [<span class="lit-word">'Unexpected-Response</span> <span class="word">list</span>])<br />]</p></div><h4 id="section-6.4.1">6.4.1 <span class="code"><span class="word">list-exported-functions</span></span>'s locals</h4><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">list-exported-functions</span></span>'s locals<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">list</span></p></div><h3 id="section-6.5">6.5 Call the function specified by <span class="code"><span class="word">block</span></span> in <span class="code"><span class="word">module</span></span> on <span class="code"><span class="word">server</span></span> and return its result</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Call the function specified by <span class="code"><span class="word">block</span></span> in <span class="code"><span class="word">module</span></span> on <span class="code"><span class="word">server</span></span> and return its result<span class="bra">&#9002;</span> &#8801;</p><p><span class="word key"title="UNLESS condition block">unless</span> <span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word">block</span> [<span class="word datatype"title="">word!</span> <span class="word key"title="TO type spec">to</span> <span class="word">end</span>] [<br /><span class="tab">&nbsp;</span><span class="word">invalid-arg</span> <span class="word">block</span><br />]<br /><span class="set-word">function:</span> <span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">lit-word!</span> <span class="path"><span class="word">block</span>/<span class="integer">1</span></span><br /><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word">send-and-receive</span> <span class="word">server</span> <span class="word key"title="COMPOSE value /deep /only">compose</span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="CALL cmd /input in /output out /error err /wait /console /shell /info">Call</span> (<span class="word">module</span>) (<span class="path"><span class="word">block</span>/<span class="integer">1</span></span>) (<span class="word key"title="REDUCE value /only words">reduce</span> <span class="word key"title="NEXT series">next</span> <span class="word">block</span>)<br />] [<br /><span class="tab">&nbsp;</span><span class="lit-word">'Result</span> <span class="word">module</span> <span class="word key"title="FUNCTION spec vars body">function</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">result</span> <span class="word key"title="SKIP series offset">skip</span><br /><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="lit-word">'Error</span> <span class="lit-word">'REBOL-Error</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">result</span> <span class="word datatype"title="">object!</span> (<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="THROW value /name word">throw</span> <span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">error!</span> <span class="word key"title="NEXT series">next</span> <span class="word key"title="NEXT series">next</span> <span class="word key"title="SECOND series">second</span> <span class="word">result</span><br /><span class="tab">&nbsp;</span>)<br /><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="lit-word">'Error</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">result</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'Invalid-Arguments</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'Unknown-Function</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'Unknown-Module</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'Unknown-Command</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word datatype"title="">string!</span><br /><span class="tab">&nbsp;</span>] (<span class="word">throw-error</span> [<span class="path"><span class="word">result</span>/<span class="integer">1</span></span> <span class="path"><span class="word">result</span>/<span class="integer">2</span></span>])<br /><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="set-word">result:</span> (<span class="word">throw-error</span> [<span class="lit-word">'Unexpected-Response</span> <span class="word">result</span>])<br />]<br /><span class="path"><span class="word key"title="GET word /any">get</span>/<span class="word key"title="ANY block">any</span></span> <span class="lit-word">'result</span></p></div><h4 id="section-6.5.1">6.5.1 <span class="code"><span class="word">call-remote-function</span></span>'s locals</h4><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">call-remote-function</span></span>'s locals<span class="bra">&#9002;</span> &#8801;</p><p><span class="word key"title="FUNCTION spec vars body">function</span> <span class="word">result</span></p></div><h3 id="section-6.6">6.6 Client-side support functions</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Client-side support functions<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">client-config!:</span> <span class="word key"title="MAKE type spec">make</span> <span class="word">config!</span> [<br /><span class="tab">&nbsp;</span><span class="comment">; no logging by default</span><br /><span class="tab">&nbsp;</span><span class="set-word">logging:</span> [<span class="word">only</span> [<span class="word">print-at-all-costs</span>] <span class="word key"title="TO type spec">to</span> <span class="word">output</span>]<br />]<br /><span class="set-word">send-and-receive:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span> <span class="word">message</span> <span class="refinement">/local</span> <span class="word">data</span>] [<br /><span class="tab">&nbsp;</span><span class="word">with</span> <span class="path"><span class="word">port</span>/<span class="word">locals</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">send-message</span> <span class="word">port</span> <span class="word">session</span> <span class="word">message</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="FOREVER body">forever</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="WAIT value /all">wait</span> <span class="word">port</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="UNLESS condition block">unless</span> <span class="set-word">data:</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">port</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">throw-error</span> [<span class="lit-word">'Unexpected-Close</span> <span class="string">"(expecting response)"</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="APPEND series value /only">append</span> <span class="word">buffer</span> <span class="word">data</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="set-word">message:</span> <span class="word">receive-message</span> <span class="word">buffer</span> <span class="word">session</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="RETURN value">return</span> <span class="word">message</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="set-word">close*:</span> <span class="get-word">:close</span><br /><span class="set-word">generate-stub-module:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">function-list</span> <span class="word">server-host</span> <span class="word">server-port-id</span> <span class="word">module-name</span> <span class="refinement">/local</span> <span class="word">arg-name</span>] [<br /><span class="tab">&nbsp;</span><span class="word">collect</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">keep</span> <span class="lit-word">'REBOL</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word">keep</span>/<span class="word">only</span></span> <span class="path"><span class="word key"title="COMPOSE value /deep /only">compose</span>/<span class="word">only</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">Type:</span> <span class="word">Module</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">Imports:</span> [<span class="file">%schemes/hardball.r</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">Exports:</span> (<span class="word key"title="EXTRACT block width /index pos">extract</span> <span class="word">function-list</span> <span class="integer">2</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">keep</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">_config:</span> <span class="word">make-hardball-configuration</span> [ ]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">_port:</span> <span class="word">open-hardball-connection</span> <span class="word">_config</span> <span class="set-word">_server-url:</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">keep</span> <span class="word key"title="JOIN value rest">join</span> <span class="url">tcp://</span> [<span class="word">server-host</span> <span class="char">#":"</span> <span class="word">server-port-id</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="FOREACH 'word data body">foreach</span> [<span class="word">name</span> <span class="word">spec</span>] <span class="word">function-list</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">keep</span> <span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">set-word!</span> <span class="word">name</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">keep</span> <span class="lit-word">'func</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word">keep</span>/<span class="word">only</span></span> <span class="word">spec</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word">keep</span>/<span class="word">only</span></span> <span class="path"><span class="word key"title="COMPOSE value /deep /only">compose</span>/<span class="word">only</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="comment">; if we lost connection, try connecting again</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="UNLESS condition block">unless</span> <span class="word key"title="ATTEMPT value">attempt</span> [<span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">_port</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="ATTEMPT value">attempt</span> [<span class="word key"title="CLOSE port">close</span> <span class="word">_port</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">_port:</span> <span class="word">open-hardball-connection</span> <span class="word">_config</span> <span class="word">_server-url</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">call-remote-function</span> <span class="word">_port</span> (<span class="word">module-name</span>) (<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">collect</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">keep</span> <span class="word">name</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word">spec</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="ANY block">any</span> [<span class="word datatype"title="">string!</span> <span class="word">|</span> <span class="word datatype"title="">block!</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">some</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SET word value /any /pad">set</span> <span class="word">arg-name</span> [<span class="word datatype"title="">word!</span> <span class="word">|</span> <span class="word datatype"title="">refinement!</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="ANY block">any</span> [<span class="word datatype"title="">string!</span> <span class="word">|</span> <span class="word datatype"title="">block!</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<span class="word">keep</span> <span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">get-word!</span> <span class="word">arg-name</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br />]</p></div></div><div class="section"><h2 id="section-7">7. Functions common to server and client</h2><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Functions common to server and client<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">config!:</span> <span class="word key"title="CONTEXT blk">context</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">public-key:</span> <span class="word">none</span><br /><span class="tab">&nbsp;</span><span class="set-word">private-key:</span> <span class="word">none</span><br /><span class="tab">&nbsp;</span><span class="set-word">allowed-peers:</span> [ ]<br />]<br /><span class="set-word">invalid-arg:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">val</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="THROW value /name word">throw</span> <span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">error!</span> <span class="word key"title="REDUCE value /only words">reduce</span> [<span class="lit-word">'script</span> <span class="lit-word">'invalid-arg</span> <span class="get-word">:val</span>]<br />]<br /><span class="set-word">with:</span> <span class="word key"title="FUNC spec body">func</span> [[<span class="word key"title="THROW value /name word">throw</span>] <span class="word">object</span> <span class="word">code</span>] [<span class="word key"title="DO value /args arg /next">do</span> <span class="word key"title="BIND words known-word /copy">bind</span> <span class="word">code</span> <span class="word">object</span>]<br /><span class="set-word">parse-config:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">template</span> <span class="word">config</span> <span class="refinement">/local</span> <span class="word">cfg</span> <span class="word">word</span>] [<br /><span class="tab">&nbsp;</span><span class="set-word">cfg:</span> <span class="word key"title="MAKE type spec">make</span> <span class="word">template</span> [ ]<br /><span class="tab">&nbsp;</span><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word">config</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="ANY block">any</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SET word value /any /pad">set</span> <span class="word">word</span> <span class="word datatype"title="">set-word!</span> <span class="word">do-next</span> (<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="UNLESS condition block">unless</span> <span class="set-word">word:</span> <span class="word key"title="IN object word">in</span> <span class="word">cfg</span> <span class="word">word</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">invalid-arg</span> <span class="word">word</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SET word value /any /pad">set</span> <span class="word">word</span> <span class="word">pop-result</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> [<span class="lit-word">'config</span> <span class="word">word</span> <span class="path"><span class="word key"title="MOLD value /only /all /flat">mold</span>/<span class="word key"title="ALL block">all</span></span> <span class="word key"title="GET word /any">get</span> <span class="word">word</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<span class="word">end</span> <span class="word">|</span> <span class="set-word">here:</span> (<span class="word">invalid-arg</span> <span class="word">here</span>)]<br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word">cfg</span><br />]<br /><span class="comment">; errors</span><br /><span class="set-word">throw-error:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">args</span> [<span class="word datatype"title="">block!</span> <span class="word datatype"title="">word!</span>]] [<br /><span class="tab">&nbsp;</span><span class="word key"title="THROW value /name word">throw</span> <span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">error!</span> <span class="word key"title="JOIN value rest">join</span> [<span class="word">Hardball</span>] <span class="word">args</span><br />]<br /><span class="set-path">system/error/hardball:</span> <span class="word key"title="MAKE type spec">make</span> <span class="path"><span class="word">system</span>/<span class="word">error</span>/<span class="word">hardball</span></span> [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-7.1">List of error values</a><span class="bra">&#9002;</span></span><br />]</p></div><h3 id="section-7.1">7.1 List of error values</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>List of error values<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">Unexpected-Close:</span> [<span class="string">"Connection unexpectedly closed"</span> <span class="get-word">:arg1</span>]<br /><span class="set-word">Unexpected-Response:</span> [<span class="string">"Unexpected response from peer:"</span> <span class="path"><span class="word key"title="COPY value /part range /deep">copy</span>/<span class="word">part</span></span> <span class="path"><span class="word key"title="MOLD value /only /all /flat">mold</span>/<span class="word">only</span></span> <span class="get-word">:arg1</span> <span class="integer">15</span>]<br /><span class="set-word">Invalid-Arguments:</span> <span class="set-word">Unknown-Function:</span> <span class="set-word">Unknown-Module:</span> <span class="set-word">Unknown-Command:</span> [<span class="string">"Peer says:"</span> <span class="get-word">:arg1</span>]</p></div></div>
    <div id="footer"><p><a href="http://www.rebol.com/">MakeDoc3 by REBOL</a> - 2-Sep-2018</p></div>
</body>
</html>
