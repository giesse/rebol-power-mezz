<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta name="generator" content="REBOL" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

  <title>Chain port scheme for REBOL</title>

<style type="text/css">
/*<![CDATA[*/
html, body, p, li {font-family: Georgia, Times New Roman, serif; text-align: justify;}
.code, .code p {font-family: Trebuchet MS, Arial, Helvetica, sans-serif;}
.code .string, .code .tag, .code .issue {font-family: Lucida Console, Courier New, Courier, fixed;}
.code .word, .code .set-word, .code .lit-word, .code .get-word, .code .refinement {font-style: italic;}
.code .key {font-style: normal; font-weight: bold;}
.code .function {font-weight: bold; font-style: normal;}
.code .ref a {text-decoration: none; color: black;}
.code .ref a:hover {text-decoration: underline; color: blue;}
.code .issue, .code .tag, .code .datatype {color: green;}
.code .datatype {font-style: normal;}
.code .url, .code .file, .code .refinement, .code .lit-word {color: brown;}
.code .integer, .code .decimal, .code .tuple, .code .pair {color: blue;}
.code .comment {color: gray;}
div.code {margin-left: 95pt;}
div.code p.sectdef {font-style: normal; margin: 0 0 0 -30pt;}
div.code p {margin: 0;}
div.code span.tab {padding-left: .75cm; border-left: dotted thin #CCCCCC;}
div.code span.directive {background-color: #F0FFF0; border: dotted thin black;}
#header {margin: 34pt 140pt 140pt 140pt; padding: 0;}
#title {text-align: center; margin: 0 0 34pt 0;}
#author {text-align: center; margin: 13pt 0 0 0; font-size: 13pt;}
#dateversion {text-align: center; margin: 0 0 24pt 0; font-size: 12pt;}
#purpose {text-align: justify; font-style: italic;}
#license {font-size: 7pt; color: gray; margin: 2pt 10pt 2pt 10pt; width: 200pt; float: right; white-space: pre;}
#history {width: 60%; font-size: 10pt; margin-left: auto; margin-right: auto;}
#history thead tr {background-color: #E0E0E0;}
#history td.date {text-align: right;}
#history td.version {text-align: center;}
#history td.desc {width: 100%; text-align: justify;}
#history td.name {text-align: left;}
#toc {margin: 70pt;}
#toc li {list-style: none;}
.section {margin: 70pt 70pt 70pt 100pt;}
.section h2, .section h3 {margin-left: -30pt;}
pre {font-family: Lucida Console; overflow: scroll;}
.center {margin-left: auto; margin-right: auto; text-align: center;}
span.bra {font-family: Arial Unicode MS;}
div.note {margin: 3pt; margin-bottom: 14pt; padding: 0 12pt 6pt 12pt; background-color: #E0E0E0;}
div.note h2 {
    margin: 0 -12pt 12pt -12pt;
    padding: 5pt;
    text-align: center;
    background-color: #606060;
    color: white;
    font-size: 14pt;
}
div.image {text-align: center;}
div.image img {padding: 10px; border: dashed thin black;}
/*]]>*/
</style>
</head>

<body>
    <div id="header"><h1 id="title">Chain port scheme for REBOL</h1><h2 id="author">Gabriele Santilli</h2><h2 id="dateversion">1.0.0</h2><p id="purpose">
        Implements chain://, a port scheme that allows chaining other (filter) ports together
        so that they are seen as a single port.
    </p><div id="license">
        =================================
        A message from Qtask about this source code:

        We have selected the MIT license (as of 2010-Jan-1) because
        it is the closest “standard” license to our intent.  If we had our way,
        we would declare this source as public domain, with absolutely no
        strings attached, not even the string that says you have to have
        strings.  We want to help people, so please feel free to contact us
        at API@Qtask.com if you have questions.
         

        (you only need to include the standard license text below in your
        homage to this source code)
        =================================

        Copyright 2008 Qtask, Inc.

        Permission is hereby granted, free of charge, to any person obtaining
        a copy of this software and associated documentation files
        (the "Software"), to deal in the Software without restriction, including
        without limitation the rights to use, copy, modify, merge, publish,
        distribute, sublicense, and/or sell copies of the Software, and to
        permit persons to whom the Software is furnished to do so, subject
        to the following conditions:

        The above copyright notice and this permission notice shall be included
        in all copies or substantial portions of the Software.

        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
        OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
        FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
        THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
        OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
        ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
        OTHER DEALINGS IN THE SOFTWARE.
    </div></div><div id="toc"><h2>Contents:</h2><ul><li><a href="#section-1">1. Introduction</a></li><li><a href="#section-2">2. Overview</a></li><li><a href="#section-3">3. Usage examples</a></li><li><a href="#section-4">4. Implementation</a></li><ul><li><a href="#section-4.1">4.1 Initialize the chain port <span class="code"><span class="word">port</span></span> from <span class="code"><span class="word">spec</span></span></a></li><li><a href="#section-4.2">4.2 Open the chain port <span class="code"><span class="word">port</span></span></a></li><li><a href="#section-4.3">4.3 Close the chain port <span class="code"><span class="word">port</span></span> (do nothing)</a></li><li><a href="#section-4.4">4.4 Stream <span class="code"><span class="word">data</span></span> through the list of ports</a></li><li><a href="#section-4.5">4.5 Read from the last port in the list</a></li><li><a href="#section-4.6">4.6 Update all the ports in the list</a></li><li><a href="#section-4.7">4.7 Support functions</a></li></ul></ul></div><div class="section"><h2 id="section-1">1. Introduction</h2><p>This port scheme allows creating a "filter" port that is the combination of other
"filter" ports. Data inserted to the chain port will be passed through all the ports
in the chain in the order they are specified. This way you can do things like combine
encryption with enbasing, or debasing and decryption, and have it work as a single port.</p><p>This port scheme is the ideal complement to the <span class="code"><span class="word">pipe</span></span> function, because with it you
can filter your data using a combination of different ports.</p></div><div class="section"><h2 id="section-2">2. Overview</h2><p>We define the <span class="code"><span class="url">chain://</span></span> scheme in the usual way; although this is not really a network protocol,
REBOL does not like it if we don't use <span class="code"><span class="word">net-install</span></span>. The specified port id does not matter (any
random number will do).</p><p>Since we're writing a non pass-thru port, we only have to define <span class="code"><span class="word key"title="READ source /binary /string /direct /no-wait /lines /part size /with end-of-line /mode args /custom params /skip length">read</span></span> and <span class="code"><span class="word key"title="WRITE destination value /binary /string /direct /append /no-wait /lines /part size /with end-of-line /allow access /mode args /custom params">write</span></span>, and REBOL
will map <span class="code"><span class="word key"title="INSERT series value /part range /only /dup count">insert</span></span>, <span class="code"><span class="word key"title="COPY value /part range /deep">copy</span></span>, <span class="code"><span class="word key"title="PICK series index">pick</span></span> etc. to them internally; REBOL will also do any line termination
conversion, however we recommend only using <span class="code"><span class="refinement">/binary</span></span> ports for filtering. This scheme has not
been tested without <span class="code"><span class="refinement">/binary</span></span>.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Overview<span class="bra">&#9002;</span> &#8801;</p><p><span class="path"><span class="word">net-utils</span>/<span class="word">net-install</span></span> <span class="lit-word">'chain</span> <span class="word key"title="MAKE type spec">make</span> <span class="word">Root-Protocol</span> [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.7">Support functions</a><span class="bra">&#9002;</span></span><br /><span class="tab">&nbsp;</span><br /><span class="tab">&nbsp;</span><span class="set-word">init:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span> <span class="word">spec</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.1">Initialize the chain port <span class="code"><span class="word">port</span></span> from <span class="code"><span class="word">spec</span></span></a><span class="bra">&#9002;</span></span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="set-word">open:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.2">Open the chain port <span class="code"><span class="word">port</span></span></a><span class="bra">&#9002;</span></span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="set-word">close:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.3">Close the chain port <span class="code"><span class="word">port</span></span> (do nothing)</a><span class="bra">&#9002;</span></span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="set-word">write:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span> <span class="word">data</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.4">Stream <span class="code"><span class="word">data</span></span> through the list of ports</a><span class="bra">&#9002;</span></span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="set-word">read:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span> <span class="word">data</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.5">Read from the last port in the list</a><span class="bra">&#9002;</span></span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="set-word">update:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.6">Update all the ports in the list</a><span class="bra">&#9002;</span></span><br /><span class="tab">&nbsp;</span>]<br />] <span class="integer">80</span></p></div></div><div class="section"><h2 id="section-3">3. Usage examples</h2><p>The following example will create a port that is the combination of <span class="code"><span class="word">port1</span></span>, <span class="code"><span class="word">port2</span></span> and <span class="code"><span class="word">port3</span></span>. Data
is filtered through <span class="code"><span class="word">port1</span></span>, then <span class="code"><span class="word">port2</span></span> and finally through <span class="code"><span class="word">port3</span></span>.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Usage examples<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">chain:</span> <span class="path"><span class="word key"title="OPEN spec /binary /string /direct /seek /new /read /write /no-wait /lines /with end-of-line /allow access /mode args /custom params /skip length">open</span>/<span class="word">binary</span></span> [<span class="set-word">scheme:</span> <span class="lit-word">'chain</span> <span class="set-word">sub-port:</span> [<span class="word">port1</span> <span class="word">port2</span> <span class="word">port3</span>]]</p></div><p>For example, if <span class="code"><span class="word">port1</span></span> did compression, <span class="code"><span class="word">port2</span></span> encryption and <span class="code"><span class="word">port3</span></span> enbasing, your data stream
would be compressed, then encrypted and finally enbased. This is equivalend to do the three operations
in sequence - you read the file, compress it, encrypt it, then enbase it - except that this way you do
it incrementally without having to read the file into memory. If you're using the <span class="code"><span class="word">pipe</span></span> function,
you would just use:</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Usage examples<span class="bra">&#9002;</span> +&#8801;</p><p><span class="path"><span class="word">pipe</span>/<span class="word">thru</span></span> <span class="file">%source-file</span> <span class="file">%dest-file</span> <span class="word">chain</span></p></div><p>to get <span class="code"><span class="file">%source-file</span></span> processed and stored into <span class="code"><span class="file">%dest-file</span></span>.</p></div><div class="section"><h2 id="section-4">4. Implementation</h2><p>The implementation of the port scheme is relatively trivial.</p><h3 id="section-4.1">4.1 Initialize the chain port <span class="code"><span class="word">port</span></span> from <span class="code"><span class="word">spec</span></span></h3><p>The <span class="code"><span class="word">init</span></span> function is used to initialize the port (called when you <span class="code"><span class="word key"title="MAKE type spec">make</span></span> it). The user will
need to pass a block of ports in the <span class="code"><span class="word">sub-port</span></span> field. (See <span class="code"><span class="ref"><span class="bra">&#9001;</span><a href="#section-3">Usage examples</a><span class="bra">&#9002;</span></span></span>.)</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Initialize the chain port <span class="code"><span class="word">port</span></span> from <span class="code"><span class="word">spec</span></span><span class="bra">&#9002;</span> &#8801;</p><p><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="URL? value">url?</span> <span class="word">spec</span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="NET-ERROR info">net-error</span> <span class="string">"Cannot make a chain port from url!"</span><br />]<br /><span class="set-path">port/url:</span> <span class="word">spec</span><br /><span class="word key"title="UNLESS condition block">unless</span> <span class="word key"title="ALL block">all</span> [<span class="word key"title="BLOCK? value">block?</span> <span class="path"><span class="word">port</span>/<span class="word">sub-port</span></span> <span class="integer">1</span> <span class="word key"title="&lt; value1 value2">&lt;</span> <span class="word key"title="LENGTH? series">length?</span> <span class="path"><span class="word">port</span>/<span class="word">sub-port</span></span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="NET-ERROR info">net-error</span> <span class="string">{You must specify a list of ports to stream the data through}</span><br />]</p></div><h3 id="section-4.2">4.2 Open the chain port <span class="code"><span class="word">port</span></span></h3><p>The <span class="code"><span class="word key"title="OPEN spec /binary /string /direct /seek /new /read /write /no-wait /lines /with end-of-line /allow access /mode args /custom params /skip length">open</span></span> function does not have much to do; we just force the <span class="code"><span class="refinement">/direct</span></span> mode, since
we are a "filter" kind of port.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Open the chain port <span class="code"><span class="word">port</span></span><span class="bra">&#9002;</span> &#8801;</p><p><span class="set-path">port/state/flags:</span> <span class="path"><span class="word">port</span>/<span class="word">state</span>/<span class="word">flags</span></span> <span class="word key"title="OR value1 value2">or</span> <span class="path"><span class="word">system</span>/<span class="word">standard</span>/<span class="word">port-flags</span>/<span class="word">direct</span></span></p></div><h3 id="section-4.3">4.3 Close the chain port <span class="code"><span class="word">port</span></span> (do nothing)</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Close the chain port <span class="code"><span class="word">port</span></span> (do nothing)<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">port</span></p></div><h3 id="section-4.4">4.4 Stream <span class="code"><span class="word">data</span></span> through the list of ports</h3><p>See <span class="code"><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.7">Support functions</a><span class="bra">&#9002;</span></span></span> for <span class="code"><span class="word">propagate-data</span></span>. <span class="code"><span class="path"><span class="word">port</span>/<span class="word">state</span>/<span class="word">num</span></span></span> holds the number of bytes to write
from the <span class="code"><span class="word">data</span></span> buffer. We return the number of bytes actually written.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Stream <span class="code"><span class="word">data</span></span> through the list of ports<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">propagate-data</span> <span class="path"><span class="word">port</span>/<span class="word">sub-port</span></span> <span class="path"><span class="word key"title="COPY value /part range /deep">copy</span>/<span class="word">part</span></span> <span class="word">data</span> <span class="path"><span class="word">port</span>/<span class="word">state</span>/<span class="word">num</span></span><br /><span class="path"><span class="word">port</span>/<span class="word">state</span>/<span class="word">num</span></span></p></div><h3 id="section-4.5">4.5 Read from the last port in the list</h3><p>Since we do all the filtering on write, when reading we just call <span class="code"><span class="word key"title="READ-IO port buffer length">read-io</span></span> on the last port in
the chain.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Read from the last port in the list<span class="bra">&#9002;</span> &#8801;</p><p><span class="word key"title="READ-IO port buffer length">read-io</span> <span class="word key"title="LAST series">last</span> <span class="path"><span class="word">port</span>/<span class="word">sub-port</span></span> <span class="word">data</span> <span class="path"><span class="word">port</span>/<span class="word">state</span>/<span class="word">num</span></span></p></div><h3 id="section-4.6">4.6 Update all the ports in the list</h3><p>See <span class="code"><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.7">Support functions</a><span class="bra">&#9002;</span></span></span> for <span class="code"><span class="word">update-all</span></span>.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Update all the ports in the list<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">update-all</span> <span class="path"><span class="word">port</span>/<span class="word">sub-port</span></span></p></div><h3 id="section-4.7">4.7 Support functions</h3><p>The <span class="code"><span class="word">propagate-data</span></span> is used to pass the data being written through all the ports in the list.
We have to do this in a "strange" way in order to avoid calling <span class="code"><span class="word key"title="COPY value /part range /deep">copy</span></span> on the ports before
<span class="code"><span class="word key"title="UPDATE port">update</span></span> when we are at the last chunk of data. So, we first copy any data that's available from
the first port and insert it to the second, then we copy from the second port and insert to the
third and so on; at the end, we insert the data being written into the first port. This way <span class="code"><span class="word">data</span></span>
has only been inserted into the first port and there is still the chance for the user to issue an
update to signal that it is the last chunk of data.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Support functions<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">propagate-data:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">ports</span> <span class="word">data</span> <span class="refinement">/local</span> <span class="word">filtered</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="WHILE cond-block body-block">while</span> [<span class="word key"title="NOT value">not</span> <span class="word key"title="TAIL? series">tail?</span> <span class="word key"title="NEXT series">next</span> <span class="word">ports</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="set-word">filtered:</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">ports</span>/<span class="integer">1</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">ports</span>/<span class="integer">2</span></span> <span class="word">filtered</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">ports:</span> <span class="word key"title="NEXT series">next</span> <span class="word">ports</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="set-word">ports:</span> <span class="word key"title="HEAD series">head</span> <span class="word">ports</span><br /><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">ports</span>/<span class="integer">1</span></span> <span class="word">data</span><br />]</p></div><p>The <span class="code"><span class="word">update-all</span></span> function updates all the ports in the list. We basically call <span class="code"><span class="word key"title="UPDATE port">update</span></span> on the
first port, then <span class="code"><span class="word key"title="COPY value /part range /deep">copy</span></span> from it and if new data is available we insert that into the second port;
then we call <span class="code"><span class="word key"title="UPDATE port">update</span></span> on the second port and insert into the third, and so on. At the end we call
<span class="code"><span class="word key"title="UPDATE port">update</span></span> on the last port.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Support functions<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">update-all:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">ports</span> <span class="refinement">/local</span> <span class="word">data</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="WHILE cond-block body-block">while</span> [<span class="word key"title="NOT value">not</span> <span class="word key"title="TAIL? series">tail?</span> <span class="word key"title="NEXT series">next</span> <span class="word">ports</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word">system</span>/<span class="word">words</span>/<span class="word key"title="UPDATE port">update</span></span> <span class="path"><span class="word">ports</span>/<span class="integer">1</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="set-word">data:</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">ports</span>/<span class="integer">1</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">ports</span>/<span class="integer">2</span></span> <span class="word">data</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">ports:</span> <span class="word key"title="NEXT series">next</span> <span class="word">ports</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="path"><span class="word">system</span>/<span class="word">words</span>/<span class="word key"title="UPDATE port">update</span></span> <span class="path"><span class="word">ports</span>/<span class="integer">1</span></span><br />]</p></div></div>
    <div id="footer"><p><a href="http://www.rebol.com/">MakeDoc3 by REBOL</a> - 2-Sep-2018</p></div>
</body>
</html>
