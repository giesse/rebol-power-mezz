<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta name="generator" content="REBOL" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

  <title>imapcommands:// protocol handler</title>

<style type="text/css">
/*<![CDATA[*/
html, body, p, li {font-family: Georgia, Times New Roman, serif; text-align: justify;}
.code, .code p {font-family: Trebuchet MS, Arial, Helvetica, sans-serif;}
.code .string, .code .tag, .code .issue {font-family: Lucida Console, Courier New, Courier, fixed;}
.code .word, .code .set-word, .code .lit-word, .code .get-word, .code .refinement {font-style: italic;}
.code .key {font-style: normal; font-weight: bold;}
.code .function {font-weight: bold; font-style: normal;}
.code .ref a {text-decoration: none; color: black;}
.code .ref a:hover {text-decoration: underline; color: blue;}
.code .issue, .code .tag, .code .datatype {color: green;}
.code .datatype {font-style: normal;}
.code .url, .code .file, .code .refinement, .code .lit-word {color: brown;}
.code .integer, .code .decimal, .code .tuple, .code .pair {color: blue;}
.code .comment {color: gray;}
div.code {margin-left: 95pt;}
div.code p.sectdef {font-style: normal; margin: 0 0 0 -30pt;}
div.code p {margin: 0;}
div.code span.tab {padding-left: .75cm; border-left: dotted thin #CCCCCC;}
div.code span.directive {background-color: #F0FFF0; border: dotted thin black;}
#header {margin: 34pt 140pt 140pt 140pt; padding: 0;}
#title {text-align: center; margin: 0 0 34pt 0;}
#author {text-align: center; margin: 13pt 0 0 0; font-size: 13pt;}
#dateversion {text-align: center; margin: 0 0 24pt 0; font-size: 12pt;}
#purpose {text-align: justify; font-style: italic;}
#license {font-size: 7pt; color: gray; margin: 2pt 10pt 2pt 10pt; width: 200pt; float: right; white-space: pre;}
#history {width: 60%; font-size: 10pt; margin-left: auto; margin-right: auto;}
#history thead tr {background-color: #E0E0E0;}
#history td.date {text-align: right;}
#history td.version {text-align: center;}
#history td.desc {width: 100%; text-align: justify;}
#history td.name {text-align: left;}
#toc {margin: 70pt;}
#toc li {list-style: none;}
.section {margin: 70pt 70pt 70pt 100pt;}
.section h2, .section h3 {margin-left: -30pt;}
pre {font-family: Lucida Console; overflow: scroll;}
.center {margin-left: auto; margin-right: auto; text-align: center;}
span.bra {font-family: Arial Unicode MS;}
div.note {margin: 3pt; margin-bottom: 14pt; padding: 0 12pt 6pt 12pt; background-color: #E0E0E0;}
div.note h2 {
    margin: 0 -12pt 12pt -12pt;
    padding: 5pt;
    text-align: center;
    background-color: #606060;
    color: white;
    font-size: 14pt;
}
div.image {text-align: center;}
div.image img {padding: 10px; border: dashed thin black;}
/*]]>*/
</style>
</head>

<body>
    <div id="header"><h1 id="title">imapcommands:// protocol handler</h1><h2 id="author">Gabriele Santilli</h2><h2 id="dateversion">1.0.0</h2><p id="purpose">
        This program defines the protocol handler for REBOL's imapcommands://
        protocol scheme. The handler allows connecting to a IMAP server and
        communicating with it via an IMAP dialect. This allows full access to
        IMAP's features.
    </p><div id="license">
        =================================
        A message from Qtask about this source code:

        We have selected the MIT license (as of 2010-Jan-1) because
        it is the closest “standard” license to our intent.  If we had our way,
        we would declare this source as public domain, with absolutely no
        strings attached, not even the string that says you have to have
        strings.  We want to help people, so please feel free to contact us
        at API@Qtask.com if you have questions.
         

        (you only need to include the standard license text below in your
        homage to this source code)
        =================================

        Copyright 2009 Qtask, Inc.

        Permission is hereby granted, free of charge, to any person obtaining
        a copy of this software and associated documentation files
        (the "Software"), to deal in the Software without restriction, including
        without limitation the rights to use, copy, modify, merge, publish,
        distribute, sublicense, and/or sell copies of the Software, and to
        permit persons to whom the Software is furnished to do so, subject
        to the following conditions:

        The above copyright notice and this permission notice shall be included
        in all copies or substantial portions of the Software.

        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
        OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
        FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
        THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
        OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
        ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
        OTHER DEALINGS IN THE SOFTWARE.
    </div></div><div id="toc"><h2>Contents:</h2><ul><li><a href="#section-1">1. Introduction</a></li><li><a href="#section-2">2. Overview</a></li><li><a href="#section-3">3. IMAP handler functions</a></li><li><a href="#section-4">4. IMAP handler support functions</a></li></ul></div><div class="section"><h2 id="section-1">1. Introduction</h2><p>REBOL's <span class="code"><span class="url">imap://</span></span> protocol handler is too limited for the purpose of writing a complete
IMAP client. For this reason, <span class="code"><span class="url">imapcommands://</span></span> was created, that allows a lower level,
but more complete, access to IMAP servers.</p></div><div class="section"><h2 id="section-2">2. Overview</h2><p>This is a <em>pass-thru</em> protocol handler; authentication is handled automatically
on <span class="code"><span class="word key"title="OPEN spec /binary /string /direct /seek /new /read /write /no-wait /lines /with end-of-line /allow access /mode args /custom params /skip length">open</span></span>; other than that, commands can be sent to the server using the <span class="code"><span class="word key"title="INSERT series value /part range /only /dup count">insert</span></span>
function, and responses can be obtained using the <span class="code"><span class="word key"title="COPY value /part range /deep">copy</span></span> function. (See <span class="code"><span class="ref"><span class="bra">&#9001;</span><a href="#section-3">IMAP handler functions</a><span class="bra">&#9002;</span></span></span>.)
The handler accepts commands as REBOL values and transforms them to IMAP commands before
sending them to the server; the server response is also parsed into REBOL values. So,
the user of this protocol does not have to know IMAP syntax; however the user has to know
how to use the IMAP commands.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Overview<span class="bra">&#9002;</span> &#8801;</p><p><span class="ref"><span class="bra">&#9001;</span><a href="#section-4">IMAP handler support functions</a><span class="bra">&#9002;</span></span><br /><br /><span class="word key"title="MAKE type spec">make</span> <span class="word">Root-Protocol</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">port-flags:</span> <span class="path"><span class="word">system</span>/<span class="word">standard</span>/<span class="word">port-flags</span>/<span class="word">pass-thru</span></span><br /><span class="tab">&nbsp;</span><br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3">IMAP handler functions</a><span class="bra">&#9002;</span></span><br /><br /><span class="tab">&nbsp;</span><span class="path"><span class="word">net-utils</span>/<span class="word">net-install</span></span> <span class="word">IMAPcommands</span> <span class="word">self</span> <span class="integer">143</span><br /><span class="tab">&nbsp;</span><span class="path"><span class="word">net-utils</span>/<span class="word">net-install</span></span> <span class="word">IMAPScommands</span> <span class="word">self</span> <span class="integer">993</span><br />]</p></div></div><div class="section"><h2 id="section-3">3. IMAP handler functions</h2><p>The handler functions are those that get called when using <span class="code"><span class="word key"title="OPEN spec /binary /string /direct /seek /new /read /write /no-wait /lines /with end-of-line /allow access /mode args /custom params /skip length">open</span></span>, <span class="code"><span class="word key"title="INSERT series value /part range /only /dup count">insert</span></span> etc. on
the <span class="code"><span class="word datatype"title="">port!</span></span> value.</p><p>The <span class="code"><span class="word key"title="OPEN spec /binary /string /direct /seek /new /read /write /no-wait /lines /with end-of-line /allow access /mode args /custom params /skip length">open</span></span> function takes care of initializing the port, opening the TCP connection with
the server, and performing the user authentication. CRAM-MD5 is the preferred method of
authentication. If that fails, a simple LOGIN auth is attempted.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>IMAP handler functions<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">open:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span> <span class="refinement">/local</span> <span class="word">resp</span> <span class="word">auth-done</span>] [<br /><span class="tab">&nbsp;</span><span class="set-path">port/locals:</span> <span class="word key"title="CONTEXT blk">context</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">tagid:</span> <span class="integer">1</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">capabilities:</span> <span class="word">none</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="path"><span class="word">port</span>/<span class="word">scheme</span></span> <span class="word key"title="= value1 value2">=</span> <span class="lit-word">'IMAPScommands</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word">open-proto</span>/<span class="word key"title="SECURE 'level">secure</span>/<span class="word">sub-protocol</span></span> <span class="word">port</span> <span class="lit-word">'ssl</span><br /><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">open-proto</span> <span class="word">port</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="set-word">resp:</span> <span class="word">read-line</span> <span class="word">port</span><br /><span class="tab">&nbsp;</span><span class="set-word">auth-done:</span> <span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word">resp</span> [<span class="lit-word">'*</span> <span class="lit-word">'PREAUTH</span> <span class="word key"title="TO type spec">to</span> <span class="word">end</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="NOT value">not</span> <span class="word">auth-done</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">send-command</span> <span class="word">port</span> [<span class="word">CAPABILITY</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">port</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<span class="lit-word">'*</span> <span class="lit-word">'CAPABILITY</span> <span class="set-word">resp:</span> <span class="word key"title="TO type spec">to</span> <span class="word">end</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<span class="word datatype"title="">word!</span> <span class="lit-word">'OK</span> <span class="word">opt</span> <span class="word datatype"title="">block!</span> <span class="word datatype"title="">string!</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">port/locals/capabilities:</span> <span class="word key"title="COPY* value /part range /deep">copy*</span> <span class="word">resp</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">port/locals/capabilities:</span> [<span class="word">AUTH=CRAM-MD5</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span> <span class="path"><span class="word">port</span>/<span class="word">locals</span>/<span class="word">capabilities</span></span> <span class="lit-word">'AUTH=CRAM-MD5</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">send-command</span> <span class="word">port</span> [<span class="word">AUTHENTICATE</span> <span class="word">CRAM-MD5</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word">read-line</span> <span class="word">port</span> [<span class="lit-word">'+</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">resp</span> <span class="word datatype"title="">string!</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">imap-do-cram-md5</span> <span class="word">port</span> <span class="word">resp</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word key"title="LAST series">last</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">port</span> [<span class="word datatype"title="">word!</span> <span class="lit-word">'OK</span> <span class="word">opt</span> <span class="word datatype"title="">block!</span> <span class="word datatype"title="">string!</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">auth-done:</span> <span class="word">yes</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="comment">; attempt login in any case</span><br /><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="NOT value">not</span> <span class="word">auth-done</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">send-command</span> <span class="word">port</span> <span class="word key"title="COMPOSE value /deep /only">compose</span> [<span class="word">LOGIN</span> (<span class="word key"title="FORM value">form</span> <span class="path"><span class="word">port</span>/<span class="word">user</span></span>) (<span class="word key"title="FORM value">form</span> <span class="path"><span class="word">port</span>/<span class="word">pass</span></span>)]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word key"title="LAST series">last</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">port</span> [<span class="word datatype"title="">word!</span> <span class="lit-word">'OK</span> <span class="word">opt</span> <span class="word datatype"title="">block!</span> <span class="word datatype"title="">string!</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">auth-done:</span> <span class="word">yes</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="NOT value">not</span> <span class="word">auth-done</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="NET-ERROR info">net-error</span> <span class="string">"No authentication method available"</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="set-path">port/state/tail:</span> <span class="integer">1</span><br />]</p></div><p>The <span class="code"><span class="word">close-check</span></span> block is used by the default <span class="code"><span class="word key"title="CLOSE port">close</span></span> function in <span class="code"><span class="word">Root-Protocol</span></span> when
closing the connection. This block means that the line <span class="code"><span class="string">"Q1 LOGOUT"</span></span> is sent to the server,
and there is no wait for a response.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>IMAP handler functions<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">close-check:</span> [<span class="string">"Q1 LOGOUT"</span> <span class="word">none</span>]</p></div><p>The <span class="code"><span class="word key"title="INSERT series value /part range /only /dup count">insert</span></span> function allows sending a command to the server. The command must be provided
as a REBOL block. (Example: <span class="code">[<span class="word">FETCH</span> <span class="integer">1</span> <span class="word">RFC822.HEADER</span>]</span>.) See the documentation of <span class="code"><span class="word">send-command</span></span>
in <span class="code"><span class="ref"><span class="bra">&#9001;</span><a href="#section-4">IMAP handler support functions</a><span class="bra">&#9002;</span></span></span> for more details.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>IMAP handler functions<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">insert:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span> <span class="word">value</span> [<span class="word datatype"title="">block!</span>]] [<br /><span class="tab">&nbsp;</span><span class="word">send-command</span> <span class="word">port</span> <span class="word">value</span><br />]</p></div><p>The <span class="code"><span class="word key"title="PICK series index">pick</span></span> function allows getting one line of response from the server. <em>Please note
that it does not return the whole response, just one line.</em> Use <span class="code"><span class="word key"title="COPY value /part range /deep">copy</span></span> to get the whole
response, or call <span class="code"><span class="word key"title="PICK series index">pick</span></span> repeatedly. (Note, that unlike <span class="code"><span class="word key"title="COPY value /part range /deep">copy</span></span>, <span class="code"><span class="word key"title="PICK series index">pick</span></span> does not error out
on a "NO" or "BAD" response from the server.)</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>IMAP handler functions<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">pick:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span>] [<br /><span class="tab">&nbsp;</span><span class="word">read-line</span> <span class="word">port</span><br />]</p></div><p><span class="code"><span class="word key"title="COPY value /part range /deep">copy</span></span> returns the server's response to the last sent command; each line returned by
the server is contained in a block.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>IMAP handler functions<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">copy:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span> <span class="refinement">/local</span> <span class="word">resp</span>] [<br /><span class="tab">&nbsp;</span><span class="word">collect</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="WHILE cond-block body-block">while</span> [<span class="word key"title="PARSE input rules /all /case">parse</span> <span class="set-word">resp:</span> <span class="word">read-line</span> <span class="word">port</span> [<span class="lit-word">'*</span> <span class="word key"title="TO type spec">to</span> <span class="word">end</span>]] [<span class="path"><span class="word">keep</span>/<span class="word">only</span></span> <span class="word">resp</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="lit-word">'OK</span> <span class="word key"title="&lt;&gt; value1 value2">&lt;&gt;</span> <span class="word key"title="SECOND series">second</span> <span class="word">resp</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="NET-ERROR info">net-error</span> <span class="word key"title="REFORM value">reform</span> [<span class="string">"Server error: IMAP"</span> <span class="word key"title="NEXT series">next</span> <span class="word">resp</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word">keep</span>/<span class="word">only</span></span> <span class="word">resp</span><br /><span class="tab">&nbsp;</span>]<br />]</p></div></div><div class="section"><h2 id="section-4">4. IMAP handler support functions</h2><p>We define <span class="code"><span class="word">pick*</span></span>, <span class="code"><span class="word">insert*</span></span> and <span class="code"><span class="word">set-modes*</span></span> as shortcuts to the global functions. (<span class="code"><span class="word key"title="COPY* value /part range /deep">copy*</span></span>
is already defined as an alias of <span class="code"><span class="word key"title="COPY value /part range /deep">copy</span></span>.)</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>IMAP handler support functions<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">pick*:</span> <span class="get-word">:pick</span><br /><span class="set-word">insert*:</span> <span class="get-word">:insert</span><br /><span class="set-word">set-modes*:</span> <span class="get-word">:set-modes</span></p></div><p><span class="code"><span class="word">read-line</span></span> reads one line from the server. The line is parsed using the <span class="code"><span class="word">parse-imap-line</span></span>
function from the IMAP parser module into REBOL values.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>IMAP handler support functions<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">read-line:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span> <span class="refinement">/local</span> <span class="word">line</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="set-word">line:</span> <span class="word">pick*</span> <span class="path"><span class="word">port</span>/<span class="word">sub-port</span></span> <span class="integer">1</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word">net-utils</span>/<span class="word">net-log</span></span> <span class="word">line</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">parse-imap-line</span> <span class="word">line</span> <span class="path"><span class="word">port</span>/<span class="word">sub-port</span></span><br /><span class="tab">&nbsp;</span>]<br />]</p></div><p>The <span class="code"><span class="word">send-command</span></span> function sends a command to the server. Each command must be
prefixed by a unique tag; <span class="code"><span class="path"><span class="word">port</span>/<span class="word">locals</span>/<span class="word">tagid</span></span></span> is used to generate it. <span class="code"><span class="word">form-imap</span></span>
(from the IMAP parser module) translates the <span class="code"><span class="word">command</span></span> block into IMAP syntax;
then each line of the command is sent
to the server, waiting for the server's ready message before sending any literal string.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>IMAP handler support functions<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">send-command:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span> <span class="word">command</span> [<span class="word datatype"title="">block!</span>]] [<br /><span class="tab">&nbsp;</span><span class="set-word">command:</span> <span class="word">form-imap</span> <span class="word key"title="REDUCE value /only words">reduce</span> [<span class="word key"title="REJOIN block">rejoin</span> [<span class="string">"A"</span> <span class="path"><span class="word">port</span>/<span class="word">locals</span>/<span class="word">tagid</span></span> <span class="string">" "</span>]] <span class="word">command</span><br /><span class="tab">&nbsp;</span><span class="path"><span class="word">net-utils</span>/<span class="word">net-log</span></span> <span class="word">command</span><br /><span class="tab">&nbsp;</span><span class="set-path">port/locals/tagid:</span> <span class="path"><span class="word">port</span>/<span class="word">locals</span>/<span class="word">tagid</span></span> <span class="word key"title="+ value1 value2">+</span> <span class="integer">1</span><br /><span class="tab">&nbsp;</span><span class="word key"title="FOREACH 'word data body">foreach</span> <span class="word">line</span> <span class="word">command</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="BINARY? value">binary?</span> <span class="word">line</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="NOT value">not</span> <span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word">read-line</span> <span class="word">port</span> [<span class="lit-word">'+</span> <span class="word key"title="TO type spec">to</span> <span class="word">end</span>] [<span class="word key"title="NET-ERROR info">net-error</span> <span class="string">"Server error: IMAP server not ready"</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">set-modes*</span> <span class="path"><span class="word">port</span>/<span class="word">sub-port</span></span> [<span class="set-word">lines:</span> <span class="word">false</span> <span class="set-word">binary:</span> <span class="word">true</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">insert*</span> <span class="path"><span class="word">port</span>/<span class="word">sub-port</span></span> <span class="word">line</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="BINARY? value">binary?</span> <span class="word">line</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">set-modes*</span> <span class="path"><span class="word">port</span>/<span class="word">sub-port</span></span> [<span class="set-word">binary:</span> <span class="word">false</span> <span class="set-word">lines:</span> <span class="word">true</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br />]</p></div><p>The <span class="code"><span class="word">imap-do-cram-md5</span></span> function (taken almost as-is from REBOL's <span class="code"><span class="url">imap://</span></span> protocol handler)
is used to perform the CRAM-MD5 user authentication.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>IMAP handler support functions<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">imap-do-cram-md5:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span> <span class="word">server-data</span> <span class="refinement">/local</span> <span class="word">send-data</span>] [<br /><span class="tab">&nbsp;</span><span class="set-word">server-data:</span> <span class="path"><span class="word key"title="DEBASE value /base base-value">debase</span>/<span class="word">base</span></span> <span class="word">server-data</span> <span class="integer">64</span><br /><span class="tab">&nbsp;</span><span class="set-word">send-data:</span> <span class="word key"title="REFORM value">reform</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word">port</span>/<span class="word">user</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="LOWERCASE string /part range">lowercase</span> <span class="path"><span class="word key"title="ENBASE value /base base-value">enbase</span>/<span class="word">base</span></span> <span class="path"><span class="word key"title="CHECKSUM data /tcp /secure /hash size /method word /key key-value">checksum</span>/<span class="word">method</span>/<span class="word">key</span></span> <span class="word">server-data</span> <span class="lit-word">'md5</span> <span class="path"><span class="word">port</span>/<span class="word">pass</span></span> <span class="integer">16</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="set-word">send-data:</span> <span class="path"><span class="word key"title="ENBASE value /base base-value">enbase</span>/<span class="word">base</span></span> <span class="word">send-data</span> <span class="integer">64</span><br /><span class="tab">&nbsp;</span><span class="path"><span class="word">net-utils</span>/<span class="word">net-log</span></span> <span class="word">send-data</span><br /><span class="tab">&nbsp;</span><span class="word">insert*</span> <span class="path"><span class="word">port</span>/<span class="word">sub-port</span></span> <span class="word">send-data</span><br />]</p></div></div>
    <div id="footer"><p><a href="http://www.rebol.com/">MakeDoc3 by REBOL</a> - 2-Sep-2018</p></div>
</body>
</html>
