<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta name="generator" content="REBOL" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

  <title>Filter port scheme for REBOL</title>

<style type="text/css">
/*<![CDATA[*/
html, body, p, li {font-family: Georgia, Times New Roman, serif; text-align: justify;}
.code, .code p {font-family: Trebuchet MS, Arial, Helvetica, sans-serif;}
.code .string, .code .tag, .code .issue {font-family: Lucida Console, Courier New, Courier, fixed;}
.code .word, .code .set-word, .code .lit-word, .code .get-word, .code .refinement {font-style: italic;}
.code .key {font-style: normal; font-weight: bold;}
.code .function {font-weight: bold; font-style: normal;}
.code .ref a {text-decoration: none; color: black;}
.code .ref a:hover {text-decoration: underline; color: blue;}
.code .issue, .code .tag, .code .datatype {color: green;}
.code .datatype {font-style: normal;}
.code .url, .code .file, .code .refinement, .code .lit-word {color: brown;}
.code .integer, .code .decimal, .code .tuple, .code .pair {color: blue;}
.code .comment {color: gray;}
div.code {margin-left: 95pt;}
div.code p.sectdef {font-style: normal; margin: 0 0 0 -30pt;}
div.code p {margin: 0;}
div.code span.tab {padding-left: .75cm; border-left: dotted thin #CCCCCC;}
div.code span.directive {background-color: #F0FFF0; border: dotted thin black;}
#header {margin: 34pt 140pt 140pt 140pt; padding: 0;}
#title {text-align: center; margin: 0 0 34pt 0;}
#author {text-align: center; margin: 13pt 0 0 0; font-size: 13pt;}
#dateversion {text-align: center; margin: 0 0 24pt 0; font-size: 12pt;}
#purpose {text-align: justify; font-style: italic;}
#license {font-size: 7pt; color: gray; margin: 2pt 10pt 2pt 10pt; width: 200pt; float: right; white-space: pre;}
#history {width: 60%; font-size: 10pt; margin-left: auto; margin-right: auto;}
#history thead tr {background-color: #E0E0E0;}
#history td.date {text-align: right;}
#history td.version {text-align: center;}
#history td.desc {width: 100%; text-align: justify;}
#history td.name {text-align: left;}
#toc {margin: 70pt;}
#toc li {list-style: none;}
.section {margin: 70pt 70pt 70pt 100pt;}
.section h2, .section h3 {margin-left: -30pt;}
pre {font-family: Lucida Console; overflow: scroll;}
.center {margin-left: auto; margin-right: auto; text-align: center;}
span.bra {font-family: Arial Unicode MS;}
div.note {margin: 3pt; margin-bottom: 14pt; padding: 0 12pt 6pt 12pt; background-color: #E0E0E0;}
div.note h2 {
    margin: 0 -12pt 12pt -12pt;
    padding: 5pt;
    text-align: center;
    background-color: #606060;
    color: white;
    font-size: 14pt;
}
div.image {text-align: center;}
div.image img {padding: 10px; border: dashed thin black;}
/*]]>*/
</style>
</head>

<body>
    <div id="header"><h1 id="title">Filter port scheme for REBOL</h1><h2 id="author">Gabriele Santilli</h2><h2 id="dateversion">1.0.0</h2><p id="purpose">
        Implements filter://, a port scheme that allows filtering a stream of data thru
        a function.
    </p><div id="license">
        =================================
        A message from Qtask about this source code:

        We have selected the MIT license (as of 2010-Jan-1) because
        it is the closest “standard” license to our intent.  If we had our way,
        we would declare this source as public domain, with absolutely no
        strings attached, not even the string that says you have to have
        strings.  We want to help people, so please feel free to contact us
        at API@Qtask.com if you have questions.
         

        (you only need to include the standard license text below in your
        homage to this source code)
        =================================

        Copyright 2008 Qtask, Inc.

        Permission is hereby granted, free of charge, to any person obtaining
        a copy of this software and associated documentation files
        (the "Software"), to deal in the Software without restriction, including
        without limitation the rights to use, copy, modify, merge, publish,
        distribute, sublicense, and/or sell copies of the Software, and to
        permit persons to whom the Software is furnished to do so, subject
        to the following conditions:

        The above copyright notice and this permission notice shall be included
        in all copies or substantial portions of the Software.

        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
        OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
        FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
        THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
        OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
        ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
        OTHER DEALINGS IN THE SOFTWARE.
    </div></div><div id="toc"><h2>Contents:</h2><ul><li><a href="#section-1">1. Introduction</a></li><li><a href="#section-2">2. Overview</a></li><li><a href="#section-3">3. Usage examples</a></li><li><a href="#section-4">4. Implementation</a></li><ul><li><a href="#section-4.1">4.1 Initialize the filter port <span class="code"><span class="word">port</span></span> from <span class="code"><span class="word">spec</span></span></a></li><li><a href="#section-4.2">4.2 Open the filter port <span class="code"><span class="word">port</span></span></a></li><li><a href="#section-4.3">4.3 Close the filter port <span class="code"><span class="word">port</span></span></a></li><li><a href="#section-4.4">4.4 Write <span class="code"><span class="word">data</span></span> into the input buffer, filter it to the output buffer if we have enough data</a></li><li><a href="#section-4.5">4.5 Put the contents of the output buffer into <span class="code"><span class="word">data</span></span> and clear the output buffer</a></li><li><a href="#section-4.6">4.6 Filter remaining data (even if we have less than <span class="code"><span class="word">block-length</span></span>)</a></li><li><a href="#section-4.7">4.7 Support functions</a></li></ul></ul></div><div class="section"><h2 id="section-1">1. Introduction</h2><p>This port scheme allows creating a "filter" port that applies a function to a data stream.
The function should accept <span class="code"><span class="word datatype"title="">binary!</span></span> or <span class="code"><span class="word datatype"title="">string!</span></span> as input and return <span class="code"><span class="word datatype"title="">binary!</span></span> or <span class="code"><span class="word datatype"title="">string!</span></span>
as output. (We recommend always using this port in <span class="code"><span class="refinement">/binary</span></span> mode.) You can control the size
of the data chunks that your function will be called on.</p></div><div class="section"><h2 id="section-2">2. Overview</h2><p>We define the <span class="code"><span class="url">filter://</span></span> scheme in the usual way; although this is not really a network protocol,
REBOL does not like it if we don't use <span class="code"><span class="word">net-install</span></span>. The specified port id does not matter (any
random number will do).</p><p>Since we're writing a non pass-thru port, we only have to define <span class="code"><span class="word key"title="READ source /binary /string /direct /no-wait /lines /part size /with end-of-line /mode args /custom params /skip length">read</span></span> and <span class="code"><span class="word key"title="WRITE destination value /binary /string /direct /append /no-wait /lines /part size /with end-of-line /allow access /mode args /custom params">write</span></span>, and REBOL
will map <span class="code"><span class="word key"title="INSERT series value /part range /only /dup count">insert</span></span>, <span class="code"><span class="word key"title="COPY value /part range /deep">copy</span></span>, <span class="code"><span class="word key"title="PICK series index">pick</span></span> etc. to them internally; REBOL will also do any line termination
conversion, however we recommend only using <span class="code"><span class="refinement">/binary</span></span> ports for filtering. This scheme has not
been tested without <span class="code"><span class="refinement">/binary</span></span>.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Overview<span class="bra">&#9002;</span> &#8801;</p><p><span class="path"><span class="word">net-utils</span>/<span class="word">net-install</span></span> <span class="lit-word">'filter</span> <span class="word key"title="MAKE type spec">make</span> <span class="word">Root-Protocol</span> [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.7">Support functions</a><span class="bra">&#9002;</span></span><br /><span class="tab">&nbsp;</span><br /><span class="tab">&nbsp;</span><span class="set-word">init:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span> <span class="word">spec</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.1">Initialize the filter port <span class="code"><span class="word">port</span></span> from <span class="code"><span class="word">spec</span></span></a><span class="bra">&#9002;</span></span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="set-word">open:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.2">Open the filter port <span class="code"><span class="word">port</span></span></a><span class="bra">&#9002;</span></span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="set-word">close:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.3">Close the filter port <span class="code"><span class="word">port</span></span></a><span class="bra">&#9002;</span></span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="set-word">write:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span> <span class="word">data</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.4">Write <span class="code"><span class="word">data</span></span> into the input buffer, filter it to the output buffer if we have enough data</a><span class="bra">&#9002;</span></span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="set-word">read:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span> <span class="word">data</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.5">Put the contents of the output buffer into <span class="code"><span class="word">data</span></span> and clear the output buffer</a><span class="bra">&#9002;</span></span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="set-word">update:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.6">Filter remaining data (even if we have less than <span class="code"><span class="word">block-length</span></span>)</a><span class="bra">&#9002;</span></span><br /><span class="tab">&nbsp;</span>]<br />] <span class="integer">80</span></p></div></div><div class="section"><h2 id="section-3">3. Usage examples</h2><p>The following example will create a port that converts its input to base64:</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Usage examples<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">enbase-port:</span> <span class="path"><span class="word key"title="OPEN spec /binary /string /direct /seek /new /read /write /no-wait /lines /with end-of-line /allow access /mode args /custom params /skip length">open</span>/<span class="word">binary</span></span> [<span class="set-word">scheme:</span> <span class="lit-word">'filter</span> <span class="set-word">function:</span> <span class="get-word">:enbase</span> <span class="set-word">block-length:</span> <span class="integer">3</span>]</p></div><p>We specified using the <span class="code"><span class="word key"title="ENBASE value /base base-value">enbase</span></span> function on the data chunks, and <span class="code"><span class="set-word">block-length:</span> <span class="integer">3</span></span> means that the
function will only be called on chunks whose size is a multiple of 3 bytes. (The last chunk in the stream
is an exception in that it may be not a multiple of 3, since no automatic padding is done.)</p><p>It is also possible to be more strict with the block length:</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Usage examples<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">enbase-port:</span> <span class="path"><span class="word key"title="OPEN spec /binary /string /direct /seek /new /read /write /no-wait /lines /with end-of-line /allow access /mode args /custom params /skip length">open</span>/<span class="word">binary</span></span> [<span class="set-word">scheme:</span> <span class="lit-word">'filter</span> <span class="set-word">function:</span> <span class="get-word">:enbase</span> <span class="set-word">block-length:</span> <span class="integer">-54</span>]</p></div><p>In this case <span class="code"><span class="word key"title="ENBASE value /base base-value">enbase</span></span> will be called with chunks that are <em>exactly</em> 54 bytes long. (Again, the last chunk
is an exception and can be any length, lesser or equal to 54.) We recommend not using small numbers here (like
in this example), because if you have a large stream it will be slow to call your function many times
on small chunks (instead of a few times on large chunks).</p><p>If you don't care about the size of the chunks, you don't need to specify <span class="code"><span class="word">block-length</span></span>:</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Usage examples<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">my-port:</span> <span class="path"><span class="word key"title="OPEN spec /binary /string /direct /seek /new /read /write /no-wait /lines /with end-of-line /allow access /mode args /custom params /skip length">open</span>/<span class="word">binary</span></span> [<span class="set-word">scheme:</span> <span class="lit-word">'filter</span> <span class="set-word">function:</span> <span class="get-word">:my-function</span>]</p></div><p>In this case your function is going to be called as soon as new data is inserted to the port. The above can
also be written as:</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Usage examples<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">my-port:</span> <span class="path"><span class="word key"title="OPEN spec /binary /string /direct /seek /new /read /write /no-wait /lines /with end-of-line /allow access /mode args /custom params /skip length">open</span>/<span class="word">binary</span></span> <span class="url">filter://my-function</span></p></div><p>provided that <span class="code"><span class="word">my-function</span></span> is defined in the global context.</p></div><div class="section"><h2 id="section-4">4. Implementation</h2><p>The implementation of the port scheme is relatively trivial.</p><h3 id="section-4.1">4.1 Initialize the filter port <span class="code"><span class="word">port</span></span> from <span class="code"><span class="word">spec</span></span></h3><p>The <span class="code"><span class="word">init</span></span> function is used to initialize the port (called when you <span class="code"><span class="word key"title="MAKE type spec">make</span></span> it). The user will
need to specify a function and, optionally, a block length. See <span class="code"><span class="ref"><span class="bra">&#9001;</span><a href="#section-3">Usage examples</a><span class="bra">&#9002;</span></span></span> for more details.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Initialize the filter port <span class="code"><span class="word">port</span></span> from <span class="code"><span class="word">spec</span></span><span class="bra">&#9002;</span> &#8801;</p><p><span class="set-path">port/locals:</span> <span class="word key"title="CONTEXT blk">context</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">function:</span> <span class="set-word">block-length:</span> <span class="set-word">inbuf:</span> <span class="set-word">outbuf:</span> <span class="word">none</span><br />]<br /><span class="set-path">port/url:</span> <span class="word">spec</span><br /><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="URL? value">url?</span> <span class="word">spec</span> [<br /><span class="tab">&nbsp;</span><span class="comment">; assume that user gave us a function name</span><br /><span class="tab">&nbsp;</span><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word">spec</span> [<span class="string">"filter:"</span> <span class="integer">0</span> <span class="integer">2</span> <span class="char">#"/"</span> <span class="set-word">spec:</span>]<br /><span class="tab">&nbsp;</span><span class="set-word">spec:</span> <span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">word!</span> <span class="word">spec</span><br /><span class="tab">&nbsp;</span><span class="set-path">port/locals/function:</span> <span class="word key"title="GET word /any">get</span> <span class="word">spec</span><br />] [<br /><span class="tab">&nbsp;</span><span class="set-path">port/locals:</span> <span class="word key"title="MAKE type spec">make</span> <span class="path"><span class="word">port</span>/<span class="word">locals</span></span> <span class="word">spec</span><br />]<br /><span class="word key"title="UNLESS condition block">unless</span> <span class="word key"title="ANY-FUNCTION? value">any-function?</span> <span class="word key"title="GET word /any">get</span> <span class="word key"title="IN object word">in</span> <span class="path"><span class="word">port</span>/<span class="word">locals</span></span> <span class="lit-word">'function</span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="NET-ERROR info">net-error</span> <span class="string">"You must specify a function for filtering"</span><br />]</p></div><h3 id="section-4.2">4.2 Open the filter port <span class="code"><span class="word">port</span></span></h3><p>On <span class="code"><span class="word key"title="OPEN spec /binary /string /direct /seek /new /read /write /no-wait /lines /with end-of-line /allow access /mode args /custom params /skip length">open</span></span>, we create the input and output buffers, and force <span class="code"><span class="refinement">/direct</span></span> mode (since we are a "filter"
kind of port).</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Open the filter port <span class="code"><span class="word">port</span></span><span class="bra">&#9002;</span> &#8801;</p><p><span class="set-path">port/locals/inbuf:</span> <span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">binary!</span> <span class="integer">1024</span><br /><span class="set-path">port/locals/outbuf:</span> <span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">binary!</span> <span class="integer">1024</span><br /><span class="set-path">port/state/flags:</span> <span class="path"><span class="word">port</span>/<span class="word">state</span>/<span class="word">flags</span></span> <span class="word key"title="OR value1 value2">or</span> <span class="path"><span class="word">system</span>/<span class="word">standard</span>/<span class="word">port-flags</span>/<span class="word">direct</span></span></p></div><h3 id="section-4.3">4.3 Close the filter port <span class="code"><span class="word">port</span></span></h3><p>When closing we just set the buffers to <span class="code"><span class="word">none</span></span> in order to allow memory to be reclaimed.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Close the filter port <span class="code"><span class="word">port</span></span><span class="bra">&#9002;</span> &#8801;</p><p><span class="set-path">port/locals/inbuf:</span> <span class="word">none</span><br /><span class="set-path">port/locals/outbuf:</span> <span class="word">none</span></p></div><h3 id="section-4.4">4.4 Write <span class="code"><span class="word">data</span></span> into the input buffer, filter it to the output buffer if we have enough data</h3><p><span class="code"><span class="word key"title="WRITE destination value /binary /string /direct /append /no-wait /lines /part size /with end-of-line /allow access /mode args /custom params">write</span></span> is where most of the work happens. If a <span class="code"><span class="word">block-length</span></span> has been specified, we call the <span class="code"><span class="word">filter-block</span></span>
function (see <span class="code"><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.7">Support functions</a><span class="bra">&#9002;</span></span></span>). Otherwise, we just call the provided function with the data that has
been written and store the result in the output buffer. We return the number of bytes actually written.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Write <span class="code"><span class="word">data</span></span> into the input buffer, filter it to the output buffer if we have enough data<span class="bra">&#9002;</span> &#8801;</p><p><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="INTEGER? value">integer?</span> <span class="path"><span class="word">port</span>/<span class="word">locals</span>/<span class="word">block-length</span></span> [<br /><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="INSERT series value /part range /only /dup count">insert</span>/<span class="word">part</span></span> <span class="word key"title="TAIL series">tail</span> <span class="path"><span class="word">port</span>/<span class="word">locals</span>/<span class="word">inbuf</span></span> <span class="word">data</span> <span class="path"><span class="word">port</span>/<span class="word">state</span>/<span class="word">num</span></span><br /><span class="tab">&nbsp;</span><span class="word">filter-block</span> <span class="path"><span class="word">port</span>/<span class="word">locals</span>/<span class="word">outbuf</span></span> <span class="path"><span class="word">port</span>/<span class="word">locals</span>/<span class="word">inbuf</span></span> <span class="word key"title="GET word /any">get</span> <span class="word key"title="IN object word">in</span> <span class="path"><span class="word">port</span>/<span class="word">locals</span></span> <span class="lit-word">'function</span> <span class="path"><span class="word">port</span>/<span class="word">locals</span>/<span class="word">block-length</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="TAIL series">tail</span> <span class="path"><span class="word">port</span>/<span class="word">locals</span>/<span class="word">outbuf</span></span> <span class="path"><span class="word">port</span>/<span class="word">locals</span>/<span class="word key"title="FUNCTION spec vars body">function</span></span> <span class="path"><span class="word key"title="COPY value /part range /deep">copy</span>/<span class="word">part</span></span> <span class="word">data</span> <span class="path"><span class="word">port</span>/<span class="word">state</span>/<span class="word">num</span></span><br />]<br /><span class="path"><span class="word">port</span>/<span class="word">state</span>/<span class="word">num</span></span></p></div><h3 id="section-4.5">4.5 Put the contents of the output buffer into <span class="code"><span class="word">data</span></span> and clear the output buffer</h3><p>On <span class="code"><span class="word key"title="READ source /binary /string /direct /no-wait /lines /part size /with end-of-line /mode args /custom params /skip length">read</span></span> we just call <span class="code"><span class="word">read-data</span></span>; see <span class="code"><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.7">Support functions</a><span class="bra">&#9002;</span></span></span>.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Put the contents of the output buffer into <span class="code"><span class="word">data</span></span> and clear the output buffer<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">read-data</span> <span class="word">data</span> <span class="path"><span class="word">port</span>/<span class="word">locals</span>/<span class="word">outbuf</span></span> <span class="path"><span class="word">port</span>/<span class="word">state</span>/<span class="word">num</span></span></p></div><h3 id="section-4.6">4.6 Filter remaining data (even if we have less than <span class="code"><span class="word">block-length</span></span>)</h3><p>On <span class="code"><span class="word key"title="UPDATE port">update</span></span>, we filter any data that we still have in the input buffer (regardless of its length and the block length),
and store the results in the output buffer.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Filter remaining data (even if we have less than <span class="code"><span class="word">block-length</span></span>)<span class="bra">&#9002;</span> &#8801;</p><p><span class="word key"title="UNLESS condition block">unless</span> <span class="word key"title="EMPTY? series">empty?</span> <span class="path"><span class="word">port</span>/<span class="word">locals</span>/<span class="word">inbuf</span></span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="TAIL series">tail</span> <span class="path"><span class="word">port</span>/<span class="word">locals</span>/<span class="word">outbuf</span></span> <span class="path"><span class="word">port</span>/<span class="word">locals</span>/<span class="word key"title="FUNCTION spec vars body">function</span></span> <span class="path"><span class="word">port</span>/<span class="word">locals</span>/<span class="word">inbuf</span></span><br /><span class="tab">&nbsp;</span><span class="word key"title="CLEAR series">clear</span> <span class="path"><span class="word">port</span>/<span class="word">locals</span>/<span class="word">inbuf</span></span><br />]</p></div><h3 id="section-4.7">4.7 Support functions</h3><p>The <span class="code"><span class="word">filter-block</span></span> function is used to call the provided function <span class="code"><span class="word">f</span></span> on <span class="code"><span class="word">data</span></span> taking
into account <span class="code"><span class="word">block-length</span></span>. If <span class="code"><span class="word">block-length</span></span> is positive, as long as we have more than
<span class="code"><span class="word">block-length</span></span> bytes in the input buffer (<span class="code"><span class="word">data</span></span>), we call <span class="code"><span class="word">f</span></span> with a multiple of <span class="code"><span class="word">block-length</span></span>
bytes taken from <span class="code"><span class="word">data</span></span>, and store the result in the <span class="code"><span class="word">output</span></span> buffer.</p><p>If <span class="code"><span class="word">block-length</span></span> is negative, we split <span class="code"><span class="word">data</span></span> into pieces of <span class="code"><span class="word key"title="- value1 value2">-</span> <span class="word">block-length</span></span> bytes and call
<span class="code"><span class="word">f</span></span> on each piece, storing the result in <span class="code"><span class="word">output</span></span>.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Support functions<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">filter-block:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">output</span> <span class="word">data</span> <span class="word">f</span> <span class="word">block-length</span> <span class="refinement">/local</span> <span class="word">len</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word">block-length</span> <span class="word key"title="&gt; value1 value2">&gt;</span> <span class="integer">0</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">len:</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">data</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word">len</span> <span class="word key"title="&gt;= value1 value2">&gt;=</span> <span class="word">block-length</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">len:</span> <span class="word">len</span> <span class="word key"title="- value1 value2">-</span> (<span class="word">len</span> <span class="word key"title="// value1 value2">//</span> <span class="word">block-length</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="TAIL series">tail</span> <span class="word">output</span> <span class="word">f</span> <span class="path"><span class="word">take</span>/<span class="word">part</span></span> <span class="word">data</span> <span class="word">len</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="comment">; &lt; 0 means that we want blocks of EXACTLY block-length bytes</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">block-length:</span> <span class="word key"title="NEGATE number">negate</span> <span class="word">block-length</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="WHILE cond-block body-block">while</span> [<span class="word">block-length</span> <span class="word key"title="&lt;= value1 value2">&lt;=</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">data</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="TAIL series">tail</span> <span class="word">output</span> <span class="word">f</span> <span class="path"><span class="word">take</span>/<span class="word">part</span></span> <span class="word">data</span> <span class="word">block-length</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br />]</p></div><p><span class="code"><span class="word">read-data</span></span> just copies data from <span class="code"><span class="word key"title="INPUT /hide">input</span></span> to <span class="code"><span class="word">output</span></span>, never copying more than <span class="code"><span class="word">len</span></span> bytes.
Copied data is removed from <span class="code"><span class="word key"title="INPUT /hide">input</span></span>. The number of bytes actually copied is returned.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Support functions<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">read-data:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">output</span> <span class="word key"title="INPUT /hide">input</span> <span class="word">len</span>] [<br /><span class="tab">&nbsp;</span><span class="set-word">len:</span> <span class="word key"title="MIN value1 value2">min</span> <span class="word">len</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word key"title="INPUT /hide">input</span><br /><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="INSERT series value /part range /only /dup count">insert</span>/<span class="word">part</span></span> <span class="word key"title="TAIL series">tail</span> <span class="word">output</span> <span class="word key"title="INPUT /hide">input</span> <span class="word">len</span><br /><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="REMOVE series /part range">remove</span>/<span class="word">part</span></span> <span class="word key"title="INPUT /hide">input</span> <span class="word">len</span><br /><span class="tab">&nbsp;</span><span class="word">len</span><br />]</p></div></div>
    <div id="footer"><p><a href="http://www.rebol.com/">MakeDoc3 by REBOL</a> - 2-Sep-2018</p></div>
</body>
</html>
