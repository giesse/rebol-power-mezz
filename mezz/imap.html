<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta name="generator" content="REBOL" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

  <title>IMAP access functions</title>

<style type="text/css">
/*<![CDATA[*/
html, body, p, li {font-family: Georgia, Times New Roman, serif; text-align: justify;}
.code, .code p {font-family: Trebuchet MS, Arial, Helvetica, sans-serif;}
.code .string, .code .tag, .code .issue {font-family: Lucida Console, Courier New, Courier, fixed;}
.code .word, .code .set-word, .code .lit-word, .code .get-word, .code .refinement {font-style: italic;}
.code .key {font-style: normal; font-weight: bold;}
.code .function {font-weight: bold; font-style: normal;}
.code .ref a {text-decoration: none; color: black;}
.code .ref a:hover {text-decoration: underline; color: blue;}
.code .issue, .code .tag, .code .datatype {color: green;}
.code .datatype {font-style: normal;}
.code .url, .code .file, .code .refinement, .code .lit-word {color: brown;}
.code .integer, .code .decimal, .code .tuple, .code .pair {color: blue;}
.code .comment {color: gray;}
div.code {margin-left: 95pt;}
div.code p.sectdef {font-style: normal; margin: 0 0 0 -30pt;}
div.code p {margin: 0;}
div.code span.tab {padding-left: .75cm; border-left: dotted thin #CCCCCC;}
div.code span.directive {background-color: #F0FFF0; border: dotted thin black;}
#header {margin: 34pt 140pt 140pt 140pt; padding: 0;}
#title {text-align: center; margin: 0 0 34pt 0;}
#author {text-align: center; margin: 13pt 0 0 0; font-size: 13pt;}
#dateversion {text-align: center; margin: 0 0 24pt 0; font-size: 12pt;}
#purpose {text-align: justify; font-style: italic;}
#license {font-size: 7pt; color: gray; margin: 2pt 10pt 2pt 10pt; width: 200pt; float: right; white-space: pre;}
#history {width: 60%; font-size: 10pt; margin-left: auto; margin-right: auto;}
#history thead tr {background-color: #E0E0E0;}
#history td.date {text-align: right;}
#history td.version {text-align: center;}
#history td.desc {width: 100%; text-align: justify;}
#history td.name {text-align: left;}
#toc {margin: 70pt;}
#toc li {list-style: none;}
.section {margin: 70pt 70pt 70pt 100pt;}
.section h2, .section h3 {margin-left: -30pt;}
pre {font-family: Lucida Console; overflow: scroll;}
.center {margin-left: auto; margin-right: auto; text-align: center;}
span.bra {font-family: Arial Unicode MS;}
div.note {margin: 3pt; margin-bottom: 14pt; padding: 0 12pt 6pt 12pt; background-color: #E0E0E0;}
div.note h2 {
    margin: 0 -12pt 12pt -12pt;
    padding: 5pt;
    text-align: center;
    background-color: #606060;
    color: white;
    font-size: 14pt;
}
div.image {text-align: center;}
div.image img {padding: 10px; border: dashed thin black;}
/*]]>*/
</style>
</head>

<body>
    <div id="header"><h1 id="title">IMAP access functions</h1><h2 id="author">Gabriele Santilli</h2><h2 id="dateversion">1.7.2</h2><p id="purpose">
        This module exports a number of functions to access mail on a IMAP server.
    </p><div id="license">
        =================================
        A message from Qtask about this source code:

        We have selected the MIT license (as of 2010-Jan-1) because
        it is the closest “standard” license to our intent.  If we had our way,
        we would declare this source as public domain, with absolutely no
        strings attached, not even the string that says you have to have
        strings.  We want to help people, so please feel free to contact us
        at API@Qtask.com if you have questions.
         

        (you only need to include the standard license text below in your
        homage to this source code)
        =================================

        Copyright 2010 Qtask, Inc.

        Permission is hereby granted, free of charge, to any person obtaining
        a copy of this software and associated documentation files
        (the "Software"), to deal in the Software without restriction, including
        without limitation the rights to use, copy, modify, merge, publish,
        distribute, sublicense, and/or sell copies of the Software, and to
        permit persons to whom the Software is furnished to do so, subject
        to the following conditions:

        The above copyright notice and this permission notice shall be included
        in all copies or substantial portions of the Software.

        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
        OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
        FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
        THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
        OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
        ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
        OTHER DEALINGS IN THE SOFTWARE.
    </div></div><div id="toc"><h2>Contents:</h2><ul><li><a href="#section-1">1. Introduction</a></li><li><a href="#section-2">2. Overview</a></li><ul><li><a href="#section-2.1">2.1 Open and close functions</a></li><li><a href="#section-2.2">2.2 Mail folders functions</a></li><li><a href="#section-2.3">2.3 Mail messages functions</a></li><li><a href="#section-2.4">2.4 Search function</a></li></ul><li><a href="#section-3">3. Implementation</a></li><ul><li><a href="#section-3.1">3.1 Open/initialize the mail database</a></li><li><a href="#section-3.2">3.2 Validate the given IMAP settings</a></li><li><a href="#section-3.3">3.3 Check IMAP settings, throw error, or return true if all is ok</a></li><li><a href="#section-3.4">3.4 Check the IMAP connection, reopen it if necessary</a></li><li><a href="#section-3.5">3.5 Close the mail database</a></li><li><a href="#section-3.6">3.6 Return the headers for the messages contained in the folder identified by <span class="code"><span class="word">folder-id</span></span></a></li><li><a href="#section-3.7">3.7 Return the total number of messages and the number of unread messages in the folder</a></li><li><a href="#section-3.8">3.8 Store the mail message <span class="code"><span class="word">message</span></span> inside the folder identified by <span class="code"><span class="word">folder-id</span></span></a></li><li><a href="#section-3.9">3.9 Change the flags of the message identified by <span class="code"><span class="word">message-id</span></span> with <span class="code"><span class="word">flags</span></span></a></li><li><a href="#section-3.10">3.10 Return an object for the message identified by <span class="code"><span class="word">message-id</span></span></a></li><li><a href="#section-3.11">3.11 Move the message identified by <span class="code"><span class="word">message-id</span></span> to the folder identified by <span class="code"><span class="word">dest-folder-id</span></span></a></li><li><a href="#section-3.12">3.12 Create a new copy of the message identified by <span class="code"><span class="word">message-id</span></span> inside <span class="code"><span class="word">dest-folder-id</span></span> and return the message id of the copy</a></li><li><a href="#section-3.13">3.13 Remove all the messages in <span class="code"><span class="word">folder-id</span></span> which have the deleted flag</a></li><li><a href="#section-3.14">3.14 Create a new folder in the folder <span class="code"><span class="word">parent-id</span></span> and return its id</a></li><li><a href="#section-3.15">3.15 Destroy the contents of <span class="code"><span class="word">folder-id</span></span></a></li><li><a href="#section-3.16">3.16 Destroy the contents of <span class="code"><span class="word">folder-id</span></span> and then remove <span class="code"><span class="word">folder-id</span></span></a></li><li><a href="#section-3.17">3.17 Move <span class="code"><span class="word">folder-id</span></span> inside of <span class="code"><span class="word">dest-folder-id</span></span></a></li><li><a href="#section-3.18">3.18 Change the name of <span class="code"><span class="word">folder-id</span></span> to <span class="code"><span class="word">new-folder-name</span></span></a></li><li><a href="#section-3.19">3.19 Search the mail base for messages matching <span class="code"><span class="word">criteria</span></span></a></li><li><a href="#section-3.20">3.20 Return a list of the available folders</a></li></ul><li><a href="#section-4">4. Support functions</a></li></ul></div><div class="section"><h2 id="section-1">1. Introduction</h2><p>This module defines a number of functions that can be used to access mail on
a IMAP server.</p><p>It is designed to be easily used through Hardball.</p></div><div class="section"><h2 id="section-2">2. Overview</h2><p>The documentation is slightly out of date.</p><p>All the functions take a <span class="code"><span class="word">db</span></span> argument,
which contains the information needed to access the mail (eg. IMAP
server access info, and so on). 
You should always call the <span class="code"><span class="word">open-mail-db</span></span> and <span class="code"><span class="word">close-mail-db</span></span> functions; the former returns
the value you should pass to all the other functions as the <span class="code"><span class="word">db</span></span> argument (eg. it connects
to the IMAP server, and so on).</p><p>Please note that most functions may fail by throwing an error.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Overview<span class="bra">&#9002;</span> &#8801;</p><p><span class="comment">; we just need it loaded (so that it defines the scheme)</span><br /><span class="word">load-module</span> <span class="file">%schemes/imapcommands.r</span><br /><br /><span class="ref"><span class="bra">&#9001;</span><a href="#section-4">Support functions</a><span class="bra">&#9002;</span></span><br /><span class="ref"><span class="bra">&#9001;</span><a href="#section-2.1">Open and close functions</a><span class="bra">&#9002;</span></span><br /><span class="ref"><span class="bra">&#9001;</span><a href="#section-2.2">Mail folders functions</a><span class="bra">&#9002;</span></span><br /><span class="ref"><span class="bra">&#9001;</span><a href="#section-2.3">Mail messages functions</a><span class="bra">&#9002;</span></span><br /><span class="ref"><span class="bra">&#9001;</span><a href="#section-2.4">Search function</a><span class="bra">&#9002;</span></span></p></div><h3 id="section-2.1">2.1 Open and close functions</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Open and close functions<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">open-mail-db:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Open/initialize a mail database"</span><br /><span class="tab">&nbsp;</span><span class="word">db</span> <span class="string">"Object with [host: user: pass: secure: port:]"</span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3.1">Open/initialize the mail database</a><span class="bra">&#9002;</span></span><br />]<br /><span class="set-word">valid-mail-db?:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Validate IMAP settings"</span><br /><span class="tab">&nbsp;</span><span class="word">db</span> <span class="string">"Object with [host: user: pass: secure: port:]"</span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3.2">Validate the given IMAP settings</a><span class="bra">&#9002;</span></span><br />]<br /><span class="set-word">check-mail-db:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Attempt connection, throw error or return true"</span><br /><span class="tab">&nbsp;</span><span class="word">db</span> <span class="string">"Object with [host: user: pass: secure: port:]"</span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3.3">Check IMAP settings, throw error, or return true if all is ok</a><span class="bra">&#9002;</span></span><br />]<br /><span class="set-word">refresh-mail-db:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">{Make sure the mail database is still available, otherwise reopen it}</span><br /><span class="tab">&nbsp;</span><span class="word">db</span> <span class="string">"Result of open-mail-db"</span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3.4">Check the IMAP connection, reopen it if necessary</a><span class="bra">&#9002;</span></span><br />]<br /><br /><span class="set-word">close-mail-db:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Close a mail database"</span><br /><span class="tab">&nbsp;</span><span class="word">db</span> <span class="string">"Result of open-mail-db"</span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3.5">Close the mail database</a><span class="bra">&#9002;</span></span><br />]</p></div><h4 id="section-2.1.1">2.1.1 Example usage</h4><div class="code"><p><span class="set-word">db:</span> <span class="word">open-mail-db</span> [<span class="set-word">host:</span> <span class="string">"imap.server.com"</span> <span class="set-word">user:</span> <span class="string">"joe"</span> <span class="set-word">pass:</span> <span class="string">"user"</span> <span class="set-word">secure:</span> <span class="word">no</span>]<br /><span class="comment">; ...</span><br /><span class="word">close-mail-db</span> <span class="word">db</span></p></div><h3 id="section-2.2">2.2 Mail folders functions</h3><p>The <span class="code"><span class="word">list-mail-folders</span></span> function returns the list of mail folders as a tree. The result is
a block in the format <span class="code">[<span class="word key"title="ANY block">any</span> [<span class="word">name</span> <span class="word">id</span> <span class="word">flags</span> <span class="word">sub-folders</span>]]</span>, where <span class="code"><span class="word">name</span></span> is a <span class="code"><span class="word datatype"title="">string!</span></span> containing
the folder name, <span class="code"><span class="word">id</span></span> is the folder ID, <span class="code"><span class="word">flags</span></span> is a block of folder flags (<span class="code"><span class="word">children</span></span> means that it
can have sub folders - if this flag is not present, an attempt to create a sub folder will fail -,
<span class="code"><span class="word">messages</span></span> means that it can contain messages - otherwise, it's not a real mail folder -, <span class="code"><span class="word">new</span></span> means
that there may be new messages since last check), and <span class="code"><span class="word">sub-folders</span></span> is a block of sub folders in the
same format.</p><p>If the <span class="code"><span class="refinement">/all</span></span> refinement is given, the result contains all available folders, including hidden folders
(for IMAP, that means folders you are not subscribed to). Those folders will have the <span class="code"><span class="word">hidden</span></span> flag.
Note, that a hidden folder may still show in the result even without <span class="code"><span class="refinement">/all</span></span> if any sub folder is not
hidden.</p><p>If the <span class="code"><span class="refinement">/only</span></span> refinement is given, only the childs of the specified folder will be returned. <span class="code"><span class="word">parent-id</span></span>
is the folder ID of the parent; you can use <span class="code"><span class="word">none</span></span> to get only the root folders. The <span class="code"><span class="word">sub-folders</span></span> blocks
are always empty in this case.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Mail folders functions<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">list-mail-folders:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"List the existing mail folders"</span><br /><span class="tab">&nbsp;</span><span class="word">db</span> <span class="string">"Result of open-mail-db"</span><br /><span class="tab">&nbsp;</span><span class="refinement">/all</span> <span class="string">"Return all folders (including hidden folders)"</span><br /><span class="tab">&nbsp;</span><span class="refinement">/only</span> <span class="word">parent-id</span> <span class="string">{Return only the childs of the specified folder (none for root)}</span><br /><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="ref"><span class="bra">&#9001;</span><a href="#section-3.20.1"><span class="code"><span class="word">list-mail-folders</span></span>' locals</a><span class="bra">&#9002;</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3.20">Return a list of the available folders</a><span class="bra">&#9002;</span></span><br />]</p></div><p><span class="code"><span class="word">get-message-counts</span></span> returns a block with the number of messages and unread messages in the folder
identified by <span class="code"><span class="word">folder-id</span></span>.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Mail folders functions<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">get-message-counts:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Return the number of messages in a folder"</span><br /><span class="tab">&nbsp;</span><span class="word">db</span> <span class="string">"Result of open-mail-db"</span><br /><span class="tab">&nbsp;</span><span class="word">folder-id</span><br /><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="ref"><span class="bra">&#9001;</span><a href="#section-3.7.1"><span class="code"><span class="word">get-messages-count</span></span>'s locals</a><span class="bra">&#9002;</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3.7">Return the total number of messages and the number of unread messages in the folder</a><span class="bra">&#9002;</span></span><br />]</p></div><p>The <span class="code"><span class="word">list-mail-messages</span></span> function returns a block of blocks; each block represents a mail
message.</p><p>The <span class="code"><span class="word">columns</span></span> block is a block of words, and specifies the columns that should be returned.
The list of recognized words are:</p><dl><dt>id</dt><dd>the message ID.
<dd><dt>from</dt><dd>the message sender(s).
<dd><dt>to</dt><dd>the message recipient(s).
<dd><dt>subject</dt><dd>the message subject.
<dd><dt>size</dt><dd>the RFC822 message size (in bytes).
<dd><dt>flags</dt><dd>the message flags.
<dd><dt>date</dt><dd>the date when the message was sent (according to message header).
<dd><dt>received</dt><dd>the date when the message was received (according to the IMAP server).
<dd><dt>sender</dt><dd>the actual message sender according to the IMAP server.
<dd><dt>reply-to</dt><dd>the address to send replys to.
<dd><dt>cc</dt><dd>the message carbon copy recipient(s).
<dd><dt>bcc</dt><dd>the message blind carbon copy recipient(s); note that this only makes sense on
something like a "Sent" folder; in principle you should never see this in a message
you receive.
<dd><dt>in-reply-to</dt><dd>the message's "In-Reply-To:" header (<span class="code"><span class="word datatype"title="">string!</span></span>).
<dd><dt>message-id</dt><dd>the sender's message id (<span class="code"><span class="word datatype"title="">string!</span></span>) - do not confuse this with the ID column.
<dd><dt>has-attachments</dt><dd>flag (<span class="code"><span class="word datatype"title="">logic!</span></span>) that indicates whether the message has attachments; note that
it is separate from <span class="code"><span class="word">flags</span></span> because it is relatively expensive to compute.
<dd></dl><p>For any other word, <span class="code"><span class="word">none</span></span> is returned as the value.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Mail folders functions<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">list-mail-messages:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"List the messages contained in a folder"</span><br /><span class="tab">&nbsp;</span><span class="word">db</span> <span class="string">"Result of open-mail-db"</span><br /><span class="tab">&nbsp;</span><span class="word">folder-id</span><br /><span class="tab">&nbsp;</span><span class="word">columns</span> [<span class="word datatype"title="">block!</span>] <span class="string">"List of columns to return (must be non-empty)"</span><br /><span class="tab">&nbsp;</span><span class="refinement">/only</span> <span class="word">only-uids</span> <span class="string">"Only list specified messages"</span><br /><span class="tab">&nbsp;</span><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="ref"><span class="bra">&#9001;</span><a href="#section-3.6.1"><span class="code"><span class="word">list-mail-messages</span></span>' locals</a><span class="bra">&#9002;</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3.6">Return the headers for the messages contained in the folder identified by <span class="code"><span class="word">folder-id</span></span></a><span class="bra">&#9002;</span></span><br />]</p></div><p>The <span class="code"><span class="word">move-mail-message</span></span> and <span class="code"><span class="word">copy-mail-message</span></span> functions respectively move or copy a message
from a folder to another. The former function is a no-op if the destination folder is the same
as the current message folder; the latter creates a copy of the message in that case (that is,
after the copy the message will appear twice in the folder). <span class="code"><span class="word">copy-mail-message</span></span> returns the
message id of the copy.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Mail folders functions<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">move-mail-message:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">{Move a message from its current folder to another one}</span><br /><span class="tab">&nbsp;</span><span class="word">db</span> <span class="string">"Result of open-mail-db"</span><br /><span class="tab">&nbsp;</span><span class="word">message-id</span><br /><span class="tab">&nbsp;</span><span class="word">dest-folder-id</span><br /><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="ref"><span class="bra">&#9001;</span><a href="#section-3.11.1"><span class="code"><span class="word">move-mail-message</span></span>'s locals</a><span class="bra">&#9002;</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3.11">Move the message identified by <span class="code"><span class="word">message-id</span></span> to the folder identified by <span class="code"><span class="word">dest-folder-id</span></span></a><span class="bra">&#9002;</span></span><br />]<br /><br /><span class="set-word">copy-mail-message:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Copy a message to another folder"</span><br /><span class="tab">&nbsp;</span><span class="word">db</span> <span class="string">"Result of open-mail-db"</span><br /><span class="tab">&nbsp;</span><span class="word">message-id</span><br /><span class="tab">&nbsp;</span><span class="word">dest-folder-id</span><br /><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="ref"><span class="bra">&#9001;</span><a href="#section-3.8.1"><span class="code"><span class="word">create-mail-message</span></span>'s locals</a><span class="bra">&#9002;</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3.12">Create a new copy of the message identified by <span class="code"><span class="word">message-id</span></span> inside <span class="code"><span class="word">dest-folder-id</span></span> and return the message id of the copy</a><span class="bra">&#9002;</span></span><br />]</p></div><p><span class="code"><span class="word">compact-mail-folder</span></span> deletes the messages that have been marked for deletion;
only the messages contained in the folder <span class="code"><span class="word">folder-id</span></span> are affected.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Mail folders functions<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">compact-mail-folder:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">{Physically remove all the messages marked as deleted from a folder}</span><br /><span class="tab">&nbsp;</span><span class="word">db</span> <span class="string">"Result of open-mail-db"</span><br /><span class="tab">&nbsp;</span><span class="word">folder-id</span> <span class="string">"Folder to compact"</span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3.13">Remove all the messages in <span class="code"><span class="word">folder-id</span></span> which have the deleted flag</a><span class="bra">&#9002;</span></span><br />]</p></div><p>The <span class="code"><span class="word">create-mail-folder</span></span> function creates a new folder and returns its ID. Support
of nested folders may differ across IMAP server implementations; the function will throw
an error if the server does not allow creating the folder in the specified way.</p><p>The <span class="code"><span class="word">folder-name</span></span> MUST be UTF-8 encoded text.</p><p>If <span class="code"><span class="refinement">/with</span></span> is used, the function returns an object with <span class="code"><span class="word">folder-id</span></span> and <span class="code"><span class="word">flags</span></span>
containing the actual folder flags after creation (according to the IMAP server - may
be different from what was asked for). Currently, the only flag that can be set
on creation is <span class="code"><span class="lit-word">'children</span></span> (which asks for the folder to allow having subfolders);
some IMAP servers will in this case create a folder that cannot contain messages,
and in this case the function will not return the <span class="code"><span class="lit-word">'messages</span></span> flag in the result.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Mail folders functions<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">create-mail-folder:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Create a new mail folder"</span><br /><span class="tab">&nbsp;</span><span class="word">db</span> <span class="string">"Result of open-mail-db"</span><br /><span class="tab">&nbsp;</span><span class="word">parent-id</span> <span class="string">"ID of parent folder, none for root folder"</span><br /><span class="tab">&nbsp;</span><span class="word">folder-name</span> [<span class="word datatype"title="">string!</span>]<br /><span class="tab">&nbsp;</span><span class="refinement">/with</span> <span class="word">flags</span> [<span class="word datatype"title="">block!</span> <span class="word datatype"title="">none!</span>] <span class="string">{Set desired flags for the new folder (only CHILDREN really matters)}</span><br /><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="ref"><span class="bra">&#9001;</span><a href="#section-3.14.1"><span class="code"><span class="word">create-mail-folder</span></span>'s locals</a><span class="bra">&#9002;</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3.14">Create a new folder in the folder <span class="code"><span class="word">parent-id</span></span> and return its id</a><span class="bra">&#9002;</span></span><br />]</p></div><p>The <span class="code"><span class="word">empty-mail-folder</span></span> function destroys everything contained in a folder (including
subfolders). All messages and subfolders are lost and cannot be recovered; this function
should be used with great care, probably the UI should allow it only on a "Trashcan" folder.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Mail folders functions<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">empty-mail-folder:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Destroy the contents of a folder"</span><br /><span class="tab">&nbsp;</span><span class="word">db</span> <span class="string">"Result of open-mail-db"</span><br /><span class="tab">&nbsp;</span><span class="word">folder-id</span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3.15">Destroy the contents of <span class="code"><span class="word">folder-id</span></span></a><span class="bra">&#9002;</span></span><br />]</p></div><p>The <span class="code"><span class="word">delete-mail-folder</span></span> function deletes a folder and destroys its contents (including
subfolders). It is similar to <span class="code"><span class="word">empty-mail-folder</span></span>, but it removes the folder too. This
function should be used with great care; the UI should rather move folders inside a "Trashcan"
folder and then allow users to empty the trashcan.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Mail folders functions<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">delete-mail-folder:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Delete a mail folder"</span><br /><span class="tab">&nbsp;</span><span class="word">db</span> <span class="string">"Result of open-mail-db"</span><br /><span class="tab">&nbsp;</span><span class="word">folder-id</span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3.16">Destroy the contents of <span class="code"><span class="word">folder-id</span></span> and then remove <span class="code"><span class="word">folder-id</span></span></a><span class="bra">&#9002;</span></span><br />]</p></div><p><span class="code"><span class="word">move-mail-folder</span></span> moves a folder inside another folder. The function is a no-op if the
folder is already a subfolder of the destination folder. Not all IMAP servers allow
moving a folder inside another folder.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Mail folders functions<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">move-mail-folder:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Move a mail folder"</span><br /><span class="tab">&nbsp;</span><span class="word">db</span> <span class="string">"Result of open-mail-db"</span><br /><span class="tab">&nbsp;</span><span class="word">folder-id</span><br /><span class="tab">&nbsp;</span><span class="word">dest-folder-id</span><br /><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="ref"><span class="bra">&#9001;</span><a href="#section-3.17.1"><span class="code"><span class="word">move-mail-folder</span></span>'s locals</a><span class="bra">&#9002;</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3.17">Move <span class="code"><span class="word">folder-id</span></span> inside of <span class="code"><span class="word">dest-folder-id</span></span></a><span class="bra">&#9002;</span></span><br />]</p></div><p><span class="code"><span class="word">rename-mail-folder</span></span> changes the name of a folder. <span class="code"><span class="word">new-folder-name</span></span> is UTF-8 encoded
text.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Mail folders functions<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">rename-mail-folder:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Rename a mail folder"</span><br /><span class="tab">&nbsp;</span><span class="word">db</span> <span class="string">"Result of open-mail-db"</span><br /><span class="tab">&nbsp;</span><span class="word">folder-id</span><br /><span class="tab">&nbsp;</span><span class="word">new-folder-name</span> [<span class="word datatype"title="">string!</span>]<br /><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="ref"><span class="bra">&#9001;</span><a href="#section-3.18.1"><span class="code"><span class="word">rename-mail-folder</span></span>'s locals</a><span class="bra">&#9002;</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3.18">Change the name of <span class="code"><span class="word">folder-id</span></span> to <span class="code"><span class="word">new-folder-name</span></span></a><span class="bra">&#9002;</span></span><br />]</p></div><h4 id="section-2.2.1">2.2.1 Example usage</h4><p>An example of getting the list of messages in a folder, with each message
block containing the message sender, the subject and the size.</p><div class="code"><p><span class="set-word">messages:</span> <span class="word">list-mail-messages</span> <span class="word">db</span> <span class="word">folder-id</span> [<span class="word">from</span> <span class="word">subject</span> <span class="word">size</span>]</p></div><h3 id="section-2.3">2.3 Mail messages functions</h3><p>The <span class="code"><span class="word">create-mail-message</span></span> function stores <span class="code"><span class="word">message</span></span> into the folder identified by <span class="code"><span class="word">folder-id</span></span>.
<span class="code"><span class="word">message</span></span> should be a valid, standard Internet email message.</p><p>The function returns the ID that has been assigned to the newly created message.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Mail messages functions<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">create-mail-message:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Create a new mail message in a folder"</span><br /><span class="tab">&nbsp;</span><span class="word">db</span> <span class="string">"Result of open-mail-db"</span><br /><span class="tab">&nbsp;</span><span class="word">folder-id</span><br /><span class="tab">&nbsp;</span><span class="word">message</span> [<span class="word datatype"title="">string!</span>] <span class="string">"Message text"</span><br /><span class="tab">&nbsp;</span><span class="word">flags</span> [<span class="word datatype"title="">block!</span>] <span class="string">"Message flags"</span><br /><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="ref"><span class="bra">&#9001;</span><a href="#section-3.8.1"><span class="code"><span class="word">create-mail-message</span></span>'s locals</a><span class="bra">&#9002;</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3.8">Store the mail message <span class="code"><span class="word">message</span></span> inside the folder identified by <span class="code"><span class="word">folder-id</span></span></a><span class="bra">&#9002;</span></span><br />]</p></div><p><span class="code"><span class="word">get-mail-message</span></span> returns a standard REBOL email object (see notes above) given the <span class="code"><span class="word">message-id</span></span>.
When the <span class="code"><span class="refinement">/part</span></span> refinement is used, the value (or, if a block is passed, a block of values) specified
by <span class="code"><span class="word">part-name</span></span> is returned.
The <span class="code"><span class="word">part-name</span></span> argument can be one of (or a list of words from):</p><dl><dt>flags</dt><dd>the result is a block with the message's flags; see <span class="code"><span class="word">change-message-flags</span></span> below
for more details;
<dd><dt>source</dt><dd>the complete message source is returned (<span class="code"><span class="word datatype"title="">string!</span></span>);
<dd><dt>header</dt><dd>the message's header source is returned (<span class="code"><span class="word datatype"title="">string!</span></span>);
<dd><dt>text</dt><dd>the first message's displayable part is returned; if there are plain text and
HTML parts, HTML is given precedence; if the message is not multipart, the message's body
text is returned (<span class="code"><span class="word datatype"title="">string!</span></span>);
<dd><dt>text-plain</dt><dd>the first message's plain text part is returned; if the message is not multipart,
and the message's body is plain text, that is returned; if there are no plain text parts, <span class="code"><span class="word">none</span></span>
is returned (<span class="code"><span class="word datatype"title="">string!</span></span> or <span class="code"><span class="word datatype"title="">none!</span></span>);
<dd><dt>text-html</dt><dd>the first message's HTML part is returned; if the message is not multipart,
and the message's body is HTML, that is returned; if there are no HTML parts, <span class="code"><span class="word">none</span></span>
is returned (<span class="code"><span class="word datatype"title="">string!</span></span> or <span class="code"><span class="word datatype"title="">none!</span></span>);
<dd><dt>structure</dt><dd>the result is a block; the first value in the block is a <span class="code"><span class="word datatype"title="">word!</span></span> specifying
the multipart type if the message is multipart, otherwise it is <span class="code"><span class="word">none</span></span>; in the latter case,
<span class="code"><span class="word">none</span></span> is followed by the content type, the paramenters (eg. charset,
file name, etc.), the content id, the content description, the transfer encoding, and the size (encoded); in the former case, the <span class="code"><span class="word datatype"title="">word!</span></span>
is followed by one or more blocks, each one representing the structure of one part of the message;
each one of these blocks has the same structure as the main block, since messages can be nested;
<dd><dt>part/n</dt><dd>(this must be specified as a path because of the <span class="code"><span class="word">n</span></span> arugment) returns the
message's <span class="code"><span class="word">n</span></span>-th part; <span class="code"><span class="word">n</span></span> can be an <span class="code"><span class="word datatype"title="">integer!</span></span> or a <span class="code"><span class="word datatype"title="">tuple!</span></span> for nested parts;
<dd></dl><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Mail messages functions<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">get-mail-message:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Get the contents of a mail message"</span><br /><span class="tab">&nbsp;</span><span class="word">db</span> <span class="string">"Result of open-mail-db"</span><br /><span class="tab">&nbsp;</span><span class="word">message-id</span><br /><span class="tab">&nbsp;</span><span class="refinement">/part</span> <span class="string">"Return a specific part of the message"</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">part-name</span> [<span class="word datatype"title="">word!</span> <span class="word datatype"title="">path!</span> <span class="word datatype"title="">block!</span>] <span class="string">"Message part to return"</span><br /><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="ref"><span class="bra">&#9001;</span><a href="#section-3.10.1"><span class="code"><span class="word">get-mail-message</span></span>'s locals</a><span class="bra">&#9002;</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3.10">Return an object for the message identified by <span class="code"><span class="word">message-id</span></span></a><span class="bra">&#9002;</span></span><br />]</p></div><p><span class="code"><span class="word">change-message-flags</span></span> sets the flags for a message. <span class="code"><span class="word">flags</span></span> is a block of words.</p><dl><dt>read</dt><dd>message has been read.
<dd><dt>replied</dt><dd>message has been replied to.
<dd><dt>forwarded</dt><dd>message has been forwarded.
<dd><dt>deleted</dt><dd>message has been marked for deletion.
<dd><dt>flagged</dt><dd>message has been marked as special.
<dd></dl><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Mail messages functions<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">change-message-flags:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Change the flags for a message"</span><br /><span class="tab">&nbsp;</span><span class="word">db</span> <span class="string">"Result of open-mail-db"</span><br /><span class="tab">&nbsp;</span><span class="word">message-id</span><br /><span class="tab">&nbsp;</span><span class="word">flags</span> [<span class="word datatype"title="">block!</span>]<br /><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="ref"><span class="bra">&#9001;</span><a href="#section-3.9.1"><span class="code"><span class="word">change-message-flags</span></span>' locals</a><span class="bra">&#9002;</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3.9">Change the flags of the message identified by <span class="code"><span class="word">message-id</span></span> with <span class="code"><span class="word">flags</span></span></a><span class="bra">&#9002;</span></span><br />]</p></div><h3 id="section-2.4">2.4 Search function</h3><p>The <span class="code"><span class="word">search-mail-messages</span></span> function lists all the messages in the mail base that match the
search criteria specified in the <span class="code"><span class="word">criteria</span></span> argument. This is a tree where each leaf specifies
a "search key" to apply. The nodes containing the leafs specify the usual boolean operations
AND, OR and NOT.</p><p>Each node in the three is a block whose first value is a <span class="code"><span class="word datatype"title="">word!</span></span>. The word specifies the kind of
node; the following kinds are available (only a few are currently implemented - docs are out of date):</p><dl><dt>and</dt><dd>the content of the node is a list of sub-trees; the result of the search is the intersection
of the results of each subtree;
<dd><dt>or</dt><dd>the content of the node is a list of sub-trees; the result of the search is the union of the
results of each subtree;
<dd><dt>not</dt><dd>the content of the node is a sub-tree; the result of the search is the complement of the result
of the subtree;
<dd><dt>flag</dt><dd>the content of the node is a list of flags; the result of the search is the list of messages
that have all the specified flags set;
<dd><dt>bcc</dt><dd>the content of the node is a string; the result of the search is the list of messages where
this string is a substring of the message's BCC field;
<dd><dt>sent-before</dt><dd>the content of the node is a date; the result of the search is the list of messages that
were sent (the RFC-822 Date: header is used) on or before the given date;
<dd><dt>sent-after</dt><dd>the content of the node is a date; the result of the search is the list of messages that
were sent (the RFC-822 Date: header is used) on or after the given date;
<dd><dt>sent-on</dt><dd>the content of the node is a date; the result of the search is the list of messages that
were sent (the RFC-822 Date: header is used) on the given date;
<dd><dt>body</dt><dd>the content of the node is a string; the result of the search is the list of messages where
this string is a substring of the message's body text;
<dd><dt>cc</dt><dd>the content of the node is a string; the result of the search is the list of messages where
this string is a substring of the message's CC field;
<dd><dt>from</dt><dd>the content of the node is a string; the result of the search is the list of messages where
this string is a substring of the message's FROM field;
<dd><dt>header</dt><dd>the content of the node is two strings; the result of the search is the list of messages where
the second string is a substring of the message's header field whose name is specified by the first string;
<dd><dt>larger</dt><dd>the content of the node is an integer; the result of the search is the list of messages whose size
is greater or equal to the specified value;
<dd><dt>smaller</dt><dd>the content of the node is an integer; the result of the search is the list of messages whose size
is lesser or equal to the specified value;
<dd><dt>subject</dt><dd>the content of the node is a string; the result of the search is the list of messages where
this string is a substring of the message's SUBJECT field;
<dd><dt>text</dt><dd>the content of the node is a string; the result of the search is the list of messages where
this string is a substring of the message's source text (including header, body, and so on);
<dd><dt>to</dt><dd>the content of the node is a string; the result of the search is the list of messages where
this string is a substring of the message's TO field;
<dd></dl><p>This currently returns a list of message UIDs.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Search function<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">search-mail-messages:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"List the messages matching the search criteria"</span><br /><span class="tab">&nbsp;</span><span class="word">db</span> <span class="string">"Result of open-mail-db"</span><br /><span class="tab">&nbsp;</span><span class="word">folder-id</span><br /><span class="tab">&nbsp;</span><span class="word">criteria</span> [<span class="word datatype"title="">block!</span>] <span class="string">"Search criteria (see documentation)"</span><br /><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="ref"><span class="bra">&#9001;</span><a href="#section-3.19.1"><span class="code"><span class="word">search-mail-messages</span></span>'s locals</a><span class="bra">&#9002;</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3.19">Search the mail base for messages matching <span class="code"><span class="word">criteria</span></span></a><span class="bra">&#9002;</span></span><br />]</p></div><h4 id="section-2.4.1">2.4.1 Example usage</h4><p>The following example returns all messages whose subject contains "Qtask" and that were sent
on or before March 15th. Each message block will contain the sender, the subject and the size.</p><div class="code"><p><span class="set-word">messages:</span> <span class="word">search-mail-messages</span> <span class="word">db</span> <span class="word">folder-id</span> [<span class="word key"title="AND value1 value2">and</span> [<span class="word">subject</span> <span class="string">"Qtask"</span>] [<span class="word">sent-before</span> <span class="date">15-Mar-2007</span>]]</p></div></div><div class="section"><h2 id="section-3">3. Implementation</h2><p>This implementation of the above API uses an IMAP server as the storage engine.</p><h3 id="section-3.1">3.1 Open/initialize the mail database</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Open/initialize the mail database<span class="bra">&#9002;</span> &#8801;</p><p><span class="comment">; we need this because of SELECT-MAIL-DB below</span><br /><span class="word key"title="UNLESS condition block">unless</span> <span class="path"><span class="word">db</span>/<span class="word">port</span></span> [<br /><span class="tab">&nbsp;</span><span class="set-path">db/port:</span> <span class="word key"title="EITHER condition true-block false-block">either</span> <span class="path"><span class="word">db</span>/<span class="word key"title="SECURE 'level">secure</span></span> [<span class="integer">993</span>] [<span class="integer">143</span>]<br />]<br /><span class="word key"title="ANY block">any</span> [<br /><span class="tab">&nbsp;</span><span class="path"><span class="word">select-mail-db</span>/<span class="word">bump</span></span> <span class="word">db</span><br /><span class="tab">&nbsp;</span><span class="word">append-mail-db</span> <span class="word key"title="CONTEXT blk">context</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">imap-port:</span> <span class="word">open-port</span> <span class="word">db</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">selected-mailbox:</span> <span class="word">none</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">select-response:</span> <span class="word">none</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">refcount:</span> <span class="integer">1</span><br /><span class="tab">&nbsp;</span>]<br />]</p></div><h3 id="section-3.2">3.2 Validate the given IMAP settings</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Validate the given IMAP settings<span class="bra">&#9002;</span> &#8801;</p><p><span class="word key"title="NOT value">not</span> <span class="word key"title="ERROR? value">error?</span> <span class="word key"title="TRY block">try</span> [<br /><span class="tab">&nbsp;</span><span class="word">check-mail-db</span> <span class="word">db</span><br />]</p></div><h3 id="section-3.3">3.3 Check IMAP settings, throw error, or return true if all is ok</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Check IMAP settings, throw error, or return true if all is ok<span class="bra">&#9002;</span> &#8801;</p><p><span class="comment">; we need this because of SELECT-MAIL-DB below</span><br /><span class="word key"title="UNLESS condition block">unless</span> <span class="path"><span class="word">db</span>/<span class="word">port</span></span> [<br /><span class="tab">&nbsp;</span><span class="set-path">db/port:</span> <span class="word key"title="EITHER condition true-block false-block">either</span> <span class="path"><span class="word">db</span>/<span class="word key"title="SECURE 'level">secure</span></span> [<span class="integer">993</span>] [<span class="integer">143</span>]<br />]<br /><span class="comment">; if it's already open, then it is valid</span><br /><span class="word key"title="UNLESS condition block">unless</span> <span class="word">select-mail-db</span> <span class="word">db</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">db:</span> <span class="word">open-port</span> <span class="word">db</span><br /><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word">db</span> [<span class="word">LIST</span> <span class="string">""</span> <span class="string">"*"</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">db</span><br /><span class="tab">&nbsp;</span><span class="word key"title="CLOSE port">close</span> <span class="word">db</span><br />]<br /><span class="word">true</span></p></div><h3 id="section-3.4">3.4 Check the IMAP connection, reopen it if necessary</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Check the IMAP connection, reopen it if necessary<span class="bra">&#9002;</span> &#8801;</p><p><span class="word key"title="UNLESS condition block">unless</span> <span class="set-word">db:</span> <span class="word">pick-mail-db</span> <span class="word">db</span> [<span class="word key"title="RETURN value">return</span> <span class="word">false</span>]<br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="ERROR? value">error?</span> <span class="word key"title="TRY block">try</span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> [<span class="word">NOOP</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="word key"title="ATTEMPT value">attempt</span> [<span class="word key"title="CLOSE port">close</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span>]<br /><span class="tab">&nbsp;</span><span class="set-path">db/selected-mailbox:</span> <span class="set-path">db/select-response:</span> <span class="word">none</span><br /><span class="tab">&nbsp;</span><span class="set-path">db/imap-port:</span> <span class="word key"title="OPEN spec /binary /string /direct /seek /new /read /write /no-wait /lines /with end-of-line /allow access /mode args /custom params /skip length">open</span> <span class="word key"title="COMPOSE value /deep /only">compose</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">scheme:</span> (<span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">lit-word!</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span>/<span class="word">scheme</span></span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">host:</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span>/<span class="word">host</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">user:</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span>/<span class="word">user</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">pass:</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span>/<span class="word">pass</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">port-id:</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span>/<span class="word">port-id</span></span><br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="word">true</span></p></div><h3 id="section-3.5">3.5 Close the mail database</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Close the mail database<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">db:</span> <span class="word">pick-mail-db</span> <span class="word">db</span><br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="integer">0</span> <span class="word key"title="= value1 value2">=</span> <span class="set-path">db/refcount:</span> <span class="word key"title="MAX value1 value2">max</span> <span class="integer">0</span> <span class="path"><span class="word">db</span>/<span class="word">refcount</span></span> <span class="word key"title="- value1 value2">-</span> <span class="integer">1</span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="ATTEMPT value">attempt</span> [<span class="word key"title="CLOSE port">close</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span>]<br />]<br /><span class="word">none</span></p></div><h3 id="section-3.6">3.6 Return the headers for the messages contained in the folder identified by <span class="code"><span class="word">folder-id</span></span></h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Return the headers for the messages contained in the folder identified by <span class="code"><span class="word">folder-id</span></span><span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">db:</span> <span class="word">pick-mail-db</span> <span class="word">db</span><br /><span class="word">select-mailbox</span> <span class="word">db</span> <span class="word">folder-id</span><br /><span class="set-word">message-count:</span> <span class="integer">0</span><br /><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="path"><span class="word">db</span>/<span class="word">select-response</span></span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="ANY block">any</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<span class="lit-word">'*</span> <span class="word datatype"title="">integer!</span> <span class="lit-word">'EXISTS</span> <span class="set-word">message-count:</span> (<span class="set-word">message-count:</span> <span class="path"><span class="word">message-count</span>/<span class="integer">-2</span></span>) <span class="word key"title="TO type spec">to</span> <span class="word">end</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<span class="word datatype"title="">word!</span> <span class="lit-word">'OK</span> <span class="word">into</span> [<span class="lit-word">'UIDVALIDITY</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">uidvalidity</span> <span class="word datatype"title="">integer!</span>] <span class="word datatype"title="">string!</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SKIP series offset">skip</span><br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="set-word">result:</span> <span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">block!</span> <span class="integer">256</span><br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word">message-count</span> <span class="word key"title="&lt; value1 value2">&lt;</span> <span class="integer">1</span> [<span class="word key"title="RETURN value">return</span> <span class="word">result</span>]<br /><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="BLOCK? value">block?</span> <span class="word">only-uids</span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="EMPTY? series">empty?</span> <span class="word">only-uids</span> [<span class="word key"title="RETURN value">return</span> <span class="word">result</span>]<br /><span class="tab">&nbsp;</span><span class="set-word">non-deleted:</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">only-uids</span><br /><span class="tab">&nbsp;</span><span class="word key"title="SORT series /case /skip size /compare comparator /part length /all /reverse">sort</span> <span class="word">non-deleted</span><br />] [<br /><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> [<span class="word">SEARCH</span> <span class="word">UNDELETED</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="ANY block">any</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<span class="lit-word">'*</span> <span class="lit-word">'SEARCH</span> <span class="set-word">non-deleted:</span> <span class="word">some</span> <span class="word datatype"title="">integer!</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SKIP series offset">skip</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="ANY block">any</span> [<span class="word key"title="NOT value">not</span> <span class="word key"title="BLOCK? value">block?</span> <span class="word">non-deleted</span> <span class="word key"title="EMPTY? series">empty?</span> <span class="word">non-deleted</span>] [<span class="word key"title="RETURN value">return</span> <span class="word">result</span>]<br />]<br /><span class="set-word">list:</span> <span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">issue!</span> <span class="integer">256</span><br /><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word">non-deleted</span> [<br /><span class="tab">&nbsp;</span><span class="word">some</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SET word value /any /pad">set</span> <span class="word">start-index</span> <span class="word datatype"title="">integer!</span> (<span class="set-word">end-index:</span> <span class="word">start-index</span>) [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">some</span> [(<span class="set-word">end-index:</span> <span class="word">end-index</span> <span class="word key"title="+ value1 value2">+</span> <span class="integer">1</span>) <span class="integer">1</span> <span class="integer">1</span> <span class="word">end-index</span>] (<span class="word key"title="REPEND series value /only">repend</span> <span class="word">list</span> [<span class="word">start-index</span> <span class="char">#":"</span> <span class="word">end-index</span> <span class="word key"title="- value1 value2">-</span> <span class="integer">1</span> <span class="char">#","</span>])<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<span class="word key"title="REPEND series value /only">repend</span> <span class="word">list</span> [<span class="word">start-index</span> <span class="char">#","</span>])<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="word key"title="REMOVE series /part range">remove</span> <span class="word key"title="BACK series">back</span> <span class="word key"title="TAIL series">tail</span> <span class="word">list</span><br /><span class="set-word">message:</span> <span class="word key"title="CONTEXT blk">context</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">id:</span> <span class="lit-word">'UID</span><br /><span class="tab">&nbsp;</span><span class="set-word">from:</span> <span class="lit-word">'ENVELOPE</span><br /><span class="tab">&nbsp;</span><span class="set-word">to:</span> <span class="lit-word">'ENVELOPE</span><br /><span class="tab">&nbsp;</span><span class="set-word">cc:</span> <span class="lit-word">'ENVELOPE</span><br /><span class="tab">&nbsp;</span><span class="set-word">subject:</span> <span class="lit-word">'ENVELOPE</span><br /><span class="tab">&nbsp;</span><span class="set-word">size:</span> <span class="lit-word">'RFC822.SIZE</span><br /><span class="tab">&nbsp;</span><span class="set-word">flags:</span> <span class="lit-word">'FLAGS</span><br /><span class="tab">&nbsp;</span><span class="set-word">date:</span> <span class="lit-word">'ENVELOPE</span><br /><span class="tab">&nbsp;</span><span class="set-word">received:</span> <span class="lit-word">'INTERNALDATE</span><br /><span class="tab">&nbsp;</span><span class="set-word">sender:</span> <span class="lit-word">'ENVELOPE</span><br /><span class="tab">&nbsp;</span><span class="set-word">reply-to:</span> <span class="lit-word">'ENVELOPE</span><br /><span class="tab">&nbsp;</span><span class="set-word">bcc:</span> <span class="lit-word">'ENVELOPE</span><br /><span class="tab">&nbsp;</span><span class="set-word">in-reply-to:</span> <span class="lit-word">'ENVELOPE</span><br /><span class="tab">&nbsp;</span><span class="set-word">message-id:</span> <span class="lit-word">'ENVELOPE</span><br /><span class="tab">&nbsp;</span><span class="set-word">has-attachments:</span> <span class="lit-word">'BODY</span><br /><span class="tab">&nbsp;</span><span class="set-word">structure:</span> <span class="lit-word">'BODY</span><br />]<br /><span class="set-word">columns:</span> <span class="word key"title="USE words body">use</span> <span class="word">columns</span> <span class="word key"title="REDUCE value /only words">reduce</span> [<span class="word">columns</span>]<br /><span class="word key"title="SET word value /any /pad">set</span> <span class="word">columns</span> <span class="word">none</span><br /><span class="word key"title="BIND words known-word /copy">bind</span> <span class="word">columns</span> <span class="word">message</span><br /><span class="set-word">fetch-columns:</span> <span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">paren!</span> <span class="word key"title="REPLACE target search replace /all /case">replace</span> <span class="word key"title="UNIQUE set /case /skip size">unique</span> <span class="word key"title="REDUCE value /only words">reduce</span> <span class="word">columns</span> <span class="word">none</span> [ ]<br /><span class="word key"title="WHILE cond-block body-block">while</span> [<span class="word key"title="NOT value">not</span> <span class="word key"title="EMPTY? series">empty?</span> <span class="word">list</span>] [<br /><span class="tab">&nbsp;</span><span class="set-word">list-end:</span> <span class="word key"title="AT series index">at</span> <span class="word">list</span> <span class="integer">256</span><br /><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="EMPTY? series">empty?</span> <span class="word">list-end</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">list-part:</span> <span class="word">list</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">list:</span> <span class="word">list-end</span><br /><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">list-end:</span> <span class="word key"title="ANY block">any</span> [<span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span> <span class="word">list-end</span> <span class="char">#","</span> <span class="word key"title="TAIL series">tail</span> <span class="word">list-end</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">list-part:</span> <span class="path"><span class="word key"title="COPY value /part range /deep">copy</span>/<span class="word">part</span></span> <span class="word">list</span> <span class="word">list-end</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">list:</span> <span class="word key"title="NEXT series">next</span> <span class="word">list-end</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="HEAD series">head</span> <span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word key"title="COMPOSE value /deep /only">compose</span>/<span class="word">only</span></span> [<span class="word">FETCH</span> (<span class="word">list-part</span>) (<span class="word">fetch-columns</span>)] <span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="BLOCK? value">block?</span> <span class="word">only-uids</span> [<span class="lit-word">'UID</span>] [[ ]]<br /><span class="tab">&nbsp;</span><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word key"title="BIND words known-word /copy">bind</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="ANY block">any</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SET word value /any /pad">set</span> <span class="word">message</span> <span class="word">none</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="FOREACH 'word data body">foreach</span> <span class="word">w</span> [<span class="word">from</span> <span class="word key"title="TO type spec">to</span> <span class="word">cc</span> <span class="word">sender</span> <span class="word">reply-to</span> <span class="word">bcc</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SET word value /any /pad">set</span> <span class="word">w</span> <span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">block!</span> <span class="integer">4</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'*</span> <span class="word datatype"title="">integer!</span> <span class="lit-word">'FETCH</span> <span class="word">into</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="ANY block">any</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'ENVELOPE</span> <span class="word">into</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<span class="word key"title="SET word value /any /pad">set</span> <span class="word">date</span> [<span class="word datatype"title="">string!</span> <span class="word">|</span> <span class="word datatype"title="">date!</span> <span class="word">|</span> <span class="word datatype"title="">binary!</span> <span class="word">|</span> <span class="word datatype"title="">none!</span>]]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SET word value /any /pad">set</span> <span class="word">subject</span> [<span class="word datatype"title="">string!</span> <span class="word">|</span> <span class="word datatype"title="">binary!</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<span class="set-word">subject:</span> <span class="word">decode-email-field</span> <span class="word key"title="AS-STRING string">as-string</span> <span class="word">subject</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word datatype"title="">none!</span> (<span class="set-word">subject:</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="string">""</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<span class="word">into</span> [<span class="word key"title="ANY block">any</span> [<span class="word key"title="SET word value /any /pad">set</span> <span class="word">address</span> <span class="word datatype"title="">paren!</span> (<span class="word">append-email</span> <span class="word">from</span> <span class="word">address</span>)]] <span class="word">|</span> <span class="word datatype"title="">none!</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<span class="word">into</span> [<span class="word key"title="ANY block">any</span> [<span class="word key"title="SET word value /any /pad">set</span> <span class="word">address</span> <span class="word datatype"title="">paren!</span> (<span class="word">append-email</span> <span class="word">sender</span> <span class="word">address</span>)]] <span class="word">|</span> <span class="word datatype"title="">none!</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<span class="word">into</span> [<span class="word key"title="ANY block">any</span> [<span class="word key"title="SET word value /any /pad">set</span> <span class="word">address</span> <span class="word datatype"title="">paren!</span> (<span class="word">append-email</span> <span class="word">reply-to</span> <span class="word">address</span>)]] <span class="word">|</span> <span class="word datatype"title="">none!</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<span class="word">into</span> [<span class="word key"title="ANY block">any</span> [<span class="word key"title="SET word value /any /pad">set</span> <span class="word">address</span> <span class="word datatype"title="">paren!</span> (<span class="word">append-email</span> <span class="word key"title="TO type spec">to</span> <span class="word">address</span>)]] <span class="word">|</span> <span class="word datatype"title="">none!</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<span class="word">into</span> [<span class="word key"title="ANY block">any</span> [<span class="word key"title="SET word value /any /pad">set</span> <span class="word">address</span> <span class="word datatype"title="">paren!</span> (<span class="word">append-email</span> <span class="word">cc</span> <span class="word">address</span>)]] <span class="word">|</span> <span class="word datatype"title="">none!</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<span class="word">into</span> [<span class="word key"title="ANY block">any</span> [<span class="word key"title="SET word value /any /pad">set</span> <span class="word">address</span> <span class="word datatype"title="">paren!</span> (<span class="word">append-email</span> <span class="word">bcc</span> <span class="word">address</span>)]] <span class="word">|</span> <span class="word datatype"title="">none!</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<span class="word key"title="SET word value /any /pad">set</span> <span class="word">in-reply-to</span> <span class="word datatype"title="">string!</span> (<span class="set-word">in-reply-to:</span> <span class="word">decode-email-field</span> <span class="word">in-reply-to</span>) <span class="word">|</span> <span class="word datatype"title="">none!</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<span class="word key"title="SET word value /any /pad">set</span> <span class="word">message-id</span> <span class="word datatype"title="">string!</span> (<span class="set-word">message-id:</span> <span class="word">decode-email-field</span> <span class="word">message-id</span>) <span class="word">|</span> <span class="word datatype"title="">none!</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="TO type spec">to</span> <span class="word">end</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'RFC822.SIZE</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">size</span> <span class="word datatype"title="">integer!</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'UID</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">id</span> <span class="word datatype"title="">integer!</span> (<span class="set-word">id:</span> <span class="word key"title="REDUCE value /only words">reduce</span> [<span class="word">folder-id</span> <span class="word">uidvalidity</span> <span class="word">id</span>])<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'FLAGS</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">flags</span> <span class="word datatype"title="">paren!</span> (<span class="set-word">flags:</span> <span class="word">from-imap-flags</span> <span class="word">flags</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'INTERNALDATE</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">received</span> <span class="word datatype"title="">date!</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'BODY</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">structure</span> <span class="word datatype"title="">paren!</span> (<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">has-attachments:</span> <span class="word">has-attachments?</span> <span class="set-word">structure:</span> <span class="word">parse-bodystructure</span> <span class="word">structure</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<span class="path"><span class="word key"title="REPEND series value /only">repend</span>/<span class="word">only</span></span> <span class="word">result</span> <span class="word">columns</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'*</span> <span class="lit-word">'OK</span> <span class="word">into</span> [<span class="lit-word">'PARSE</span>] <span class="word datatype"title="">string!</span> <span class="comment">; parse error with the message... not sure how to report it?</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> <span class="word">ok-response</span><br /><span class="tab">&nbsp;</span>] <span class="word">message</span><br />]<br /><span class="word">result</span></p></div><h4 id="section-3.6.1">3.6.1 <span class="code"><span class="word">list-mail-messages</span></span>' locals</h4><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">list-mail-messages</span></span>' locals<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">result</span> <span class="word">message</span> <span class="word">address</span> <span class="word">message-count</span> <span class="word">uidvalidity</span> <span class="word">non-deleted</span> <span class="word">list</span><br /><span class="word">start-index</span> <span class="word">end-index</span> <span class="word">list-part</span> <span class="word">fetch-columns</span> <span class="word">list-end</span></p></div><h3 id="section-3.7">3.7 Return the total number of messages and the number of unread messages in the folder</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Return the total number of messages and the number of unread messages in the folder<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">db:</span> <span class="word">pick-mail-db</span> <span class="word">db</span><br /><span class="word">select-mailbox</span> <span class="word">db</span> <span class="word">folder-id</span><br /><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="path"><span class="word">db</span>/<span class="word">select-response</span></span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="ANY block">any</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'*</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">value</span> <span class="word datatype"title="">integer!</span> <span class="lit-word">'EXISTS</span> (<span class="set-word">total:</span> <span class="word">value</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SKIP series offset">skip</span><br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> [<span class="word">SEARCH</span> <span class="word">UNDELETED</span> <span class="word">UNSEEN</span>]<br /><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="ANY block">any</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<span class="lit-word">'*</span> <span class="lit-word">'SEARCH</span> <span class="set-word">unseen:</span> <span class="word">some</span> <span class="word datatype"title="">integer!</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SKIP series offset">skip</span><br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="word key"title="UNLESS condition block">unless</span> <span class="word key"title="BLOCK? value">block?</span> <span class="word">unseen</span> [<span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">error!</span> <span class="string">"Unable to get number of unread messages"</span>]<br /><span class="word key"title="REDUCE value /only words">reduce</span> [<span class="word">total</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">unseen</span>]</p></div><h4 id="section-3.7.1">3.7.1 <span class="code"><span class="word">get-messages-count</span></span>'s locals</h4><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">get-messages-count</span></span>'s locals<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">value</span> <span class="word">total</span> <span class="word">unseen</span></p></div><h3 id="section-3.8">3.8 Store the mail message <span class="code"><span class="word">message</span></span> inside the folder identified by <span class="code"><span class="word">folder-id</span></span></h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Store the mail message <span class="code"><span class="word">message</span></span> inside the folder identified by <span class="code"><span class="word">folder-id</span></span><span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">db:</span> <span class="word">pick-mail-db</span> <span class="word">db</span><br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="NOT value">not</span> <span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span>/<span class="word">locals</span>/<span class="word">capabilities</span></span> <span class="lit-word">'UIDPLUS</span> [<br /><span class="tab">&nbsp;</span><span class="word">select-mailbox</span> <span class="word">db</span> <span class="word">folder-id</span><br /><span class="tab">&nbsp;</span><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="path"><span class="word">db</span>/<span class="word">select-response</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="ANY block">any</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'*</span> <span class="lit-word">'OK</span> <span class="word">into</span> [<span class="lit-word">'UIDVALIDITY</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">uidvalidity</span> <span class="word datatype"title="">integer!</span>] <span class="word datatype"title="">string!</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'*</span> <span class="lit-word">'OK</span> <span class="word">into</span> [<span class="lit-word">'UIDNEXT</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">uid</span> <span class="word datatype"title="">integer!</span>] <span class="word datatype"title="">string!</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SKIP series offset">skip</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="path"><span class="word key"title="COMPOSE value /deep /only">compose</span>/<span class="word">only</span></span> [<span class="word key"title="APPEND series value /only">APPEND</span> (<span class="word">folder-id</span>) (<span class="word">to-imap-flags</span> <span class="word">flags</span>) (<span class="word">message</span>)]<br /><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="ALL block">all</span> [<span class="word">uidvalidity</span> <span class="word">uid</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">some</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<span class="word datatype"title="">word!</span> <span class="lit-word">'OK</span> <span class="word">into</span> [<span class="lit-word">'APPENDUID</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">uidvalidity</span> <span class="word datatype"title="">integer!</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">uid</span> <span class="word datatype"title="">integer!</span>] <span class="word datatype"title="">string!</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SKIP series offset">skip</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>] <br />]<br /><span class="word key"title="REDUCE value /only words">reduce</span> [<span class="word">folder-id</span> <span class="word">uidvalidity</span> <span class="word">uid</span>]</p></div><h4 id="section-3.8.1">3.8.1 <span class="code"><span class="word">create-mail-message</span></span>'s locals</h4><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">create-mail-message</span></span>'s locals<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">uidvalidity</span> <span class="word">uid</span></p></div><h3 id="section-3.9">3.9 Change the flags of the message identified by <span class="code"><span class="word">message-id</span></span> with <span class="code"><span class="word">flags</span></span></h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Change the flags of the message identified by <span class="code"><span class="word">message-id</span></span> with <span class="code"><span class="word">flags</span></span><span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">db:</span> <span class="word">pick-mail-db</span> <span class="word">db</span><br /><span class="word">select-mailbox</span> <span class="word">db</span> <span class="path"><span class="word">message-id</span>/<span class="integer">1</span></span><br /><span class="comment">; TODO: check uidvalidity!</span><br /><span class="set-word">command:</span> <span class="path"><span class="word key"title="SWITCH value cases /default case">switch</span>/<span class="word">default</span></span> <span class="path"><span class="word">flags</span>/<span class="integer">1</span></span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="+ value1 value2">+</span> [<span class="lit-word">'+FLAGS.SILENT</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="- value1 value2">-</span> [<span class="lit-word">'-FLAGS.SILENT</span>]<br />] [<br /><span class="tab">&nbsp;</span><span class="lit-word">'FLAGS.SILENT</span><br />]<br /><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="path"><span class="word key"title="COMPOSE value /deep /only">compose</span>/<span class="word">only</span></span> [<span class="word">UID</span> <span class="word">STORE</span> (<span class="path"><span class="word">message-id</span>/<span class="integer">3</span></span>) (<span class="word">command</span>) (<span class="word">to-imap-flags</span> <span class="word">flags</span>)]<br /><span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span><br /><span class="word">true</span></p></div><h4 id="section-3.9.1">3.9.1 <span class="code"><span class="word">change-message-flags</span></span>' locals</h4><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">change-message-flags</span></span>' locals<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">command</span></p></div><h3 id="section-3.10">3.10 Return an object for the message identified by <span class="code"><span class="word">message-id</span></span></h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Return an object for the message identified by <span class="code"><span class="word">message-id</span></span><span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">db:</span> <span class="word">pick-mail-db</span> <span class="word">db</span><br /><span class="word">select-mailbox</span> <span class="word">db</span> <span class="path"><span class="word">message-id</span>/<span class="integer">1</span></span><br /><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word">part</span> [<br /><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="SWITCH value cases /default case">switch</span>/<span class="word">default</span></span> <span class="word">part-name</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SOURCE 'word">source</span> [<span class="set-word">part-name:</span> <span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">path!</span> [<span class="word">BODY.PEEK</span> <span class="string">""</span>] <span class="set-word">result:</span> <span class="lit-word">'message</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">header</span> [<span class="set-word">part-name:</span> <span class="lit-word">'RFC822.HEADER</span> <span class="set-word">result:</span> <span class="lit-word">'message</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">structure</span> [<span class="set-word">part-name:</span> <span class="lit-word">'BODY</span> <span class="set-word">result:</span> <span class="lit-word">'structure</span>]<br /><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="PATH? value">path?</span> <span class="word">part-name</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">part-name/1:</span> <span class="lit-word">'BODY.PEEK</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="comment">; hack...</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">part-name:</span> <span class="word key"title="FORM value">form</span> <span class="word">part-name</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="REPLACE target search replace /all /case">replace</span>/<span class="word key"title="ALL block">all</span></span> <span class="path"><span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span>/<span class="word key"title="TAIL series">tail</span></span> <span class="word">part-name</span> <span class="string">"/"</span> <span class="string">"/"</span> <span class="string">"."</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">part-name:</span> <span class="word key"title="LOAD source /header /next /library /markup /all">load</span> <span class="word">part-name</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">result:</span> <span class="lit-word">'message</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br />] [<br /><span class="tab">&nbsp;</span><span class="set-word">part-name:</span> <span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">path!</span> [<span class="word">BODY.PEEK</span> <span class="string">""</span>]<br /><span class="tab">&nbsp;</span><span class="set-word">result:</span> <span class="lit-word">'message</span><br />]<br /><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word key"title="COMPOSE value /deep /only">compose</span> [<span class="word">UID</span> <span class="word">FETCH</span> (<span class="path"><span class="word">message-id</span>/<span class="integer">3</span></span>) (<span class="word">part-name</span>)]<br /><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> [<br /><span class="tab">&nbsp;</span><span class="word">some</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'*</span> <span class="word datatype"title="">integer!</span> <span class="lit-word">'FETCH</span> <span class="word">into</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="ANY block">any</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<span class="lit-word">'RFC822</span> <span class="word">|</span> <span class="lit-word">'RFC822.HEADER</span> <span class="word">|</span> <span class="word datatype"title="">path!</span>] <span class="word key"title="SET word value /any /pad">set</span> <span class="word">message</span> [<span class="word datatype"title="">string!</span> <span class="word">|</span> <span class="word datatype"title="">binary!</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'FLAGS</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">flags</span> <span class="word datatype"title="">paren!</span> (<span class="set-word">flags:</span> <span class="word">from-imap-flags</span> <span class="word">flags</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'BODY</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">structure</span> <span class="word datatype"title="">paren!</span> (<span class="set-word">structure:</span> <span class="word">parse-bodystructure</span> <span class="word">structure</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'UID</span> <span class="word datatype"title="">integer!</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'*</span> <span class="lit-word">'OK</span> <span class="word">into</span> [<span class="lit-word">'PARSE</span>] <span class="word datatype"title="">string!</span> <span class="comment">; parse error with the message... not sure how to report it?</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word">into</span> <span class="word">ok-response</span><br />]<br /><span class="word key"title="GET word /any">get</span> <span class="word">result</span></p></div><h4 id="section-3.10.1">3.10.1 <span class="code"><span class="word">get-mail-message</span></span>'s locals</h4><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">get-mail-message</span></span>'s locals<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">message</span> <span class="word">flags</span> <span class="word">structure</span> <span class="word">i</span> <span class="word">type</span> <span class="word">result</span></p></div><h3 id="section-3.11">3.11 Move the message identified by <span class="code"><span class="word">message-id</span></span> to the folder identified by <span class="code"><span class="word">dest-folder-id</span></span></h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Move the message identified by <span class="code"><span class="word">message-id</span></span> to the folder identified by <span class="code"><span class="word">dest-folder-id</span></span><span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">new-id:</span> <span class="word">copy-mail-message</span> <span class="word">db</span> <span class="word">message-id</span> <span class="word">dest-folder-id</span><br /><span class="word">change-message-flags</span> <span class="word">db</span> <span class="word">message-id</span> [<span class="word key"title="+ value1 value2">+</span> <span class="word">Deleted</span>]<br /><span class="word">new-id</span></p></div><h4 id="section-3.11.1">3.11.1 <span class="code"><span class="word">move-mail-message</span></span>'s locals</h4><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">move-mail-message</span></span>'s locals<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">new-id</span></p></div><h3 id="section-3.12">3.12 Create a new copy of the message identified by <span class="code"><span class="word">message-id</span></span> inside <span class="code"><span class="word">dest-folder-id</span></span> and return the message id of the copy</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Create a new copy of the message identified by <span class="code"><span class="word">message-id</span></span> inside <span class="code"><span class="word">dest-folder-id</span></span> and return the message id of the copy<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">db:</span> <span class="word">pick-mail-db</span> <span class="word">db</span><br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="NOT value">not</span> <span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span>/<span class="word">locals</span>/<span class="word">capabilities</span></span> <span class="lit-word">'UIDPLUS</span> [<br /><span class="tab">&nbsp;</span><span class="word">select-mailbox</span> <span class="word">db</span> <span class="word">dest-folder-id</span><br /><span class="tab">&nbsp;</span><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="path"><span class="word">db</span>/<span class="word">select-response</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="ANY block">any</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'*</span> <span class="lit-word">'OK</span> <span class="word">into</span> [<span class="lit-word">'UIDVALIDITY</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">dest-uidvalidity</span> <span class="word datatype"title="">integer!</span>] <span class="word datatype"title="">string!</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'*</span> <span class="lit-word">'OK</span> <span class="word">into</span> [<span class="lit-word">'UIDNEXT</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">new-uid</span> <span class="word datatype"title="">integer!</span>] <span class="word datatype"title="">string!</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SKIP series offset">skip</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="word">select-mailbox</span> <span class="word">db</span> <span class="path"><span class="word">message-id</span>/<span class="integer">1</span></span><br /><span class="comment">; TODO: check uidvalidity!</span><br /><span class="set-word">old-uid:</span> <span class="path"><span class="word">message-id</span>/<span class="integer">3</span></span><br /><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word key"title="COMPOSE value /deep /only">compose</span> [<span class="word">UID</span> <span class="word key"title="COPY value /part range /deep">COPY</span> (<span class="word">old-uid</span>) (<span class="word">dest-folder-id</span>)]<br /><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="ALL block">all</span> [<span class="word">dest-uidvalidity</span> <span class="word">new-uid</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="ANY block">any</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word datatype"title="">word!</span> <span class="lit-word">'OK</span> <span class="word">into</span> [<span class="lit-word">'COPYUID</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">dest-uidvalidity</span> <span class="word datatype"title="">integer!</span> <span class="integer">1</span> <span class="integer">1</span> <span class="word">old-uid</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">new-uid</span> <span class="word datatype"title="">integer!</span>] <span class="word datatype"title="">string!</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] <br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span> <br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SKIP series offset">skip</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="word key"title="REDUCE value /only words">reduce</span> [<span class="word">dest-folder-id</span> <span class="word">dest-uidvalidity</span> <span class="word">new-uid</span>]</p></div><h4 id="section-3.12.1">3.12.1 <span class="code"><span class="word">copy-mail-message</span></span>'s locals</h4><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">create-mail-message</span></span>'s locals<span class="bra">&#9002;</span> +&#8801;</p><p><span class="word">dest-uidvalidity</span> <span class="word">old-uid</span> <span class="word">new-uid</span></p></div><h3 id="section-3.13">3.13 Remove all the messages in <span class="code"><span class="word">folder-id</span></span> which have the deleted flag</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Remove all the messages in <span class="code"><span class="word">folder-id</span></span> which have the deleted flag<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">db:</span> <span class="word">pick-mail-db</span> <span class="word">db</span><br /><span class="word">select-mailbox</span> <span class="word">db</span> <span class="word">folder-id</span><br /><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> [<span class="word">EXPUNGE</span>]<br /><span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span><br /><span class="word">true</span></p></div><h3 id="section-3.14">3.14 Create a new folder in the folder <span class="code"><span class="word">parent-id</span></span> and return its id</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Create a new folder in the folder <span class="code"><span class="word">parent-id</span></span> and return its id<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">db:</span> <span class="word">pick-mail-db</span> <span class="word">db</span><br /><span class="set-word">delimiter:</span> <span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="ANY block">any</span> [<span class="set-word">children:</span> <span class="word key"title="ALL block">all</span> [<span class="word">flags</span> <span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span> <span class="word">flags</span> <span class="lit-word">'children</span>] <span class="word">parent-id</span>] [<span class="word">get-delimiter</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word key"title="ANY block">any</span> [<span class="word">parent-id</span> <span class="string">""</span>]]<br /><span class="set-word">folder-name:</span> <span class="word">encode-text</span> <span class="word">folder-name</span> <span class="lit-word">'utf-7-imap</span><br /><span class="set-word">name:</span> <span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word">parent-id</span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="REJOIN block">rejoin</span> [<span class="word">parent-id</span> <span class="word">delimiter</span> <span class="word">folder-name</span>]<br />] [<br /><span class="tab">&nbsp;</span><span class="word">folder-name</span><br />]<br /><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word key"title="COMPOSE value /deep /only">compose</span> [<span class="word">CREATE</span> (<span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word">children</span> [<span class="word key"title="APPEND series value /only">append</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">name</span> <span class="word">delimiter</span>] [<span class="word">name</span>])]<br /><span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span><br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word">flags</span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word key"title="COMPOSE value /deep /only">compose</span> [<span class="word">LIST</span> <span class="string">""</span> (<span class="word">name</span>)]<br /><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<span class="lit-word">'*</span> <span class="lit-word">'LIST</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">serv-flags</span> [<span class="word datatype"title="">paren!</span> <span class="word">|</span> <span class="word datatype"title="">none!</span>] <span class="word key"title="SKIP series offset">skip</span> [<span class="word datatype"title="">word!</span> <span class="word">|</span> <span class="word datatype"title="">string!</span> <span class="word">|</span> <span class="word datatype"title="">integer!</span>]]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> <span class="word">ok-response</span><br /><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word">serv-flags</span> [<span class="set-word">serv-flags:</span> <span class="word">mk-folder-flags</span> <span class="word">serv-flags</span>]<br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="word key"title="ATTEMPT value">attempt</span> [ <span class="comment">; ignore errors with non-selectable folders (still need them subscribed)</span><br /><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word key"title="COMPOSE value /deep /only">compose</span> [<span class="word">SUBSCRIBE</span> (<span class="word">name</span>)]<br /><span class="tab">&nbsp;</span><span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span><br />]<br /><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word">serv-flags</span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="CONTEXT blk">context</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">folder-id:</span> <span class="word">name</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">flags:</span> <span class="word">serv-flags</span><br /><span class="tab">&nbsp;</span>]<br />] [<br /><span class="tab">&nbsp;</span><span class="word">name</span><br />]</p></div><h4 id="section-3.14.1">3.14.1 <span class="code"><span class="word">create-mail-folder</span></span>'s locals</h4><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">create-mail-folder</span></span>'s locals<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">delimiter</span> <span class="word">name</span> <span class="word">children</span> <span class="word">serv-flags</span></p></div><h3 id="section-3.15">3.15 Destroy the contents of <span class="code"><span class="word">folder-id</span></span></h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Destroy the contents of <span class="code"><span class="word">folder-id</span></span><span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">db:</span> <span class="word">pick-mail-db</span> <span class="word">db</span><br /><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word key"title="COMPOSE value /deep /only">compose</span> [<span class="word key"title="DELETE target /any">DELETE</span> (<span class="word">folder-id</span>)]<br /><span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span><br /><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word key"title="COMPOSE value /deep /only">compose</span> [<span class="word">CREATE</span> (<span class="word">folder-id</span>)]<br /><span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span><br /><span class="word">true</span></p></div><h3 id="section-3.16">3.16 Destroy the contents of <span class="code"><span class="word">folder-id</span></span> and then remove <span class="code"><span class="word">folder-id</span></span></h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Destroy the contents of <span class="code"><span class="word">folder-id</span></span> and then remove <span class="code"><span class="word">folder-id</span></span><span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">db:</span> <span class="word">pick-mail-db</span> <span class="word">db</span><br /><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word key"title="COMPOSE value /deep /only">compose</span> [<span class="word">UNSUBSCRIBE</span> (<span class="word">folder-id</span>)]<br /><span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span><br /><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word key"title="COMPOSE value /deep /only">compose</span> [<span class="word key"title="DELETE target /any">DELETE</span> (<span class="word">folder-id</span>)]<br /><span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span><br /><span class="word">true</span></p></div><h3 id="section-3.17">3.17 Move <span class="code"><span class="word">folder-id</span></span> inside of <span class="code"><span class="word">dest-folder-id</span></span></h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Move <span class="code"><span class="word">folder-id</span></span> inside of <span class="code"><span class="word">dest-folder-id</span></span><span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">db:</span> <span class="word">pick-mail-db</span> <span class="word">db</span><br /><span class="set-word">delimiter:</span> <span class="word">get-delimiter</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word">folder-id</span><br /><span class="set-word">name:</span> <span class="word key"title="LAST series">last</span> <span class="path"><span class="word key"title="PARSE input rules /all /case">parse</span>/<span class="word key"title="ALL block">all</span></span> <span class="word">folder-id</span> <span class="word">delimiter</span><br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word">dest-folder-id</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">delimiter:</span> <span class="word">get-delimiter</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word">dest-folder-id</span><br /><span class="tab">&nbsp;</span><span class="set-word">name:</span> <span class="word key"title="REJOIN block">rejoin</span> [<span class="word">dest-folder-id</span> <span class="word">delimiter</span> <span class="word">name</span>]<br />]<br /><span class="set-word">subfolders:</span> <span class="word key"title="COPY value /part range /deep">copy</span> [ ]<br /><span class="word">do-list</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="lit-word">'lsub</span> <span class="word">false</span> <span class="word">folder-id</span> <span class="word">subfolders</span><br /><span class="word">alter-subscription</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word">subfolders</span> <span class="lit-word">'UNSUBSCRIBE</span><br /><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word key"title="COMPOSE value /deep /only">compose</span> [<span class="word">UNSUBSCRIBE</span> (<span class="word">folder-id</span>)]<br /><span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span><br /><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word key"title="COMPOSE value /deep /only">compose</span> [<span class="word key"title="RENAME old new">RENAME</span> (<span class="word">folder-id</span>) (<span class="word">name</span>)]<br /><span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span><br /><span class="set-word">id-map:</span> <span class="word key"title="COPY value /part range /deep">copy</span> [ ]<br /><span class="word">make-id-map</span> <span class="word">id-map</span> <span class="word">folder-id</span> <span class="word">name</span> <span class="word">subfolders</span><br /><span class="word key"title="FOREACH 'word data body">foreach</span> [<span class="word">from</span> <span class="word key"title="TO type spec">to</span>] <span class="word">id-map</span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word key"title="COMPOSE value /deep /only">compose</span> [<span class="word">SUBSCRIBE</span> (<span class="word key"title="TO type spec">to</span>)]<br /><span class="tab">&nbsp;</span><span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span><br />]<br /><span class="word">id-map</span></p></div><h4 id="section-3.17.1">3.17.1 <span class="code"><span class="word">move-mail-folder</span></span>'s locals</h4><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">move-mail-folder</span></span>'s locals<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">delimiter</span> <span class="word">name</span> <span class="word">subfolders</span> <span class="word">id-map</span></p></div><h3 id="section-3.18">3.18 Change the name of <span class="code"><span class="word">folder-id</span></span> to <span class="code"><span class="word">new-folder-name</span></span></h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Change the name of <span class="code"><span class="word">folder-id</span></span> to <span class="code"><span class="word">new-folder-name</span></span><span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">db:</span> <span class="word">pick-mail-db</span> <span class="word">db</span><br /><span class="set-word">delimiter:</span> <span class="word">get-delimiter</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word">folder-id</span><br /><span class="set-word">parent:</span> <span class="path"><span class="word key"title="COPY value /part range /deep">copy</span>/<span class="word">part</span></span> <span class="word">folder-id</span> <span class="word key"title="ANY block">any</span> [<span class="path"><span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span>/<span class="word key"title="LAST series">last</span>/<span class="word key"title="TAIL series">tail</span></span> <span class="word">folder-id</span> <span class="word">delimiter</span> <span class="integer">0</span>]<br /><span class="path"><span class="word">encode-text</span>/<span class="word key"title="TO type spec">to</span></span> <span class="word">new-folder-name</span> <span class="lit-word">'utf-7-imap</span> <span class="word">parent</span><br /><span class="set-word">subfolders:</span> <span class="word key"title="COPY value /part range /deep">copy</span> [ ]<br /><span class="word">do-list</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="lit-word">'lsub</span> <span class="word">false</span> <span class="word">folder-id</span> <span class="word">subfolders</span><br /><span class="word">alter-subscription</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word">subfolders</span> <span class="lit-word">'UNSUBSCRIBE</span><br /><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word key"title="COMPOSE value /deep /only">compose</span> [<span class="word">UNSUBSCRIBE</span> (<span class="word">folder-id</span>)]<br /><span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span><br /><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word key"title="COMPOSE value /deep /only">compose</span> [<span class="word key"title="RENAME old new">RENAME</span> (<span class="word">folder-id</span>) (<span class="word">parent</span>)]<br /><span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span><br /><span class="set-word">id-map:</span> <span class="word key"title="COPY value /part range /deep">copy</span> [ ]<br /><span class="word">make-id-map</span> <span class="word">id-map</span> <span class="word">folder-id</span> <span class="word">parent</span> <span class="word">subfolders</span><br /><span class="word key"title="FOREACH 'word data body">foreach</span> [<span class="word">from</span> <span class="word key"title="TO type spec">to</span>] <span class="word">id-map</span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word key"title="COMPOSE value /deep /only">compose</span> [<span class="word">SUBSCRIBE</span> (<span class="word key"title="TO type spec">to</span>)]<br /><span class="tab">&nbsp;</span><span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span><br />]<br /><span class="word">id-map</span></p></div><h4 id="section-3.18.1">3.18.1 <span class="code"><span class="word">rename-mail-folder</span></span>'s locals</h4><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">rename-mail-folder</span></span>'s locals<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">delimiter</span> <span class="word">parent</span> <span class="word">subfolders</span> <span class="word">id-map</span></p></div><h3 id="section-3.19">3.19 Search the mail base for messages matching <span class="code"><span class="word">criteria</span></span></h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Search the mail base for messages matching <span class="code"><span class="word">criteria</span></span><span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">db:</span> <span class="word">pick-mail-db</span> <span class="word">db</span><br /><span class="word">select-mailbox</span> <span class="word">db</span> <span class="word">folder-id</span><br /><span class="set-word">message-count:</span> <span class="integer">0</span><br /><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="path"><span class="word">db</span>/<span class="word">select-response</span></span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="ANY block">any</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<span class="lit-word">'*</span> <span class="word datatype"title="">integer!</span> <span class="lit-word">'EXISTS</span> <span class="set-word">message-count:</span> (<span class="set-word">message-count:</span> <span class="path"><span class="word">message-count</span>/<span class="integer">-2</span></span>) <span class="word key"title="TO type spec">to</span> <span class="word">end</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<span class="word datatype"title="">word!</span> <span class="lit-word">'OK</span> <span class="word">into</span> [<span class="lit-word">'UIDVALIDITY</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">uidvalidity</span> <span class="word datatype"title="">integer!</span>] <span class="word datatype"title="">string!</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SKIP series offset">skip</span><br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="set-word">result:</span> <span class="word key"title="REDUCE value /only words">reduce</span> [<span class="word">uidvalidity</span>]<br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word">message-count</span> <span class="word key"title="&amp;lt; value1 value2">&lt;</span> <span class="integer">1</span> [<span class="word key"title="RETURN value">return</span> <span class="word">result</span>]<br /><span class="comment">; compile search criteria to imap search command</span><br /><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word">compile-search-criteria</span> <span class="word">criteria</span><br /><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="ANY block">any</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<span class="lit-word">'*</span> <span class="lit-word">'SEARCH</span> <span class="set-word">uids:</span> <span class="word">some</span> <span class="word datatype"title="">integer!</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SKIP series offset">skip</span><br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="NOT value">not</span> <span class="word key"title="BLOCK? value">block?</span> <span class="word">uids</span> [<span class="word key"title="RETURN value">return</span> <span class="word">result</span>]<br /><span class="word key"title="APPEND series value /only">append</span> <span class="word">result</span> <span class="word">uids</span></p></div><h4 id="section-3.19.1">3.19.1 <span class="code"><span class="word">search-mail-messages</span></span>'s locals</h4><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">search-mail-messages</span></span>'s locals<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">result</span> <span class="word">message-count</span> <span class="word">uidvalidity</span> <span class="word">uids</span></p></div><h3 id="section-3.20">3.20 Return a list of the available folders</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Return a list of the available folders<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">db:</span> <span class="word">pick-mail-db</span> <span class="word">db</span><br /><span class="comment">; need to add a way to hide/unhide folders (subscribe/unsubscribe)</span><br /><span class="set-word">result:</span> <span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">block!</span> <span class="integer">16</span><br /><span class="word">do-list</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="lit-word">'list</span> <span class="word">only</span> <span class="word">parent-id</span> <span class="word">result</span><br /><span class="path"><span class="word">do-list</span>/<span class="word">unhide</span></span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="lit-word">'lsub</span> <span class="word">only</span> <span class="word">parent-id</span> <span class="word">result</span><br /><span class="word key"title="UNLESS condition block">unless</span> <span class="word key"title="ALL block">all</span> [<br /><span class="tab">&nbsp;</span><span class="word">remove-hidden</span> <span class="word">result</span><br />]<br /><span class="word">result</span></p></div><h4 id="section-3.20.1">3.20.1 <span class="code"><span class="word">list-mail-folders</span></span>' locals</h4><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">list-mail-folders</span></span>' locals<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">result</span></p></div></div><div class="section"><h2 id="section-4">4. Support functions</h2><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Support functions<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">append-email:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">output</span> <span class="word">address</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="TAIL series">tail</span> <span class="word">output</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="path"><span class="word">address</span>/<span class="integer">1</span></span> [<span class="word">decode-email-field</span> <span class="path"><span class="word">address</span>/<span class="integer">1</span></span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="ALL block">all</span> [<span class="path"><span class="word">address</span>/<span class="integer">3</span></span> <span class="path"><span class="word">address</span>/<span class="integer">4</span></span> <span class="word key"title="NOT value">not</span> <span class="word key"title="EMPTY? series">empty?</span> <span class="path"><span class="word">address</span>/<span class="integer">3</span></span> <span class="word key"title="NOT value">not</span> <span class="word key"title="EMPTY? series">empty?</span> <span class="path"><span class="word">address</span>/<span class="integer">4</span></span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="REPEND series value /only">repend</span> <span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">email!</span> <span class="path"><span class="word">address</span>/<span class="integer">3</span></span> [<span class="string">"@"</span> <span class="path"><span class="word">address</span>/<span class="integer">4</span></span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br />]<br /><span class="set-word">ok-response:</span> [<span class="word datatype"title="">word!</span> <span class="lit-word">'OK</span> <span class="word">opt</span> <span class="word datatype"title="">block!</span> <span class="word datatype"title="">string!</span>]<br /><span class="set-word">select-mailbox:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">db</span> <span class="word">mailbox</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="path"><span class="word">db</span>/<span class="word">selected-mailbox</span></span> <span class="word key"title="&lt;&gt; value1 value2">&lt;&gt;</span> <span class="word">mailbox</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span> <span class="word key"title="COMPOSE value /deep /only">compose</span> [<span class="word key"title="SELECT series value /part range /only /case /any /with wild /skip size">SELECT</span> (<span class="word">mailbox</span>)]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">db/select-response:</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">db/selected-mailbox:</span> <span class="word">mailbox</span><br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="set-word">from-imap-flags:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">flags</span>] [<br /><span class="tab">&nbsp;</span><span class="set-word">flags:</span> <span class="word key"title="INTERSECT ser1 ser2 /case /skip size">intersect</span> <span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">block!</span> <span class="word">flags</span> [<span class="refinement">/Seen</span> <span class="refinement">/Answered</span> <span class="refinement">/Deleted</span> <span class="refinement">/Flagged</span> <span class="refinement">/Draft</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="FORALL 'word body">forall</span> <span class="word">flags</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">flags/1:</span> <span class="word key"title="SELECT series value /part range /only /case /any /with wild /skip size">select</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="refinement">/Seen</span> <span class="word key"title="READ source /binary /string /direct /no-wait /lines /part size /with end-of-line /mode args /custom params /skip length">read</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="refinement">/Answered</span> <span class="word">replied</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="refinement">/Deleted</span> <span class="word">deleted</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="refinement">/Flagged</span> <span class="word">flagged</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="refinement">/Draft</span> <span class="word">draft</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] <span class="path"><span class="word">flags</span>/<span class="integer">1</span></span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word">flags</span><br />]<br /><span class="set-word">to-imap-flags:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">flags</span> <span class="refinement">/local</span> <span class="word">res</span>] [<br /><span class="tab">&nbsp;</span><span class="set-word">res:</span> <span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">paren!</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">flags</span><br /><span class="tab">&nbsp;</span><span class="word key"title="FOREACH 'word data body">foreach</span> <span class="word">flag</span> <span class="word">flags</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SWITCH value cases /default case">switch</span> <span class="word">flag</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="READ source /binary /string /direct /no-wait /lines /part size /with end-of-line /mode args /custom params /skip length">read</span> [<span class="word key"title="APPEND series value /only">append</span> <span class="word">res</span> <span class="refinement">/Seen</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">replied</span> [<span class="word key"title="APPEND series value /only">append</span> <span class="word">res</span> <span class="refinement">/Answered</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">deleted</span> [<span class="word key"title="APPEND series value /only">append</span> <span class="word">res</span> <span class="refinement">/Deleted</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">flagged</span> [<span class="word key"title="APPEND series value /only">append</span> <span class="word">res</span> <span class="refinement">/Flagged</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">draft</span> [<span class="word key"title="APPEND series value /only">append</span> <span class="word">res</span> <span class="refinement">/Draft</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">forwarded</span> [<span class="word key"title="APPEND series value /only">append</span> <span class="word">res</span> <span class="issue">#$Forwarded</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word">res</span><br />]<br /><span class="set-word">parse-bodystructure:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">structure</span> <span class="refinement">/local</span> <span class="word">result</span> <span class="word">value</span> <span class="word">mk1</span> <span class="word">mk2</span>] [<br /><span class="tab">&nbsp;</span><span class="set-word">result:</span> <span class="word key"title="COPY value /part range /deep">copy</span> [#[<span class="word">none</span>]]<br /><span class="tab">&nbsp;</span><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word">structure</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">value</span> [<span class="word datatype"title="">string!</span> <span class="word datatype"title="">string!</span>] ( <span class="comment">; content type</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="ANY block">any</span> [<span class="word key"title="EMPTY? series">empty?</span> <span class="path"><span class="word">value</span>/<span class="integer">1</span></span> <span class="word key"title="EMPTY? series">empty?</span> <span class="path"><span class="word">value</span>/<span class="integer">2</span></span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">value:</span> [<span class="string">"text"</span> <span class="string">"plain"</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">value/1:</span> <span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">word!</span> <span class="path"><span class="word">value</span>/<span class="integer">1</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">value/2:</span> <span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">word!</span> <span class="path"><span class="word">value</span>/<span class="integer">2</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="APPEND series value /only">append</span>/<span class="word">only</span></span> <span class="word">result</span> <span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">path!</span> <span class="word">value</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SET word value /any /pad">set</span> <span class="word">value</span> <span class="word datatype"title="">paren!</span> ( <span class="comment">; charset etc. (parameters)</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">value:</span> <span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">block!</span> <span class="word">value</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="FORSKIP 'word skip-num body">forskip</span> <span class="word">value</span> <span class="integer">2</span> [<span class="set-path">value/1:</span> <span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">word!</span> <span class="path"><span class="word">value</span>/<span class="integer">1</span></span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="APPEND series value /only">append</span>/<span class="word">only</span></span> <span class="word">result</span> <span class="word">value</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SKIP series offset">skip</span> (<span class="word key"title="APPEND series value /only">append</span> <span class="word">result</span> <span class="word">none</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">mk1:</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<span class="word datatype"title="">string!</span> <span class="word">|</span> <span class="word datatype"title="">none!</span>] <span class="comment">; content id</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<span class="word datatype"title="">string!</span> <span class="word">|</span> <span class="word datatype"title="">none!</span>] <span class="comment">; content description</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word datatype"title="">string!</span> <span class="comment">; encoding</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word datatype"title="">integer!</span> <span class="comment">; size</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">mk2:</span> (<span class="path"><span class="word key"title="INSERT series value /part range /only /dup count">insert</span>/<span class="word">part</span></span> <span class="word key"title="TAIL series">tail</span> <span class="word">result</span> <span class="word">mk1</span> <span class="word">mk2</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">some</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SET word value /any /pad">set</span> <span class="word">value</span> <span class="word datatype"title="">paren!</span> (<span class="path"><span class="word key"title="APPEND series value /only">append</span>/<span class="word">only</span></span> <span class="word">result</span> <span class="word">parse-bodystructure</span> <span class="word">value</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SET word value /any /pad">set</span> <span class="word">value</span> <span class="word datatype"title="">string!</span> (<span class="set-path">result/1:</span> <span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">word!</span> <span class="word">value</span>) <span class="comment">; multipart type</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word">result</span><br />]<br /><span class="set-word">has-attachments?:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">structure</span>] [<br /><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="SWITCH value cases /default case">switch</span>/<span class="word">default</span></span> <span class="path"><span class="word">structure</span>/<span class="integer">1</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>#[<span class="word">none</span>] [<span class="word">false</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">alternative</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="FOREACH 'word data body">foreach</span> <span class="word">part</span> <span class="word key"title="NEXT series">next</span> <span class="word">structure</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word">has-attachments?</span> <span class="word">part</span> [<span class="word key"title="RETURN value">return</span> <span class="word">true</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">false</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="comment">; I think this should be FALSE, though I haven't checked what Thunderbird does</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">related</span> [<span class="word">false</span>]<br /><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">true</span><br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="set-word">append-tree:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">tree</span> <span class="word key"title="PATH value selector">path</span> <span class="word">folderid</span> <span class="word">flags</span> <span class="word">only</span> <span class="refinement">/local</span> <span class="word">pos</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="set-word">pos:</span> <span class="path"><span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span>/<span class="word key"title="SKIP series offset">skip</span></span> <span class="word">tree</span> <span class="path"><span class="word key"title="PATH value selector">path</span>/<span class="integer">1</span></span> <span class="integer">4</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="TAIL? series">tail?</span> <span class="word key"title="NEXT series">next</span> <span class="word key"title="PATH value selector">path</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word">only</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="REMOVE series /part range">remove</span> <span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span> <span class="path"><span class="word">pos</span>/<span class="integer">3</span></span> <span class="lit-word">'Hidden</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">pos/2:</span> <span class="word">folderid</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">pos/3:</span> <span class="word">flags</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-tree</span> <span class="path"><span class="word">pos</span>/<span class="integer">4</span></span> <span class="word key"title="NEXT series">next</span> <span class="word key"title="PATH value selector">path</span> <span class="word">folderid</span> <span class="word">flags</span> <span class="word">only</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="UNLESS condition block">unless</span> <span class="word">only</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="TAIL? series">tail?</span> <span class="word key"title="NEXT series">next</span> <span class="word key"title="PATH value selector">path</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="REPEND series value /only">repend</span> <span class="word">tree</span> [<span class="path"><span class="word key"title="PATH value selector">path</span>/<span class="integer">1</span></span> <span class="word">folderid</span> <span class="word">flags</span> <span class="word key"title="COPY value /part range /deep">copy</span> [ ]]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="REPEND series value /only">repend</span> <span class="word">tree</span> [<span class="path"><span class="word key"title="PATH value selector">path</span>/<span class="integer">1</span></span> <span class="word">none</span> <span class="word key"title="COPY value /part range /deep">copy</span> [<span class="word">children</span>] <span class="set-word">pos:</span> <span class="word key"title="COPY value /part range /deep">copy</span> [ ]]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-tree</span> <span class="word">pos</span> <span class="word key"title="NEXT series">next</span> <span class="word key"title="PATH value selector">path</span> <span class="word">folderid</span> <span class="word">flags</span> <span class="word">only</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="set-word">mk-folder-flags:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">flags</span> <span class="refinement">/to</span> <span class="word">result</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="UNLESS condition block">unless</span> <span class="word">result</span> [<span class="set-word">result:</span> <span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">block!</span> <span class="integer">4</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="UNLESS condition block">unless</span> <span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span> <span class="word">flags</span> <span class="refinement">/NoInferiors</span> [<span class="word key"title="APPEND series value /only">append</span> <span class="word">result</span> <span class="lit-word">'children</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="UNLESS condition block">unless</span> <span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span> <span class="word">flags</span> <span class="refinement">/NoSelect</span> [<span class="word key"title="APPEND series value /only">append</span> <span class="word">result</span> <span class="lit-word">'messages</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span> <span class="word">flags</span> <span class="refinement">/Marked</span> [<span class="word key"title="APPEND series value /only">append</span> <span class="word">result</span> <span class="lit-word">'new</span>]<br /><span class="tab">&nbsp;</span><span class="word">result</span><br />]<br /><span class="set-word">remove-hidden:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">folders</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="REMOVE-EACH 'word data body">remove-each</span> [<span class="word">name</span> <span class="word">id</span> <span class="word">flags</span> <span class="word">sub-folders</span>] <span class="word">folders</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">remove-hidden</span> <span class="word">sub-folders</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="ALL block">all</span> [<span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span> <span class="word">flags</span> <span class="lit-word">'hidden</span> <span class="word key"title="EMPTY? series">empty?</span> <span class="word">sub-folders</span> <span class="word">id</span> <span class="word key"title="&amp;lt;&amp;gt; value1 value2">&lt;&gt;</span> <span class="string">"INBOX"</span>]<br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="set-word">get-delimiter:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span> <span class="word">parent</span> <span class="refinement">/local</span> <span class="word">delimiter</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word">port</span> <span class="word key"title="REDUCE value /only words">reduce</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'list</span> <span class="word">parent</span> <span class="string">""</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="UNLESS condition block">unless</span> <span class="word key"title="ALL block">all</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">port</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<span class="lit-word">'*</span> <span class="lit-word">'LIST</span> <span class="word key"title="SKIP series offset">skip</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">delimiter</span> [<span class="word datatype"title="">word!</span> <span class="word">|</span> <span class="word datatype"title="">string!</span> <span class="word">|</span> <span class="word datatype"title="">none!</span>] <span class="word key"title="SKIP series offset">skip</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> <span class="word">ok-response</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">delimiter</span><br /><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">error!</span> <span class="string">"Unknown hierarchy delimiter for folder"</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word">delimiter</span><br />]<br /><span class="set-word">do-list:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">port</span> <span class="word">cmd</span> <span class="word">only</span> <span class="word">parent</span> <span class="word">result</span> <span class="refinement">/unhide</span> <span class="refinement">/local</span> <span class="word">flags</span> <span class="word">delimiter</span> <span class="word">folder</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word">parent</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">delimiter:</span> <span class="word">get-delimiter</span> <span class="word">port</span> <span class="word">parent</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">parent:</span> <span class="word key"title="JOIN value rest">join</span> <span class="word">parent</span> <span class="word">delimiter</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word">port</span> <span class="word key"title="REDUCE value /only words">reduce</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">cmd</span> <span class="word key"title="ANY block">any</span> [<span class="word">parent</span> <span class="string">""</span>] <span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word">only</span> [<span class="string">"%"</span>] [<span class="string">"*"</span>]<br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="UNLESS condition block">unless</span> <span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">port</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="ANY block">any</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'*</span> [<span class="lit-word">'LIST</span> <span class="word">|</span> <span class="lit-word">'LSUB</span>] <span class="word key"title="SET word value /any /pad">set</span> <span class="word">flags</span> [<span class="word datatype"title="">paren!</span> <span class="word">|</span> <span class="word datatype"title="">none!</span>] <span class="word key"title="SET word value /any /pad">set</span> <span class="word">delimiter</span> [<span class="word datatype"title="">word!</span> <span class="word">|</span> <span class="word datatype"title="">string!</span> <span class="word">|</span> <span class="word datatype"title="">none!</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SET word value /any /pad">set</span> <span class="word">folder</span> [<span class="word datatype"title="">word!</span> <span class="word">|</span> <span class="word datatype"title="">integer!</span>] (<span class="set-word">folder:</span> <span class="word key"title="FORM value">form</span> <span class="word">folder</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SET word value /any /pad">set</span> <span class="word">folder</span> <span class="word datatype"title="">string!</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SET word value /any /pad">set</span> <span class="word">folder</span> <span class="word datatype"title="">binary!</span> (<span class="set-word">folder:</span> <span class="word key"title="AS-STRING string">as-string</span> <span class="word">folder</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] (<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="comment">; LSUB may return "folder/" instead of "folder" if the client subscribed it that way</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="comment">; (eg. Thunderbird). LIST always returns "folder" though, so we have a problem if we don't</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="comment">; remove the delimiter.</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="ALL block">all</span> [<span class="word">delimiter</span> <span class="path"><span class="word">delimiter</span>/<span class="integer">1</span></span> <span class="word key"title="= value1 value2">=</span> <span class="word key"title="LAST series">last</span> <span class="word">folder</span>] [<span class="word key"title="REMOVE series /part range">remove</span> <span class="word key"title="BACK series">back</span> <span class="word key"title="TAIL series">tail</span> <span class="word">folder</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-tree</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">result</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word">delimiter</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="PARSE input rules /all /case">parse</span>/<span class="word key"title="ALL block">all</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">decode-text</span> <span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word">parent</span> [<span class="path"><span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span>/<span class="word">match</span></span> <span class="word">folder</span> <span class="word">parent</span>] [<span class="word">folder</span>] <span class="lit-word">'utf-7-imap</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="FORM value">form</span> <span class="word">delimiter</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="REDUCE value /only words">reduce</span> [<span class="word">decode-text</span> <span class="word">folder</span> <span class="lit-word">'utf-7-imap</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">folder</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="APPEND series value /only">append</span> <span class="word">mk-folder-flags</span> <span class="word">flags</span> <span class="lit-word">'Hidden</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">unhide</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">into</span> <span class="word">ok-response</span><br /><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">error!</span> <span class="string">"Can't parse folder list"</span><br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="set-word">alter-subscription:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="word">port</span><br /><span class="tab">&nbsp;</span><span class="word">folders</span><br /><span class="tab">&nbsp;</span><span class="word">action</span><br />] [<br /><span class="tab">&nbsp;</span><span class="word key"title="FOREACH 'word data body">foreach</span> [<span class="word">name</span> <span class="word">id</span> <span class="word">flags</span> <span class="word">sub-folders</span>] <span class="word">folders</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word">port</span> <span class="word key"title="COMPOSE value /deep /only">compose</span> [(<span class="word">action</span>) (<span class="word">id</span>)]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">port</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">alter-subscription</span> <span class="word">port</span> <span class="word">sub-folders</span> <span class="word">action</span><br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="set-word">make-id-map:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="word">map</span><br /><span class="tab">&nbsp;</span><span class="word">from</span><br /><span class="tab">&nbsp;</span><span class="word key"title="TO type spec">to</span><br /><span class="tab">&nbsp;</span><span class="word">sub-folders</span><br />] [<br /><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word">map</span> <span class="word">from</span> <span class="word key"title="TO type spec">to</span><br /><span class="tab">&nbsp;</span><span class="word key"title="FOREACH 'word data body">foreach</span> [<span class="word">name</span> <span class="word">id</span> <span class="word">flags</span> <span class="word">sub-folders</span>] <span class="word">sub-folders</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">make-id-map</span> <span class="word">map</span> <span class="word">id</span> <span class="word key"title="JOIN value rest">join</span> <span class="word key"title="TO type spec">to</span> <span class="word key"title="SKIP series offset">skip</span> <span class="word">id</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">from</span> <span class="word">sub-folders</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word">map</span><br />]<br /><span class="set-word">node-types:</span> <span class="word key"title="CONTEXT blk">context</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">and:</span> <span class="set-word">or:</span> <span class="set-word">subject:</span> <span class="set-word">from:</span> <span class="set-word">to:</span> <span class="set-word">cc:</span> <span class="set-word">bcc:</span> <span class="set-word">body:</span> <span class="set-word">unread:</span> <span class="set-word">unforwarded:</span> <span class="word">none</span><br />]<br /><span class="set-path">node-types/and:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">output</span> <span class="word">args</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="FOREACH 'word data body">foreach</span> <span class="word">node</span> <span class="word">args</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">compile-node</span> <span class="word">output</span> <span class="word">node</span><br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="set-path">node-types/or:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">output</span> <span class="word">args</span> <span class="refinement">/local</span> <span class="word">paren</span>] [<br /><span class="tab">&nbsp;</span><span class="set-word">paren:</span> <span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">paren!</span> <span class="integer">8</span><br /><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="APPEND series value /only">append</span>/<span class="word">only</span></span> <span class="word">output</span> <span class="word">paren</span><br /><span class="tab">&nbsp;</span><span class="word key"title="APPEND series value /only">append</span> <span class="word">paren</span> <span class="lit-word">'OR</span><br /><span class="tab">&nbsp;</span><span class="word key"title="FOREACH 'word data body">foreach</span> <span class="word">node</span> <span class="word">args</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">compile-node</span> <span class="word">paren</span> <span class="word">node</span><br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="set-path">node-types/subject:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">output</span> <span class="word">args</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="REPEND series value /only">repend</span> <span class="word">output</span> [<span class="lit-word">'SUBJECT</span> <span class="path"><span class="word">args</span>/<span class="integer">1</span></span>]<br />]<br /><span class="set-path">node-types/from:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">output</span> <span class="word">args</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="REPEND series value /only">repend</span> <span class="word">output</span> [<span class="lit-word">'FROM</span> <span class="path"><span class="word">args</span>/<span class="integer">1</span></span>]<br />]<br /><span class="set-path">node-types/to:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">output</span> <span class="word">args</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="REPEND series value /only">repend</span> <span class="word">output</span> [<span class="lit-word">'TO</span> <span class="path"><span class="word">args</span>/<span class="integer">1</span></span>]<br />]<br /><span class="set-path">node-types/cc:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">output</span> <span class="word">args</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="REPEND series value /only">repend</span> <span class="word">output</span> [<span class="lit-word">'CC</span> <span class="path"><span class="word">args</span>/<span class="integer">1</span></span>]<br />]<br /><span class="set-path">node-types/bcc:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">output</span> <span class="word">args</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="REPEND series value /only">repend</span> <span class="word">output</span> [<span class="lit-word">'BCC</span> <span class="path"><span class="word">args</span>/<span class="integer">1</span></span>]<br />]<br /><span class="set-path">node-types/body:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">output</span> <span class="word">args</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="REPEND series value /only">repend</span> <span class="word">output</span> [<span class="lit-word">'BODY</span> <span class="path"><span class="word">args</span>/<span class="integer">1</span></span>]<br />]<br /><span class="set-path">node-types/unread:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">output</span> <span class="word">args</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="APPEND series value /only">append</span> <span class="word">output</span> <span class="lit-word">'UNSEEN</span><br />]<br /><span class="set-path">node-types/unforwarded:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">output</span> <span class="word">args</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="APPEND series value /only">append</span> <span class="word">output</span> [<span class="word">UNKEYWORD</span> <span class="issue">#$Forwarded</span>]<br />]<br /><span class="set-word">compile-node:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">output</span> <span class="word">node</span> <span class="refinement">/local</span> <span class="word">type</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="UNLESS condition block">unless</span> <span class="set-word">type:</span> <span class="word key"title="IN object word">in</span> <span class="word">node-types</span> <span class="path"><span class="word">node</span>/<span class="integer">1</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">error!</span> <span class="string">"Invalid search criteria"</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="DO value /args arg /next">do</span> <span class="word">type</span> <span class="word">output</span> <span class="word key"title="NEXT series">next</span> <span class="word">node</span><br />]<br /><span class="set-word">compile-search-criteria:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">criteria</span> <span class="refinement">/local</span> <span class="word">res</span>] [<br /><span class="tab">&nbsp;</span><span class="set-word">res:</span> <span class="word key"title="COPY value /part range /deep">copy</span> [<span class="word">UID</span> <span class="word">SEARCH</span> <span class="word">UNDELETED</span>]<br /><span class="tab">&nbsp;</span><span class="word">compile-node</span> <span class="word">res</span> <span class="word">criteria</span><br /><span class="tab">&nbsp;</span><span class="word">res</span><br />]<br /><span class="set-word">mail-db-store:</span> [ ]<br /><span class="set-word">select-mail-db:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">db</span> <span class="refinement">/bump</span> <span class="refinement">/local</span> <span class="word">pos</span>] [<br /><span class="tab">&nbsp;</span><span class="set-word">db:</span> <span class="word key"title="ALL block">all</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">pos:</span> <span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span> <span class="word">mail-db-store</span> <span class="word key"title="REDUCE value /only words">reduce</span> [<span class="path"><span class="word">db</span>/<span class="word">host</span></span> <span class="path"><span class="word">db</span>/<span class="word">port</span></span> <span class="path"><span class="word">db</span>/<span class="word">user</span></span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="integer">3</span> <span class="word key"title="+ value1 value2">+</span> <span class="word key"title="INDEX? series /xy">index?</span> <span class="word">pos</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="ALL block">all</span> [<span class="word">db</span> <span class="word">bump</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">pos/4/refcount:</span> <span class="path"><span class="word">pos</span>/<span class="integer">4</span>/<span class="word">refcount</span></span> <span class="word key"title="+ value1 value2">+</span> <span class="integer">1</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word">db</span><br />]<br /><span class="set-word">append-mail-db:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">db</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="APPEND series value /only">append</span> <span class="word">mail-db-store</span> <span class="word key"title="REDUCE value /only words">reduce</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word">db</span>/<span class="word">imap-port</span>/<span class="word">host</span></span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span>/<span class="word">port-id</span></span> <span class="path"><span class="word">db</span>/<span class="word">imap-port</span>/<span class="word">user</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">db</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="LENGTH? series">length?</span> <span class="word">mail-db-store</span><br />]<br /><span class="set-word">open-port:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">db</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="OPEN spec /binary /string /direct /seek /new /read /write /no-wait /lines /with end-of-line /allow access /mode args /custom params /skip length">open</span> <span class="word key"title="COMPOSE value /deep /only">compose</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">scheme:</span> (<span class="word key"title="EITHER condition true-block false-block">either</span> <span class="path"><span class="word">db</span>/<span class="word key"title="SECURE 'level">secure</span></span> [[<span class="lit-word">'imapscommands</span>]] [[<span class="lit-word">'imapcommands</span>]])<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">host:</span> <span class="path"><span class="word">db</span>/<span class="word">host</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">user:</span> <span class="path"><span class="word">db</span>/<span class="word">user</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">pass:</span> <span class="path"><span class="word">db</span>/<span class="word">pass</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">port-id:</span> <span class="path"><span class="word">db</span>/<span class="word">port</span></span><br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="set-word">pick-mail-db:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">db</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="PICK series index">pick</span> <span class="word">mail-db-store</span> <span class="word">db</span><br />]</p></div></div>
    <div id="footer"><p><a href="http://www.rebol.com/">MakeDoc3 by REBOL</a> - 2-Sep-2018</p></div>
</body>
</html>
