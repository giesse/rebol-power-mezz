<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta name="generator" content="REBOL" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

  <title>HTML Normalizer</title>

<style type="text/css">
/*<![CDATA[*/
html, body, p, li {font-family: Georgia, Times New Roman, serif; text-align: justify;}
.code, .code p {font-family: Trebuchet MS, Arial, Helvetica, sans-serif;}
.code .string, .code .tag, .code .issue {font-family: Lucida Console, Courier New, Courier, fixed;}
.code .word, .code .set-word, .code .lit-word, .code .get-word, .code .refinement {font-style: italic;}
.code .key {font-style: normal; font-weight: bold;}
.code .function {font-weight: bold; font-style: normal;}
.code .ref a {text-decoration: none; color: black;}
.code .ref a:hover {text-decoration: underline; color: blue;}
.code .issue, .code .tag, .code .datatype {color: green;}
.code .datatype {font-style: normal;}
.code .url, .code .file, .code .refinement, .code .lit-word {color: brown;}
.code .integer, .code .decimal, .code .tuple, .code .pair {color: blue;}
.code .comment {color: gray;}
div.code {margin-left: 95pt;}
div.code p.sectdef {font-style: normal; margin: 0 0 0 -30pt;}
div.code p {margin: 0;}
div.code span.tab {padding-left: .75cm; border-left: dotted thin #CCCCCC;}
div.code span.directive {background-color: #F0FFF0; border: dotted thin black;}
#header {margin: 34pt 140pt 140pt 140pt; padding: 0;}
#title {text-align: center; margin: 0 0 34pt 0;}
#author {text-align: center; margin: 13pt 0 0 0; font-size: 13pt;}
#dateversion {text-align: center; margin: 0 0 24pt 0; font-size: 12pt;}
#purpose {text-align: justify; font-style: italic;}
#license {font-size: 7pt; color: gray; margin: 2pt 10pt 2pt 10pt; width: 200pt; float: right; white-space: pre;}
#history {width: 60%; font-size: 10pt; margin-left: auto; margin-right: auto;}
#history thead tr {background-color: #E0E0E0;}
#history td.date {text-align: right;}
#history td.version {text-align: center;}
#history td.desc {width: 100%; text-align: justify;}
#history td.name {text-align: left;}
#toc {margin: 70pt;}
#toc li {list-style: none;}
.section {margin: 70pt 70pt 70pt 100pt;}
.section h2, .section h3 {margin-left: -30pt;}
pre {font-family: Lucida Console; overflow: scroll;}
.center {margin-left: auto; margin-right: auto; text-align: center;}
span.bra {font-family: Arial Unicode MS;}
div.note {margin: 3pt; margin-bottom: 14pt; padding: 0 12pt 6pt 12pt; background-color: #E0E0E0;}
div.note h2 {
    margin: 0 -12pt 12pt -12pt;
    padding: 5pt;
    text-align: center;
    background-color: #606060;
    color: white;
    font-size: 14pt;
}
div.image {text-align: center;}
div.image img {padding: 10px; border: dashed thin black;}
/*]]>*/
</style>
</head>

<body>
    <div id="header"><h1 id="title">HTML Normalizer</h1><h2 id="author">Gabriele Santilli</h2><h2 id="dateversion">1.1.7</h2><p id="purpose">
        Normalizes a HTML tag stream (that is, balances start and end tags, fixes missing
        end tags, and so on).
    </p><div id="license">
        =================================
        A message from Qtask about this source code:

        We have selected the MIT license (as of 2010-Jan-1) because
        it is the closest “standard” license to our intent.  If we had our way,
        we would declare this source as public domain, with absolutely no
        strings attached, not even the string that says you have to have
        strings.  We want to help people, so please feel free to contact us
        at API@Qtask.com if you have questions.
         

        (you only need to include the standard license text below in your
        homage to this source code)
        =================================

        Copyright 2009 Qtask, Inc.

        Permission is hereby granted, free of charge, to any person obtaining
        a copy of this software and associated documentation files
        (the "Software"), to deal in the Software without restriction, including
        without limitation the rights to use, copy, modify, merge, publish,
        distribute, sublicense, and/or sell copies of the Software, and to
        permit persons to whom the Software is furnished to do so, subject
        to the following conditions:

        The above copyright notice and this permission notice shall be included
        in all copies or substantial portions of the Software.

        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
        OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
        FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
        THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
        OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
        ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
        OTHER DEALINGS IN THE SOFTWARE.
    </div></div><div id="toc"><h2>Contents:</h2><ul><li><a href="#section-1">1. Introduction</a></li><li><a href="#section-2">2. Overview</a></li><li><a href="#section-3">3. Normalize the given <span class="code"><span class="word">html</span></span> block</a></li><ul><li><a href="#section-3.1">3.1 <span class="code"><span class="word">normalize-html</span></span>'s locals</a></li></ul><li><a href="#section-4">4. Lower level API (for incremental processing)</a></li><ul><li><a href="#section-4.1">4.1 Process a state machine command (eg. HTML tag)</a></li><li><a href="#section-4.2">4.2 Initialize the state machine</a></li><li><a href="#section-4.3">4.3 Reset the state machine</a></li></ul><li><a href="#section-5">5. Tag balancing state machine</a></li><ul><li><a href="#section-5.1">5.1 FSM states</a></li><li><a href="#section-5.2">5.2 Functions used by the state machine</a></li></ul></ul></div><div class="section"><h2 id="section-1">1. Introduction</h2><p>This module is deprecated. Please use <span class="code"><span class="word">load-html</span></span> instead.</p></div><div class="section"><h2 id="section-2">2. Overview</h2><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Overview<span class="bra">&#9002;</span> &#8801;</p><p><span class="ref"><span class="bra">&#9001;</span><a href="#section-5">Tag balancing state machine</a><span class="bra">&#9002;</span></span><br /><span class="ref"><span class="bra">&#9001;</span><a href="#section-4">Lower level API (for incremental processing)</a><span class="bra">&#9002;</span></span><br /><br /><span class="set-word">normalize-html:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Normalize HTML text"</span><br /><span class="tab">&nbsp;</span><span class="word">html</span> [<span class="word datatype"title="">block!</span>] <span class="string">"Result of LOAD-MARKUP"</span><br /><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="word">-nh-locals-</span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3">Normalize the given <span class="code"><span class="word">html</span></span> block</a><span class="bra">&#9002;</span></span><br />]</p></div></div><div class="section"><h2 id="section-3">3. Normalize the given <span class="code"><span class="word">html</span></span> block</h2><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Normalize the given <span class="code"><span class="word">html</span></span> block<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">result:</span> <span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">block!</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">html</span><br /><span class="word">init-normalizer</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">cmd</span> <span class="word">data</span>] [<br /><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="SWITCH value cases /default case">switch</span>/<span class="word">default</span></span> <span class="word">cmd</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">text</span> <span class="word">whitespace</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="ALL block">all</span> [<span class="word key"title="NOT value">not</span> <span class="word key"title="EMPTY? series">empty?</span> <span class="word">result</span> <span class="word key"title="STRING? value">string?</span> <span class="word key"title="LAST series">last</span> <span class="word">result</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="APPEND series value /only">append</span> <span class="word key"title="LAST series">last</span> <span class="word">result</span> <span class="word">data</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="APPEND series value /only">append</span> <span class="word">result</span> <span class="word">data</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="COMMENT value">comment</span> <span class="word">declaration</span> <span class="word">xml-proc</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="APPEND series value /only">append</span> <span class="word">result</span> <span class="word">data</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="ALL block">all</span> [<span class="word key"title="BLOCK? value">block?</span> <span class="word">data</span> <span class="word key"title="NOT value">not</span> <span class="word key"title="EMPTY? series">empty?</span> <span class="word">data</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word">data</span> <span class="word">cmd</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="APPEND series value /only">append</span>/<span class="word">only</span></span> <span class="word">result</span> <span class="word">data</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="APPEND series value /only">append</span> <span class="word">result</span> <span class="word">cmd</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="set-word">non-space:</span> <span class="word key"title="COMPLEMENT value">complement</span> <span class="set-word">space:</span> <span class="word key"title="CHARSET chars">charset</span> <span class="string">" ^/^-"</span><br /><span class="word key"title="FOREACH 'word data body">foreach</span> <span class="word">element</span> <span class="word">html</span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="SWITCH value cases /default case">switch</span> <span class="path"><span class="word key"title="TYPE? value /word">type?</span>/<span class="word">word</span></span> <span class="word">element</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word datatype"title="">string!</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="PARSE input rules /all /case">parse</span>/<span class="word key"title="ALL block">all</span></span> <span class="word">element</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="ANY block">any</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">txt</span> <span class="word">some</span> <span class="word">space</span> (<span class="word">process-tag</span> <span class="lit-word">'whitespace</span> <span class="word">txt</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">txt</span> <span class="word">some</span> <span class="word">non-space</span> (<span class="word">process-tag</span> <span class="lit-word">'text</span> <span class="word">txt</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word datatype"title="">block!</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">process-tag</span> <span class="word key"title="FIRST series">first</span> <span class="word">element</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="word key"title="NEXT series">next</span> <span class="word">element</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word datatype"title="">tag!</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="PARSE input rules /all /case">parse</span>/<span class="word key"title="ALL block">all</span></span> <span class="word">element</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="string">"!--"</span> (<span class="word">process-tag</span> <span class="lit-word">'comment</span> <span class="word">element</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="string">"!doctype"</span> (<span class="word">process-tag</span> <span class="lit-word">'declaration</span> <span class="word">element</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="string">"?"</span> (<span class="word">process-tag</span> <span class="lit-word">'xml-proc</span> <span class="word">element</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<span class="word">process-tag</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">element</span> <span class="word">none</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="word">reset-normalizer</span><br /><span class="word">result</span></p></div><h3 id="section-3.1">3.1 <span class="code"><span class="word">normalize-html</span></span>'s locals</h3><div class="code"><p><span class="word">-nh-locals-</span><br /><span class="word">result</span> <span class="word">space</span> <span class="word">non-space</span> <span class="word">txt</span></p></div></div><div class="section"><h2 id="section-4">4. Lower level API (for incremental processing)</h2><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Lower level API (for incremental processing)<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">init-normalizer:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Initialize HTML normalizer state machine"</span><br /><span class="tab">&nbsp;</span><span class="word">callback</span> [<span class="word datatype"title="">any-function!</span>] <span class="string">"Callback used during processing"</span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.2">Initialize the state machine</a><span class="bra">&#9002;</span></span><br />]<br /><span class="set-word">process-tag:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Process a HTML tag"</span><br /><span class="tab">&nbsp;</span><span class="word">command</span> <span class="word">command-data</span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.1">Process a state machine command (eg. HTML tag)</a><span class="bra">&#9002;</span></span><br />]<br /><span class="set-word">reset-normalizer:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Reset HTML normalizer state machine"</span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.3">Reset the state machine</a><span class="bra">&#9002;</span></span><br />]</p></div><h3 id="section-4.1">4.1 Process a state machine command (eg. HTML tag)</h3><p>We use a FSM interperter; thus the <span class="code"><span class="word">process</span></span> function just sets the words <span class="code"><span class="word">cmd</span></span> and <span class="code"><span class="word">data</span></span>
(so that the state rules can reference them) and sends <span class="code"><span class="word">cmd</span></span> as an event
to the state machine.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Process a state machine command (eg. HTML tag)<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">process-event</span> <span class="word">fsm</span> <span class="word">command</span> <span class="word">command-data</span></p></div><h3 id="section-4.2">4.2 Initialize the state machine</h3><p>There are a number of things to initialize for the state machine, and some things to
do for correct termination too. These two functions are used for this reason.</p><p>We need to initialize the
block and inline stacks; then we just reset the FSM to make sure it was not left in
a state different than the initial state due to an error in a previous run.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Initialize the state machine<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">cb:</span> <span class="get-word">:callback</span><br /><span class="word key"title="CLEAR series">clear</span> <span class="word">block-stack</span><br /><span class="word key"title="CLEAR series">clear</span> <span class="word">inline-stack</span><br /><span class="path"><span class="word">reset-fsm</span>/<span class="word">only</span></span> <span class="word">fsm</span></p></div><h3 id="section-4.3">4.3 Reset the state machine</h3><p>On reset, we need to reset the FSM
(this sends it back to the initial state, so it takes care of closing all elements
and so on). We also send the <span class="code"><span class="lit-word">'end</span></span> event which is ignored unless no HTML header has
been generated yet; this forces the generation of a HTML header for empty input.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Reset the state machine<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">process-event</span> <span class="word">fsm</span> <span class="lit-word">'end</span> <span class="word">none</span><br /><span class="word">reset-fsm</span> <span class="word">fsm</span></p></div></div><div class="section"><h2 id="section-5">5. Tag balancing state machine</h2><p>This state machine takes care of ensuring tag balancing, correct nesting, and overall
well-formedness of the HTML stream. Some potentially harmful content is also removed here.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Tag balancing state machine<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">fsm:</span> <span class="word">make-fsm</span> [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-5.1">FSM states</a><span class="bra">&#9002;</span></span><br />]<br /><br /><span class="ref"><span class="bra">&#9001;</span><a href="#section-5.2">Functions used by the state machine</a><span class="bra">&#9002;</span></span></p></div><h3 id="section-5.1">5.1 FSM states</h3><p>In the initial state, we are waiting for the <span class="code"><span class="tag">&lt;html&gt;</span></span> tag. Since both the start
and end tag for the <em>html</em> element are optional, we also emit a <span class="code"><span class="tag">&lt;html&gt;</span></span> tag as soon
as we find anything that is not a comment or whitespace.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>FSM states<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">initial-state:</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">comment:</span> <span class="set-word">declaration:</span> <span class="set-word">xml-proc:</span> (<span class="word">cb</span> <span class="word">event</span> <span class="word">data</span> <span class="word">nl</span>)<br /><span class="tab">&nbsp;</span><span class="set-word">whitespace:</span> ( ) <span class="comment">; ignore</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;html&gt;</span> (<span class="word">cb</span> <span class="tag">&lt;html&gt;</span> <span class="word">data</span> <span class="word">nl</span>) <span class="word">in-html-prehead</span> (<span class="word">cb</span> <span class="tag">&lt;/html&gt;</span> <span class="word">none</span>)<br /><span class="tab">&nbsp;</span><span class="set-word">default:</span> (<span class="word">cb</span> <span class="tag">&lt;html&gt;</span> <span class="word">none</span> <span class="word">nl</span>) <span class="word">continue</span> <span class="word">in-html-prehead</span> (<span class="word">cb</span> <span class="tag">&lt;/html&gt;</span> <span class="word">none</span>)<br />]</p></div><p>After the intial state, we get inside the <em>html</em> element and waiting for
a <span class="code"><span class="tag">&lt;head&gt;</span></span> tag to start the <em>head</em> element. Start and end tags are optional in this case
too, so we automatically enter the <em>head</em> element if we find one of the listed tags.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>FSM states<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">in-html-prehead:</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">comment:</span> (<span class="word">cb</span> <span class="lit-word">'comment</span> <span class="word">data</span>)<br /><span class="tab">&nbsp;</span><span class="set-word">whitespace:</span> ( ) <span class="comment">; ignore</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;head&gt;</span> (<span class="word">cb</span> <span class="tag">&lt;head&gt;</span> <span class="word">none</span> <span class="word">nl</span>) <span class="word">in-head</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;title&gt;</span> <span class="tag">&lt;isindex&gt;</span> <span class="tag">&lt;isindex/&gt;</span> <span class="tag">&lt;base&gt;</span> <span class="tag">&lt;base/&gt;</span> <span class="tag">&lt;script&gt;</span> <span class="tag">&lt;script/&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;style&gt;</span> <span class="tag">&lt;meta&gt;</span> <span class="tag">&lt;meta/&gt;</span> <span class="tag">&lt;link&gt;</span> <span class="tag">&lt;link/&gt;</span> <span class="tag">&lt;object&gt;</span> (<span class="word">cb</span> <span class="tag">&lt;head&gt;</span> <span class="word">none</span> <span class="word">nl</span>) <span class="word">continue</span> <span class="word">in-head</span><br /><span class="tab">&nbsp;</span><span class="set-word">default:</span> (<span class="word key"title="FOREACH 'word data body">foreach</span> <span class="word">tag</span> [<span class="tag">&lt;head&gt;</span> <span class="tag">&lt;title&gt;</span> <span class="tag">&lt;/title&gt;</span> <span class="tag">&lt;/head&gt;</span>] [<span class="word">cb</span> <span class="word">tag</span> <span class="word">none</span>] <span class="word">nl</span>) <span class="word">continue</span> <span class="word">in-html-prebody</span><br />]</p></div><p>In this state, we are inside the <em>head</em> element. We need to process the listed tags,
and end the element if we find anything else (except comments and whitespace of course).</p><p><span class="code"><span class="tag">&lt;isindex&gt;</span></span> is an HTML 3.2 thing that probably noone ever used; we're just ignoring
it. We're also ignoring any <span class="code"><span class="tag">&lt;meta/&gt;</span></span> tag as it is not essential and we want to avoid
<span class="code"><span class="tag">&lt;meta http-equiv="..."&gt;</span></span> anyway. <span class="code"><span class="tag">&lt;base/&gt;</span></span> and <span class="code"><span class="tag">&lt;link/&gt;</span></span> tags are preserved (they will be checked and sanitized
by the third stage), <span class="code"><span class="tag">&lt;object&gt;</span></span>'s and <span class="code"><span class="tag">&lt;script&gt;</span></span>'s are ignored, and <span class="code"><span class="tag">&lt;style&gt;</span></span> and <span class="code"><span class="tag">&lt;title&gt;</span></span> are
preserved while ensuring balancing (see below).</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>FSM states<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">in-head:</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">comment:</span> (<span class="word">cb</span> <span class="lit-word">'comment</span> <span class="word">data</span>)<br /><span class="tab">&nbsp;</span><span class="set-word">whitespace:</span> ( )<br /><span class="tab">&nbsp;</span><span class="tag">&lt;head&gt;</span> ( ) <span class="comment">; ignore extra &lt;head&gt; open tag</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;/head&gt;</span> (<span class="word">cb</span> <span class="tag">&lt;/head&gt;</span> <span class="word">none</span> <span class="word">nl</span>) <span class="word">in-html-prebody</span><br /><span class="tab">&nbsp;</span><span class="set-word">default:</span> (<span class="word">cb</span> <span class="tag">&lt;/head&gt;</span> <span class="word">none</span> <span class="word">nl</span>) <span class="word">continue</span> <span class="word">in-html-prebody</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;title&gt;</span> (<span class="word">cb</span> <span class="tag">&lt;title&gt;</span> <span class="word">none</span>) <span class="word">in-title</span> (<span class="word">cb</span> <span class="tag">&lt;/title&gt;</span> <span class="word">none</span> <span class="word">nl</span>)<br /><span class="tab">&nbsp;</span><span class="tag">&lt;isindex&gt;</span> <span class="tag">&lt;isindex/&gt;</span> ( ) <span class="comment">; noone should be using this</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;base&gt;</span> <span class="tag">&lt;base/&gt;</span> (<span class="word">cb</span> <span class="tag">&lt;base/&gt;</span> <span class="word">data</span>)<br /><span class="tab">&nbsp;</span><span class="tag">&lt;script&gt;</span> <span class="word">in-script</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;script/&gt;</span> ( ) <span class="comment">; just ignore</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;style&gt;</span> (<span class="word">cb</span> <span class="tag">&lt;style&gt;</span> <span class="word">data</span>) <span class="word">in-style</span> (<span class="word">cb</span> <span class="tag">&lt;/style&gt;</span> <span class="word">none</span> <span class="word">nl</span>)<br /><span class="tab">&nbsp;</span><span class="tag">&lt;meta&gt;</span> <span class="tag">&lt;meta/&gt;</span> ( ) <span class="comment">;(cb &lt;meta/&gt; data)</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;link&gt;</span> <span class="tag">&lt;link/&gt;</span> (<span class="word">cb</span> <span class="tag">&lt;link/&gt;</span> <span class="word">data</span> <span class="word">nl</span>)<br /><span class="tab">&nbsp;</span><span class="tag">&lt;object&gt;</span> <span class="word">in-hobject</span><br />]</p></div><p>These states are used by <span class="code"><span class="word">in-head</span></span> to parse the <em>title</em>, <em>style</em>, <em>script</em> and
<em>object</em> elements. (I'm not sure what an <em>object</em> in the <em>head</em> can be used for,
maybe preloading plugins etc. I'm just ignoring it. Note that just ignoring everything
up to a <span class="code"><span class="tag">&lt;/object&gt;</span></span> is not really a good idea, so this needs to be improved.) Comments
are not allowed in the title so we're ignoring them. We're also ignoring comments inside
the <em>style</em> element, but this will need to be changed as documents may be using comments
to hide the CSS from old user agents.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>FSM states<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">in-title:</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">comment:</span> ( )<br /><span class="tab">&nbsp;</span><span class="set-word">text:</span> (<span class="word">cb</span> <span class="lit-word">'text</span> <span class="word">data</span>)<br /><span class="tab">&nbsp;</span><span class="set-word">whitespace:</span> (<span class="word">sp</span>) <span class="word">ignore-whitespace</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;/title&gt;</span> <span class="word key"title="RETURN value">return</span><br /><span class="tab">&nbsp;</span><span class="set-word">default:</span> <span class="word">continue</span> <span class="word key"title="RETURN value">return</span><br />]<br /><span class="set-word">ignore-whitespace:</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">whitespace:</span> ( )<br /><span class="tab">&nbsp;</span><span class="set-word">default:</span> <span class="word">continue</span> <span class="word key"title="RETURN value">return</span><br />]<br /><span class="set-word">in-script:</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">comment:</span> <span class="set-word">text:</span> <span class="set-word">whitespace:</span> ( )<br /><span class="tab">&nbsp;</span><span class="tag">&lt;/script&gt;</span> <span class="word key"title="RETURN value">return</span><br /><span class="tab">&nbsp;</span><span class="set-word">default:</span> <span class="word">continue</span> <span class="word key"title="RETURN value">return</span><br />]<br /><span class="set-word">in-hobject:</span> [<br /><span class="tab">&nbsp;</span><span class="comment">; ignore everything - problem</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;/object&gt;</span> <span class="word key"title="RETURN value">return</span><br />]<br /><span class="set-word">in-style:</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">comment:</span> ( )<br /><span class="tab">&nbsp;</span><span class="set-word">text:</span> <span class="set-word">whitespace:</span> (<span class="word">cb</span> <span class="word">event</span> <span class="word">data</span>)<br /><span class="tab">&nbsp;</span><span class="tag">&lt;/style&gt;</span> <span class="word key"title="RETURN value">return</span><br /><span class="tab">&nbsp;</span><span class="set-word">default:</span> <span class="word">continue</span> <span class="word key"title="RETURN value">return</span><br />]</p></div><p>Here we are just after the <em>head</em> element, before the <span class="code"><span class="tag">&lt;body&gt;</span></span> start tag; since the start
tag is optional, we need to start the <em>body</em> element anyway at anything except comments and
whitespace after <em>head</em>.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>FSM states<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">in-html-prebody:</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">comment:</span> (<span class="word">cb</span> <span class="lit-word">'comment</span> <span class="word">data</span>)<br /><span class="tab">&nbsp;</span><span class="set-word">whitespace:</span> ( )<br /><span class="tab">&nbsp;</span><span class="tag">&lt;body&gt;</span> (<span class="word">cb</span> <span class="tag">&lt;body&gt;</span> <span class="word">data</span> <span class="word">nl</span>) <span class="word">in-block</span> (<span class="word">close-all</span> <span class="word">block-stack</span> <span class="word">cb</span> <span class="tag">&lt;/body&gt;</span> <span class="word">none</span> <span class="word">nl</span>)<br /><span class="tab">&nbsp;</span><span class="set-word">default:</span> (<span class="word">cb</span> <span class="tag">&lt;body&gt;</span> <span class="word">none</span> <span class="word">nl</span>) <span class="word">continue</span> <span class="word">in-block</span> (<span class="word">close-all</span> <span class="word">block-stack</span> <span class="word">cb</span> <span class="tag">&lt;/body&gt;</span> <span class="word">none</span> <span class="word">nl</span>)<br />]</p></div><p>Inside the <em>body</em>, content is processed by two states, <span class="code"><span class="word">in-block</span></span> and <span class="code"><span class="word">in-inline</span></span>. The first
handles block level elements, while the second handles inline level elements. They are kept separate
because inline level elements cannot contain block level elements. These two states ensure balancing
of start and end tags for elements; the <span class="code"><span class="word">open-tag</span></span> and <span class="code"><span class="word">close-tag</span></span> functions (see <span class="code"><span class="ref"><span class="bra">&#9001;</span><a href="#section-5.2">Functions used by the state machine</a><span class="bra">&#9002;</span></span></span>)
take care of ensuring correct nesting of elements, and enforcing rules such as that a <em>p</em> element
cannot contain other <em>p</em> elements and so on.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>FSM states<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">in-block:</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">comment:</span> (<span class="word">cb</span> <span class="lit-word">'comment</span> <span class="word">data</span>)<br /><span class="tab">&nbsp;</span><span class="set-word">whitespace:</span> ( )<br /><span class="tab">&nbsp;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;h1&gt;</span> <span class="tag">&lt;h2&gt;</span> <span class="tag">&lt;h3&gt;</span> <span class="tag">&lt;h4&gt;</span> <span class="tag">&lt;h5&gt;</span> <span class="tag">&lt;h6&gt;</span> <span class="tag">&lt;address&gt;</span> <span class="tag">&lt;p&gt;</span> <span class="tag">&lt;li&gt;</span> <span class="tag">&lt;dt&gt;</span> <span class="tag">&lt;dd&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;td&gt;</span> <span class="tag">&lt;th&gt;</span> <span class="tag">&lt;legend&gt;</span> <span class="tag">&lt;caption&gt;</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<span class="word">open-tag</span> <span class="word">block-stack</span> <span class="word">event</span> <span class="word">data</span>) <span class="word">in-inline</span> (<span class="word">close-all</span> <span class="word">inline-stack</span>)<br /><span class="tab">&nbsp;</span><span class="tag">&lt;pre&gt;</span> (<span class="word">open-tag</span> <span class="word">block-stack</span> <span class="word">event</span> <span class="word">data</span>) <span class="word">in-pre</span> (<span class="word">close-all</span> <span class="word">inline-stack</span>)<br /><span class="tab">&nbsp;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;ul&gt;</span> <span class="tag">&lt;ol&gt;</span> <span class="tag">&lt;dl&gt;</span> <span class="tag">&lt;div&gt;</span> <span class="tag">&lt;center&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;blockquote&gt;</span> <span class="tag">&lt;form&gt;</span> <span class="tag">&lt;fieldset&gt;</span> <span class="tag">&lt;table&gt;</span> <span class="tag">&lt;noscript&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;tr&gt;</span> <span class="tag">&lt;colgroup&gt;</span> <span class="tag">&lt;thead&gt;</span> <span class="tag">&lt;tfoot&gt;</span> <span class="tag">&lt;tbody&gt;</span> <span class="tag">&lt;ins&gt;</span> <span class="tag">&lt;del&gt;</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<span class="word">open-tag</span> <span class="word">block-stack</span> <span class="word">event</span> <span class="word">data</span> <span class="word">nl</span>)<br /><span class="tab">&nbsp;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;isindex&gt;</span> <span class="tag">&lt;isindex/&gt;</span> ( ) <span class="comment">; noone should be using this</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;iframe&gt;</span> <span class="tag">&lt;/iframe&gt;</span> ( ) <span class="comment">; filter it out</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;script&gt;</span> <span class="word">in-script</span> <span class="comment">; filter it out</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;script/&gt;</span> ( )<br /><span class="tab">&nbsp;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;style&gt;</span> (<span class="word">cb</span> <span class="tag">&lt;style&gt;</span> <span class="word">data</span>) <span class="word">in-style</span> (<span class="word">cb</span> <span class="tag">&lt;/style&gt;</span> <span class="word">none</span> <span class="word">nl</span>)<br /><br /><span class="tab">&nbsp;</span><span class="tag">&lt;hr&gt;</span> <span class="tag">&lt;hr/&gt;</span> (<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="comment">; &lt;hr&gt; does not nest inside these:</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="FOREACH 'word data body">foreach</span> <span class="word">tag</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tag">&lt;/h1&gt;</span> <span class="tag">&lt;/h2&gt;</span> <span class="tag">&lt;/h3&gt;</span> <span class="tag">&lt;/h4&gt;</span> <span class="tag">&lt;/h5&gt;</span> <span class="tag">&lt;/h6&gt;</span> <span class="tag">&lt;/address&gt;</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tag">&lt;/p&gt;</span> <span class="tag">&lt;/dt&gt;</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">close-tag</span> <span class="word">block-stack</span> <span class="word">tag</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">cb</span> <span class="tag">&lt;hr/&gt;</span> <span class="word">data</span> <span class="word">nl</span><br /><span class="tab">&nbsp;</span>)<br /><span class="tab">&nbsp;</span><span class="tag">&lt;col&gt;</span> <span class="tag">&lt;col/&gt;</span> (<span class="word">cb</span> <span class="tag">&lt;col/&gt;</span> <span class="word">data</span> <span class="word">nl</span>)<br /><span class="tab">&nbsp;</span><span class="tag">&lt;br&gt;</span> <span class="tag">&lt;br/&gt;</span> (<span class="word">cb</span> <span class="tag">&lt;br/&gt;</span> <span class="word">data</span> <span class="word">nl</span>)<br /><span class="tab">&nbsp;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;/h1&gt;</span> <span class="tag">&lt;/h2&gt;</span> <span class="tag">&lt;/h3&gt;</span> <span class="tag">&lt;/h4&gt;</span> <span class="tag">&lt;/h5&gt;</span> <span class="tag">&lt;/h6&gt;</span> <span class="tag">&lt;/address&gt;</span> <span class="tag">&lt;/p&gt;</span> <span class="tag">&lt;/ul&gt;</span> <span class="tag">&lt;/ol&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;/li&gt;</span> <span class="tag">&lt;/dl&gt;</span> <span class="tag">&lt;/dt&gt;</span> <span class="tag">&lt;/dd&gt;</span> <span class="tag">&lt;/pre&gt;</span> <span class="tag">&lt;/div&gt;</span> <span class="tag">&lt;/center&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;/blockquote&gt;</span> <span class="tag">&lt;/form&gt;</span> <span class="tag">&lt;/fieldset&gt;</span> <span class="tag">&lt;/legend&gt;</span> <span class="tag">&lt;/table&gt;</span> <span class="tag">&lt;/noscript&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;/tr&gt;</span> <span class="tag">&lt;/td&gt;</span> <span class="tag">&lt;/th&gt;</span> <span class="tag">&lt;/caption&gt;</span> <span class="tag">&lt;/colgroup&gt;</span> <span class="tag">&lt;/thead&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;/tfoot&gt;</span> <span class="tag">&lt;/tbody&gt;</span> <span class="tag">&lt;/ins&gt;</span> <span class="tag">&lt;/del&gt;</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<span class="word">close-tag</span> <span class="word">block-stack</span> <span class="word">event</span>)<br /><span class="tab">&nbsp;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;/body&gt;</span> <span class="tag">&lt;/html&gt;</span> ( ) <span class="comment">; ignored</span><br /><span class="tab">&nbsp;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;tt&gt;</span> <span class="tag">&lt;i&gt;</span> <span class="tag">&lt;b&gt;</span> <span class="tag">&lt;u&gt;</span> <span class="tag">&lt;strike&gt;</span> <span class="tag">&lt;s&gt;</span> <span class="tag">&lt;big&gt;</span> <span class="tag">&lt;small&gt;</span> <span class="tag">&lt;sub&gt;</span> <span class="tag">&lt;sup&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;em&gt;</span> <span class="tag">&lt;strong&gt;</span> <span class="tag">&lt;dfn&gt;</span> <span class="tag">&lt;code&gt;</span> <span class="tag">&lt;samp&gt;</span> <span class="tag">&lt;kbd&gt;</span> <span class="tag">&lt;var&gt;</span> <span class="tag">&lt;cite&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;a&gt;</span> <span class="tag">&lt;img&gt;</span> <span class="tag">&lt;img/&gt;</span> <span class="tag">&lt;applet&gt;</span> <span class="tag">&lt;font&gt;</span> <span class="tag">&lt;basefont&gt;</span> <span class="tag">&lt;basefont/&gt;</span> <br /><span class="tab">&nbsp;</span><span class="tag">&lt;map&gt;</span> <span class="tag">&lt;input&gt;</span> <span class="tag">&lt;input/&gt;</span> <span class="tag">&lt;select&gt;</span> <span class="tag">&lt;textarea&gt;</span> <span class="tag">&lt;span&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;abbr&gt;</span> <span class="tag">&lt;acronym&gt;</span> <span class="tag">&lt;q&gt;</span> <span class="tag">&lt;label&gt;</span> <span class="set-word">text:</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<span class="word">open-tag</span> <span class="word">block-stack</span> <span class="tag">&lt;p&gt;</span> <span class="word">none</span>) <span class="word">continue</span> <span class="word">in-inline</span> (<span class="word">close-all</span> <span class="word">inline-stack</span>)<br />]<br /><span class="set-word">in-inline:</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">comment:</span> (<span class="word">cb</span> <span class="lit-word">'comment</span> <span class="word">data</span>)<br /><span class="tab">&nbsp;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;tt&gt;</span> <span class="tag">&lt;i&gt;</span> <span class="tag">&lt;b&gt;</span> <span class="tag">&lt;u&gt;</span> <span class="tag">&lt;strike&gt;</span> <span class="tag">&lt;s&gt;</span> <span class="tag">&lt;big&gt;</span> <span class="tag">&lt;small&gt;</span> <span class="tag">&lt;sub&gt;</span> <span class="tag">&lt;sup&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;em&gt;</span> <span class="tag">&lt;strong&gt;</span> <span class="tag">&lt;dfn&gt;</span> <span class="tag">&lt;code&gt;</span> <span class="tag">&lt;samp&gt;</span> <span class="tag">&lt;kbd&gt;</span> <span class="tag">&lt;var&gt;</span> <span class="tag">&lt;cite&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;a&gt;</span> <span class="tag">&lt;font&gt;</span> <span class="tag">&lt;map&gt;</span> <span class="tag">&lt;select&gt;</span> <span class="tag">&lt;textarea&gt;</span> <span class="tag">&lt;option&gt;</span> <span class="tag">&lt;button&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;optgroup&gt;</span> <span class="tag">&lt;label&gt;</span> <span class="tag">&lt;span&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;abbr&gt;</span> <span class="tag">&lt;acronym&gt;</span> <span class="tag">&lt;q&gt;</span> <span class="tag">&lt;ins&gt;</span> <span class="tag">&lt;del&gt;</span> <span class="tag">&lt;object&gt;</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<span class="word">open-tag</span> <span class="word">inline-stack</span> <span class="word">event</span> <span class="word">data</span>)<br /><span class="tab">&nbsp;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;applet&gt;</span> <span class="tag">&lt;/applet&gt;</span> <span class="tag">&lt;param&gt;</span> <span class="tag">&lt;/param&gt;</span> ( )<br /><span class="tab">&nbsp;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;/tt&gt;</span> <span class="tag">&lt;/i&gt;</span> <span class="tag">&lt;/b&gt;</span> <span class="tag">&lt;/u&gt;</span> <span class="tag">&lt;/strike&gt;</span> <span class="tag">&lt;/s&gt;</span> <span class="tag">&lt;/big&gt;</span> <span class="tag">&lt;/small&gt;</span> <span class="tag">&lt;/sub&gt;</span> <span class="tag">&lt;/sup&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;/em&gt;</span> <span class="tag">&lt;/strong&gt;</span> <span class="tag">&lt;/dfn&gt;</span> <span class="tag">&lt;/code&gt;</span> <span class="tag">&lt;/samp&gt;</span> <span class="tag">&lt;/kbd&gt;</span> <span class="tag">&lt;/var&gt;</span> <span class="tag">&lt;/cite&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;/a&gt;</span> <span class="tag">&lt;/font&gt;</span> <span class="tag">&lt;/map&gt;</span> <span class="tag">&lt;/select&gt;</span> <span class="tag">&lt;/textarea&gt;</span> <span class="tag">&lt;/button&gt;</span> <span class="tag">&lt;/option&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;/optgroup&gt;</span> <span class="tag">&lt;/label&gt;</span> <span class="tag">&lt;/span&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;/abbr&gt;</span> <span class="tag">&lt;/acronym&gt;</span> <span class="tag">&lt;/q&gt;</span> <span class="tag">&lt;/object&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;/ins&gt;</span> <span class="tag">&lt;/del&gt;</span> <span class="comment">; should be treated specially, but noone uses them so...</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<span class="word">close-tag</span> <span class="word">inline-stack</span> <span class="word">event</span>)<br /><span class="tab">&nbsp;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;basefont&gt;</span> <span class="tag">&lt;basefont/&gt;</span> <span class="tag">&lt;br&gt;</span> <span class="tag">&lt;br/&gt;</span> <span class="tag">&lt;area&gt;</span> <span class="tag">&lt;area/&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;input&gt;</span> <span class="tag">&lt;input/&gt;</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<span class="word">cb</span> <span class="word key"title="EITHER condition true-block false-block">either</span> <span class="char">#"/"</span> <span class="word key"title="= value1 value2">=</span> <span class="word key"title="LAST series">last</span> <span class="word">event</span> [<span class="word">event</span>] [<span class="word key"title="APPEND series value /only">append</span> <span class="word">event</span> <span class="string">"/"</span>] <span class="word">data</span> <span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word">event</span> <span class="word key"title="= value1 value2">=</span> <span class="tag">&lt;br/&gt;</span> [<span class="word">nl</span>])<br /><br /><span class="tab">&nbsp;</span><span class="comment">; rebol.com uses the spelling &lt;image&gt;... and FF accepts it!</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;img&gt;</span> <span class="tag">&lt;img/&gt;</span> <span class="tag">&lt;image&gt;</span> <span class="tag">&lt;image/&gt;</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<span class="word">cb</span> <span class="tag">&lt;img/&gt;</span> <span class="word">data</span>)<br /><span class="tab">&nbsp;</span><br /><span class="tab">&nbsp;</span><span class="set-word">text:</span> (<span class="word">cb</span> <span class="lit-word">'text</span> <span class="word">data</span>)<br /><span class="tab">&nbsp;</span><span class="set-word">whitespace:</span> (<span class="word">sp</span>) <span class="word">ignore-whitespace</span><br /><span class="tab">&nbsp;</span><br /><span class="tab">&nbsp;</span><span class="set-word">default:</span> <span class="word">continue</span> <span class="word key"title="RETURN value">return</span><br />]<br /><span class="set-word">in-pre:</span> <span class="word key"title="APPEND series value /only">append</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">whitespace:</span> (<span class="word">cb</span> <span class="lit-word">'whitespace</span> <span class="word">data</span>)<br /><span class="tab">&nbsp;</span><span class="tag">&lt;br&gt;</span> <span class="tag">&lt;br/&gt;</span> (<span class="word">nl</span>)<br />] <span class="word">in-inline</span></p></div><h3 id="section-5.2">5.2 Functions used by the state machine</h3><p>We need to keep two stacks, one for block level elements and one for inline level elements;
when closing an element which is not the topmost on the stack, all contained elements
need to be closed too. Also, when exiting inline level to go back to block level, all inline
elements need to be closed.</p><p>Another thing we need to consider is the set of nesting rules; a <em>p</em> element cannot contain
other <em>p</em> elements, a <em>form</em> element cannot contain other <em>form</em> elements, and so on. These
rules are represented by the <span class="code"><span class="word">nesting</span></span> block, which is a map from a start tag to a list
of elements that need to be closed if they are open at the time the start tag is found; this
is done by just passing each end tag to <span class="code"><span class="word">close-tag</span></span>, since it does not close elements that are not
open.</p><p>There is a special case too: since the end tag for the <em>td</em> element is optional, a <span class="code"><span class="tag">&lt;td&gt;</span></span> needs
to close any open <em>td</em> element, but only for the current table, i.e. it should not close it
if that would mean closing a <em>table</em> element. (If you have nested tables, you can actually have
a <em>td</em> inside another <em>td</em>.)</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Functions used by the state machine<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">nl:</span> <span class="word key"title="DOES body">does</span> [<span class="word">cb</span> <span class="lit-word">'whitespace</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="string">"^/"</span>]<br /><span class="set-word">sp:</span> <span class="word key"title="DOES body">does</span> [<span class="word">cb</span> <span class="lit-word">'whitespace</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="string">" "</span>]<br /><span class="set-word">block-stack:</span> [ ]<br /><span class="set-word">inline-stack:</span> [ ]<br /><span class="set-word">nesting:</span> [<br /><span class="tab">&nbsp;</span><span class="tag">&lt;h1&gt;</span> <span class="tag">&lt;h2&gt;</span> <span class="tag">&lt;h3&gt;</span> <span class="tag">&lt;h4&gt;</span> <span class="tag">&lt;h5&gt;</span> <span class="tag">&lt;h6&gt;</span> <span class="tag">&lt;address&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;p&gt;</span> <span class="tag">&lt;ul&gt;</span> <span class="tag">&lt;ol&gt;</span> <span class="tag">&lt;dl&gt;</span> <span class="tag">&lt;pre&gt;</span> <span class="tag">&lt;dt&gt;</span> <span class="tag">&lt;dd&gt;</span><br /><span class="tab">&nbsp;</span><span class="tag">&lt;div&gt;</span> <span class="tag">&lt;center&gt;</span> <span class="tag">&lt;blockquote&gt;</span> <span class="tag">&lt;table&gt;</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tag">&lt;/h1&gt;</span> <span class="tag">&lt;/h2&gt;</span> <span class="tag">&lt;/h3&gt;</span> <span class="tag">&lt;/h4&gt;</span> <span class="tag">&lt;/h5&gt;</span> <span class="tag">&lt;/h6&gt;</span> <span class="tag">&lt;/address&gt;</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tag">&lt;/p&gt;</span> <span class="tag">&lt;/dt&gt;</span> <span class="tag">&lt;/dd&gt;</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tag">&lt;li&gt;</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">never</span> [<span class="tag">&lt;ul&gt;</span> <span class="tag">&lt;ol&gt;</span>] <span class="tag">&lt;/li&gt;</span> <span class="tag">&lt;/h1&gt;</span> <span class="tag">&lt;/h2&gt;</span> <span class="tag">&lt;/h3&gt;</span> <span class="tag">&lt;/h4&gt;</span> <span class="tag">&lt;/h5&gt;</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tag">&lt;/h6&gt;</span> <span class="tag">&lt;/address&gt;</span> <span class="tag">&lt;/p&gt;</span> <span class="tag">&lt;/dt&gt;</span> <span class="tag">&lt;/dd&gt;</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tag">&lt;form&gt;</span> [<span class="tag">&lt;/form&gt;</span>]<br /><span class="tab">&nbsp;</span><span class="tag">&lt;tr&gt;</span> [<span class="word">never</span> <span class="tag">&lt;table&gt;</span> <span class="tag">&lt;/tr&gt;</span> <span class="tag">&lt;/td&gt;</span> <span class="tag">&lt;/th&gt;</span> <span class="tag">&lt;/colgroup&gt;</span>]<br /><span class="tab">&nbsp;</span><span class="tag">&lt;td&gt;</span> <span class="tag">&lt;th&gt;</span> [<span class="word">never</span> <span class="tag">&lt;table&gt;</span> <span class="tag">&lt;/td&gt;</span> <span class="tag">&lt;/th&gt;</span>]<br /><span class="tab">&nbsp;</span><span class="tag">&lt;thead&gt;</span> <span class="tag">&lt;tfoot&gt;</span> <span class="tag">&lt;tbody&gt;</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">never</span> <span class="tag">&lt;table&gt;</span> <span class="tag">&lt;/thead&gt;</span> <span class="tag">&lt;/tfoot&gt;</span> <span class="tag">&lt;/tbody&gt;</span> <span class="tag">&lt;/tr&gt;</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tag">&lt;/td&gt;</span> <span class="tag">&lt;/th&gt;</span> <span class="tag">&lt;/colgroup&gt;</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tag">&lt;colgroup&gt;</span> [<span class="word">never</span> <span class="tag">&lt;table&gt;</span> <span class="tag">&lt;/colgroup&gt;</span>]<br /><span class="tab">&nbsp;</span><span class="tag">&lt;a&gt;</span> [<span class="tag">&lt;/a&gt;</span>]<br /><span class="tab">&nbsp;</span><span class="tag">&lt;map&gt;</span> [<span class="tag">&lt;/map&gt;</span>]<br /><span class="tab">&nbsp;</span><span class="tag">&lt;option&gt;</span> [<span class="tag">&lt;/option&gt;</span>]<br />]</p></div><p>Since the <span class="code"><span class="word">nesting</span></span> block is a many to one map, we can't use the <span class="code"><span class="word key"title="SELECT series value /part range /only /case /any /with wild /skip size">select</span></span> native, but need
to create our own special <span class="code"><span class="word">select*</span></span> function.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Functions used by the state machine<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">select*:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">block</span> <span class="word">value</span> <span class="refinement">/local</span> <span class="word">res</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word">block</span> [<span class="word key"title="TO type spec">to</span> <span class="word">value</span> <span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">block!</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">res</span> <span class="word datatype"title="">block!</span>]<br /><span class="tab">&nbsp;</span><span class="word">res</span><br />]</p></div><p>The <span class="code"><span class="word">open-tag</span></span> function first checks the nesting rules using <span class="code"><span class="word">select*</span></span> and calling
<span class="code"><span class="word">close-tag</span></span> with each end tag in the block, as described above; then it pushes
the start tag on the stack and sends it to the third stage.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Functions used by the state machine<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">open-tag:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">stack</span> <span class="word">starttag</span> <span class="word">attributes</span> <span class="refinement">/local</span> <span class="word">nestrules</span> <span class="word">upto</span> <span class="word">tag</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="set-word">nestrules:</span> <span class="word">select*</span> <span class="word">nesting</span> <span class="word">starttag</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word">nestrules</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">some</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'never</span> [<span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">upto</span> <span class="word datatype"title="">tag!</span> <span class="word">|</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">upto</span> <span class="word">into</span> [<span class="word">some</span> <span class="word datatype"title="">tag!</span>]]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="SET word value /any /pad">set</span> <span class="word">tag</span> <span class="word datatype"title="">tag!</span> (<span class="path"><span class="word">close-tag</span>/<span class="word">upto</span></span> <span class="word">stack</span> <span class="word">tag</span> <span class="word">upto</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="TAIL series">tail</span> <span class="word">stack</span> <span class="word">starttag</span><br /><span class="tab">&nbsp;</span><span class="word">cb</span> <span class="word">starttag</span> <span class="word">attributes</span><br />]</p></div><p>The <span class="code"><span class="word">close-tag</span></span> function looks into the stack to see if the element the <span class="code"><span class="word">endtag</span></span> is
closing is actually open (i.e. it looks for the respective start tag in the stack),
then if the <span class="code"><span class="refinement">/upto</span></span> refinement has been used makes sure that <span class="code"><span class="word">tag</span></span> does not appear
in the stack after it. If all conditions are met, all elements contained into
the element being closed are closed, by sending to the third stage the end tag for
each of them. Then they are removed from the stack.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Functions used by the state machine<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">close-tag:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">stack</span> <span class="word">endtag</span> <span class="refinement">/upto</span> <span class="word">tags</span> <span class="refinement">/local</span> <span class="word">pos</span>] [<br /><span class="tab">&nbsp;</span><span class="set-word">endtag:</span> <span class="word key"title="REMOVE series /part range">remove</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">endtag</span><br /><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="set-word">pos:</span> <span class="path"><span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span>/<span class="word key"title="LAST series">last</span></span> <span class="word">stack</span> <span class="word">endtag</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word">tags</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="FOREACH 'word data body">foreach</span> <span class="word">tag</span> <span class="word">tags</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="ALL block">all</span> [<span class="set-word">tag:</span> <span class="path"><span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span>/<span class="word key"title="LAST series">last</span></span> <span class="word">stack</span> <span class="word">tag</span> <span class="word key"title="GREATER? value1 value2">greater?</span> <span class="word key"title="INDEX? series /xy">index?</span> <span class="word">tag</span> <span class="word key"title="INDEX? series /xy">index?</span> <span class="word">pos</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="EXIT ">exit</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="FOREACH 'word data body">foreach</span> <span class="word">tag</span> <span class="word key"title="HEAD series">head</span> <span class="word key"title="REVERSE value /part range">reverse</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">pos</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">cb</span> <span class="word key"title="HEAD series">head</span> <span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">tag</span> <span class="string">"/"</span> <span class="word">none</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="SAME? value1 value2">same?</span> <span class="word">stack</span> <span class="word">block-stack</span> [<span class="word">nl</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="CLEAR series">clear</span> <span class="word">pos</span><br /><span class="tab">&nbsp;</span>]<br />]</p></div><p>The <span class="code"><span class="word">close-all</span></span> function is used to close all elements in the given stack. For
example it is used to close all inline elements when going back to block level,
and for closing all elements at the end of the document.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Functions used by the state machine<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">close-all:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">stack</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="FOREACH 'word data body">foreach</span> <span class="word">tag</span> <span class="word key"title="HEAD series">head</span> <span class="word key"title="REVERSE value /part range">reverse</span> <span class="word">stack</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">cb</span> <span class="word key"title="HEAD series">head</span> <span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">tag</span> <span class="string">"/"</span> <span class="word">none</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="SAME? value1 value2">same?</span> <span class="word">stack</span> <span class="word">block-stack</span> [<span class="word">nl</span>]<br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="CLEAR series">clear</span> <span class="word">stack</span><br />]</p></div></div>
    <div id="footer"><p><a href="http://www.rebol.com/">MakeDoc3 by REBOL</a> - 2-Sep-2018</p></div>
</body>
</html>
