<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta name="generator" content="REBOL" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

  <title>Functions to send and receive encrypted message packets</title>

<style type="text/css">
/*<![CDATA[*/
html, body, p, li {font-family: Georgia, Times New Roman, serif; text-align: justify;}
.code, .code p {font-family: Trebuchet MS, Arial, Helvetica, sans-serif;}
.code .string, .code .tag, .code .issue {font-family: Lucida Console, Courier New, Courier, fixed;}
.code .word, .code .set-word, .code .lit-word, .code .get-word, .code .refinement {font-style: italic;}
.code .key {font-style: normal; font-weight: bold;}
.code .function {font-weight: bold; font-style: normal;}
.code .ref a {text-decoration: none; color: black;}
.code .ref a:hover {text-decoration: underline; color: blue;}
.code .issue, .code .tag, .code .datatype {color: green;}
.code .datatype {font-style: normal;}
.code .url, .code .file, .code .refinement, .code .lit-word {color: brown;}
.code .integer, .code .decimal, .code .tuple, .code .pair {color: blue;}
.code .comment {color: gray;}
div.code {margin-left: 95pt;}
div.code p.sectdef {font-style: normal; margin: 0 0 0 -30pt;}
div.code p {margin: 0;}
div.code span.tab {padding-left: .75cm; border-left: dotted thin #CCCCCC;}
div.code span.directive {background-color: #F0FFF0; border: dotted thin black;}
#header {margin: 34pt 140pt 140pt 140pt; padding: 0;}
#title {text-align: center; margin: 0 0 34pt 0;}
#author {text-align: center; margin: 13pt 0 0 0; font-size: 13pt;}
#dateversion {text-align: center; margin: 0 0 24pt 0; font-size: 12pt;}
#purpose {text-align: justify; font-style: italic;}
#license {font-size: 7pt; color: gray; margin: 2pt 10pt 2pt 10pt; width: 200pt; float: right; white-space: pre;}
#history {width: 60%; font-size: 10pt; margin-left: auto; margin-right: auto;}
#history thead tr {background-color: #E0E0E0;}
#history td.date {text-align: right;}
#history td.version {text-align: center;}
#history td.desc {width: 100%; text-align: justify;}
#history td.name {text-align: left;}
#toc {margin: 70pt;}
#toc li {list-style: none;}
.section {margin: 70pt 70pt 70pt 100pt;}
.section h2, .section h3 {margin-left: -30pt;}
pre {font-family: Lucida Console; overflow: scroll;}
.center {margin-left: auto; margin-right: auto; text-align: center;}
span.bra {font-family: Arial Unicode MS;}
div.note {margin: 3pt; margin-bottom: 14pt; padding: 0 12pt 6pt 12pt; background-color: #E0E0E0;}
div.note h2 {
    margin: 0 -12pt 12pt -12pt;
    padding: 5pt;
    text-align: center;
    background-color: #606060;
    color: white;
    font-size: 14pt;
}
div.image {text-align: center;}
div.image img {padding: 10px; border: dashed thin black;}
/*]]>*/
</style>
</head>

<body>
    <div id="header"><h1 id="title">Functions to send and receive encrypted message packets</h1><h2 id="author">Gabriele Santilli</h2><h2 id="dateversion">1.0.5</h2><p id="purpose">
        Defines functions to send and receive encrypted message packets, as
        well as establishing secure communication between peers (eg. via TCP).
    </p><div id="license">
        =================================
        A message from Qtask about this source code:

        We have selected the MIT license (as of 2010-Jan-1) because
        it is the closest “standard” license to our intent.  If we had our way,
        we would declare this source as public domain, with absolutely no
        strings attached, not even the string that says you have to have
        strings.  We want to help people, so please feel free to contact us
        at API@Qtask.com if you have questions.
         

        (you only need to include the standard license text below in your
        homage to this source code)
        =================================

        Copyright 2010 Qtask, Inc.

        Permission is hereby granted, free of charge, to any person obtaining
        a copy of this software and associated documentation files
        (the "Software"), to deal in the Software without restriction, including
        without limitation the rights to use, copy, modify, merge, publish,
        distribute, sublicense, and/or sell copies of the Software, and to
        permit persons to whom the Software is furnished to do so, subject
        to the following conditions:

        The above copyright notice and this permission notice shall be included
        in all copies or substantial portions of the Software.

        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
        OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
        FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
        THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
        OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
        ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
        OTHER DEALINGS IN THE SOFTWARE.
    </div></div><div id="toc"><h2>Contents:</h2><ul><li><a href="#section-1">1. Introduction</a></li><li><a href="#section-2">2. Overview</a></li><ul><li><a href="#section-2.1">2.1 <span class="code"><span class="word">send-message</span></span> and <span class="code"><span class="word">receive-message</span></span></a></li><li><a href="#section-2.2">2.2 Protocol handshake</a></li></ul><li><a href="#section-3">3. Session variables</a></li><li><a href="#section-4">4. Serialize, encrypt and encapsulate <span class="code"><span class="word">message</span></span></a></li><ul><li><a href="#section-4.1">4.1 <span class="code"><span class="word">send-message</span></span>'s support functions and values</a></li></ul><li><a href="#section-5">5. Process the next message in <span class="code"><span class="word">buffer</span></span></a></li><ul><li><a href="#section-5.1">5.1 <span class="code"><span class="word">recieve-message</span></span>'s locals</a></li><li><a href="#section-5.2">5.2 <span class="code"><span class="word">receive-message</span></span>'s support functions and values</a></li></ul><li><a href="#section-6">6. Send the greeting message to the peer</a></li><li><a href="#section-7">7. Handle <span class="code"><span class="word">message</span></span> and return response message</a></li><ul><li><a href="#section-7.1">7.1 <span class="code"><span class="word">handle-handshake-message</span></span>'s locals</a></li><li><a href="#section-7.2">7.2 RSA encryption and decryption functions</a></li></ul><li><a href="#section-8">8. Support functions</a></li><li><a href="#section-9">9. Hardball errors</a></li><ul><li><a href="#section-9.1">9.1 List of error values</a></li></ul><li><a href="#section-10">10. Random number generator initialization</a></li><li><a href="#section-11">11. Definition of constants used by the code</a></li></ul></div><div class="section"><h2 id="section-1">1. Introduction</h2><p>This module defines a set of functions to send and receive encrypted message packets.
They are used as the basis of the Hardball protocol, and are defined separately to ease
testing and to allow reuse in other similar REBOL based protocols.</p></div><div class="section"><h2 id="section-2">2. Overview</h2><p>All the functions here take a <span class="code"><span class="word">session</span></span> object as argument; this object holds the state
of the session between the two peers that are exchanging messages. You can use the
<span class="code"><span class="word">make-messages-session</span></span> function to create and initialize such an object when the session
is established (eg. on TCP connection).</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Overview<span class="bra">&#9002;</span> &#8801;</p><p><span class="ref"><span class="bra">&#9001;</span><a href="#section-10">Random number generator initialization</a><span class="bra">&#9002;</span></span><br /><span class="ref"><span class="bra">&#9001;</span><a href="#section-11">Definition of constants used by the code</a><span class="bra">&#9002;</span></span><br /><span class="ref"><span class="bra">&#9001;</span><a href="#section-9">Hardball errors</a><span class="bra">&#9002;</span></span><br /><span class="ref"><span class="bra">&#9001;</span><a href="#section-8">Support functions</a><span class="bra">&#9002;</span></span><br /><br /><span class="set-word">make-messages-session:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Create a messages session object"</span><br />] [<br /><span class="tab">&nbsp;</span><span class="word key"title="CONTEXT blk">context</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3">Session variables</a><span class="bra">&#9002;</span></span><br /><span class="tab">&nbsp;</span>]<br />]</p></div><h3 id="section-2.1">2.1 <span class="code"><span class="word">send-message</span></span> and <span class="code"><span class="word">receive-message</span></span></h3><p><span class="code"><span class="word">send-message</span></span> allows you to send a REBOL block to the other peer. The <span class="code"><span class="word">output</span></span> can
be a <span class="code"><span class="word datatype"title="">binary!</span></span> (or any other string series) that you can then send to the other peer
by other means, or (for example) a TCP port connected to your peer (needs to be in
binary mode). This function takes care of serialization, encryption and encapsulation
of the message.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Overview<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">send-message:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Send a message securely"</span><br /><span class="tab">&nbsp;</span><span class="word">output</span> [<span class="word datatype"title="">port!</span> <span class="word datatype"title="">any-string!</span>] <span class="string">"Message destination"</span><br /><span class="tab">&nbsp;</span><span class="word">session</span> [<span class="word datatype"title="">object!</span>]<br /><span class="tab">&nbsp;</span><span class="word">message</span> [<span class="word datatype"title="">block!</span>] <span class="string">"Contents"</span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-4">Serialize, encrypt and encapsulate <span class="code"><span class="word">message</span></span></a><span class="bra">&#9002;</span></span><br />]</p></div><p>The opposite function, <span class="code"><span class="word">receive-message</span></span>, takes care of "decapsulation", decryption and
recreation of the original message. <span class="code"><span class="word">buffer</span></span> contains the data coming from the other
peer, and may contain many messages or even a partial message. The buffer is modified
(bytes that are "consumed" are removed from it; also any "garbage" that is not recognized
as a message packet is removed), so you need to copy it if you want to preserve its contents.
The function returns <span class="code"><span class="word">none</span></span> if there are no messages in the buffer, or if the message in the
buffer is not complete (that is, more data is needed and should be appended to the buffer);
otherwise it returns the first message in the buffer (messages are always <span class="code"><span class="word datatype"title="">block!</span></span> values),
and remove it from the buffer. You should call it in a loop until it returns <span class="code"><span class="word">none</span></span> in order
to get all the messages in the buffer.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Overview<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">receive-message:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Receive a message sent by SEND-MESSAGE"</span> [<span class="word key"title="CATCH block /name word">catch</span>]<br /><span class="tab">&nbsp;</span><span class="word">buffer</span> [<span class="word datatype"title="">any-string!</span>] <span class="string">{Input buffer (may contain many messages, is MODIFIED)}</span><br /><span class="tab">&nbsp;</span><span class="word">session</span> [<span class="word datatype"title="">object!</span>]<br /><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="ref"><span class="bra">&#9001;</span><a href="#section-5.1"><span class="code"><span class="word">recieve-message</span></span>'s locals</a><span class="bra">&#9002;</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-5">Process the next message in <span class="code"><span class="word">buffer</span></span></a><span class="bra">&#9002;</span></span><br />]</p></div><p>For example:</p><div class="code"><p><span class="word key"title="WHILE cond-block body-block">while</span> [<span class="set-word">message:</span> <span class="word">receive-message</span> <span class="word">buffer</span> <span class="word">session</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="PROBE value">probe</span> <span class="word">message</span><br />]<br /><span class="comment">; all messages in the buffer have been considered at this point</span></p></div><p>Please note, that after that loop, <span class="code"><span class="word">buffer</span></span> may not be empty, but contain a partial
message that is still being received etc. If you were receiving data from a TCP port,
you would do something like (assuming binary no-wait port):</p><div class="code"><p><span class="word key"title="FOREVER body">forever</span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="WAIT value /all">wait</span> <span class="word">port</span><br /><span class="tab">&nbsp;</span><span class="word key"title="UNLESS condition block">unless</span> <span class="set-word">data:</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">port</span> [<span class="word key"title="BREAK /return value">break</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="APPEND series value /only">append</span> <span class="word">buffer</span> <span class="word">data</span><br /><span class="tab">&nbsp;</span><span class="word key"title="WHILE cond-block body-block">while</span> [<span class="set-word">message:</span> <span class="word">receive-message</span> <span class="word">buffer</span> <span class="word">session</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="PROBE value">probe</span> <span class="word">message</span><br /><span class="tab">&nbsp;</span>]<br />]</p></div><p><span class="code"><span class="word">receive-message</span></span> can throw errors if the message in the buffer is invalid. See <span class="code"><span class="ref"><span class="bra">&#9001;</span><a href="#section-9.1">List of error values</a><span class="bra">&#9002;</span></span></span>
for more details.</p><h3 id="section-2.2">2.2 Protocol handshake</h3><p>The message exchange protocol is based on an initial handshake between the two peer
to establish secure communication. During handshake, peer authentication is performed,
and a session key is established.</p><p>The handshake can be performed using the <span class="code"><span class="word">greet-messages-peer</span></span> and <span class="code"><span class="word">handle-handshake-message</span></span>
functions:</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Overview<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">greet-messages-peer:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Send the Hardball greeting to the other peer"</span><br /><span class="tab">&nbsp;</span><span class="word">output</span> [<span class="word datatype"title="">port!</span> <span class="word datatype"title="">any-string!</span>]<br /><span class="tab">&nbsp;</span><span class="word">session</span> [<span class="word datatype"title="">object!</span>]<br /><span class="tab">&nbsp;</span><span class="word">config</span> [<span class="word datatype"title="">object!</span>]<br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-6">Send the greeting message to the peer</a><span class="bra">&#9002;</span></span><br />]<br /><span class="set-word">handle-handshake-message:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">{Handle Hardball messages during the protocol handshake phase}</span> [<span class="word key"title="CATCH block /name word">catch</span>]<br /><span class="tab">&nbsp;</span><span class="word">session</span> [<span class="word datatype"title="">object!</span>]<br /><span class="tab">&nbsp;</span><span class="word">config</span> [<span class="word datatype"title="">object!</span>]<br /><span class="tab">&nbsp;</span><span class="word">message</span> [<span class="word datatype"title="">block!</span>]<br /><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="ref"><span class="bra">&#9001;</span><a href="#section-7.1"><span class="code"><span class="word">handle-handshake-message</span></span>'s locals</a><span class="bra">&#9002;</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-7">Handle <span class="code"><span class="word">message</span></span> and return response message</a><span class="bra">&#9002;</span></span><br />]</p></div><p>On connection, you use <span class="code"><span class="word">greet-messages-peer</span></span> as the first thing to send the greeting. Then,
you call <span class="code"><span class="word">handle-handshake-message</span></span> with the messages you get, and send its result block
to the peer, until you get <span class="code"><span class="word">true</span></span> as a result, which means that the handshake phase is complete
and you can start sending / receiving messages securely over the channel.</p><div class="code"><p><span class="set-word">config:</span> <span class="word key"title="CONTEXT blk">context</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">public-key:</span> <span class="word">my-rsa-public-key</span><br /><span class="tab">&nbsp;</span><span class="set-word">private-key:</span> <span class="word">my-rsa-private-key</span><br /><span class="tab">&nbsp;</span><span class="set-word">allowed-peers:</span> [ <span class="word">...</span> ] <span class="comment">; list of public keys</span><br />]<br /><span class="set-word">port:</span> <span class="path"><span class="word key"title="OPEN spec /binary /string /direct /seek /new /read /write /no-wait /lines /with end-of-line /allow access /mode args /custom params /skip length">open</span>/<span class="word">binary</span>/<span class="word">no-wait</span></span> <span class="url">tcp://somehost:1025</span><br /><span class="set-word">session:</span> <span class="word">make-messages-session</span><br /><span class="word">greet-messages-peer</span> <span class="word">port</span> <span class="word">session</span> <span class="word">config</span><br /><span class="set-word">buffer:</span> <span class="binary">#{}</span><br /><span class="word key"title="FOREVER body">forever</span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="WAIT value /all">wait</span> <span class="word">port</span><br /><span class="tab">&nbsp;</span><span class="word key"title="UNLESS condition block">unless</span> <span class="set-word">data:</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">port</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">error!</span> <span class="string">"Connection unexpectedly closed during handshake"</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="APPEND series value /only">append</span> <span class="word">buffer</span> <span class="word">data</span><br /><span class="tab">&nbsp;</span><span class="word key"title="WHILE cond-block body-block">while</span> [<span class="set-word">message:</span> <span class="word">receive-message</span> <span class="word">buffer</span> <span class="word">session</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">message:</span> <span class="word">handle-handshake-message</span> <span class="word">session</span> <span class="word">config</span> <span class="word">message</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word">message</span> <span class="word key"title="= value1 value2">=</span> <span class="word">true</span> [<span class="word key"title="BREAK /return value">break</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="BLOCK? value">block?</span> <span class="word">message</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">send-message</span> <span class="word">port</span> <span class="word">session</span> <span class="word">message</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word">message</span> <span class="word key"title="= value1 value2">=</span> <span class="word">true</span> [<span class="word key"title="BREAK /return value">break</span>]<br />]<br /><span class="comment">; handshake phase complete</span><br /><span class="comment">; there may still be messages in buffer at this point</span></p></div><p>See <span class="code"><span class="ref"><span class="bra">&#9001;</span><a href="#section-9.1">List of error values</a><span class="bra">&#9002;</span></span></span> for the kind of errors they can throw.</p></div><div class="section"><h2 id="section-3">3. Session variables</h2><p>We'll introduce and explain the session variables as we encounter them below.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Session variables<span class="bra">&#9002;</span> &#8801;</p><p><span class="comment">; see below</span></p></div></div><div class="section"><h2 id="section-4">4. Serialize, encrypt and encapsulate <span class="code"><span class="word">message</span></span></h2><p>The message is serialized using <span class="code"><span class="path"><span class="word key"title="MOLD value /only /all /flat">mold</span>/<span class="word key"title="ALL block">all</span>/<span class="word">only</span></span></span> and encrypted using <span class="code"><span class="word">encrypt-message</span></span> (see <span class="code"><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.1"><span class="code"><span class="word">send-message</span></span>'s support functions and values</a><span class="bra">&#9002;</span></span></span>).
Then, a message packet header is generated and prepended to it.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Serialize, encrypt and encapsulate <span class="code"><span class="word">message</span></span><span class="bra">&#9002;</span> &#8801;</p><p><span class="comment">; TODO: compand and expand</span><br /><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"Sending message:"</span> <span class="path"><span class="word key"title="MOLD value /only /all /flat">mold</span>/<span class="word key"title="ALL block">all</span>/<span class="word">only</span></span> <span class="word">message</span>]<br /><span class="set-word">message:</span> <span class="word">encrypt-message</span> <span class="word">session</span> <span class="path"><span class="word key"title="MOLD value /only /all /flat">mold</span>/<span class="word key"title="ALL block">all</span>/<span class="word">only</span></span> <span class="word">message</span><br /><span class="set-path">send-hdr/block-length:</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">message</span><br /><span class="comment">;send-hdr/payload-length: 0</span><br /><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"Sending message header:"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="word key"title="GET word /any">get</span> <span class="word">send-hdr</span>]<br /><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="TAIL series">tail</span> <span class="word">output</span><br /><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="MOLD value /only /all /flat">mold</span>/<span class="word">only</span></span> <span class="word key"title="GET word /any">get</span> <span class="word">send-hdr</span><br /><span class="tab">&nbsp;</span><span class="char">#"^@"</span><br /><span class="tab">&nbsp;</span><span class="word">message</span></p></div><h3 id="section-4.1">4.1 <span class="code"><span class="word">send-message</span></span>'s support functions and values</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">send-message</span></span>'s support functions and values<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">encrypt-message:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">session</span> <span class="word">data</span> <span class="refinement">/local</span> <span class="word">port</span> <span class="word">hmac-key</span> <span class="word">hmac</span>] [<br /><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"Encrypting"</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">data</span> <span class="string">"bytes message"</span>]<br /><span class="tab">&nbsp;</span><span class="comment">; encrypt the data</span><br /><span class="tab">&nbsp;</span><span class="set-word">port:</span> <span class="word key"title="OPEN spec /binary /string /direct /seek /new /read /write /no-wait /lines /with end-of-line /allow access /mode args /custom params /skip length">open</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">scheme:</span> <span class="lit-word">'crypt</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">algorithm:</span> <span class="lit-word">'blowfish</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">direction:</span> <span class="lit-word">'encrypt</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">strength:</span> <span class="integer">160</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">key:</span> (<span class="word">next-number</span> <span class="path"><span class="word">session</span>/<span class="word">output-sequence</span></span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">padding:</span> <span class="word">true</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">init-vector:</span> <span class="binary">#{48E1041BB8D358D79B3D6D5B6C21A73C90D7B88E}</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug-secret</span> [<span class="string">"Encrypting message using key:"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="path"><span class="word">port</span>/<span class="word">key</span></span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word">port</span> <span class="word">data</span><br /><span class="tab">&nbsp;</span><span class="word key"title="UPDATE port">update</span> <span class="word">port</span><br /><span class="tab">&nbsp;</span><span class="set-word">data:</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">port</span><br /><span class="tab">&nbsp;</span><span class="word key"title="CLOSE port">close</span> <span class="word">port</span><br /><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"Encrypted message:"</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">data</span> <span class="string">"bytes"</span>]<br /><span class="tab">&nbsp;</span><span class="comment">; add HMAC</span><br /><span class="tab">&nbsp;</span><span class="set-word">hmac-key:</span> <span class="word">next-number</span> <span class="path"><span class="word">session</span>/<span class="word">output-sequence</span></span><br /><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug-secret</span> [<span class="string">"HMAC key:"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="word">hmac-key</span>]<br /><span class="tab">&nbsp;</span><span class="set-word">hmac:</span> <span class="path"><span class="word key"title="CHECKSUM data /tcp /secure /hash size /method word /key key-value">checksum</span>/<span class="word key"title="SECURE 'level">secure</span>/<span class="word">key</span></span> <span class="word">data</span> <span class="word">hmac-key</span><br /><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"HMAC:"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="word">hmac</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="HEAD series">head</span> <span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word">data</span> <span class="word">hmac</span><br />]<br /><span class="set-word">header!:</span> <span class="word key"title="CONTEXT blk">context</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">hardball:</span> <span class="lit-word">'Hardball</span><br /><span class="tab">&nbsp;</span><span class="set-word">version:</span> <span class="integer">1</span><br /><span class="tab">&nbsp;</span><span class="set-word">block-length:</span> <span class="integer">0</span><br /><span class="tab">&nbsp;</span><span class="set-word">payload-length:</span> <span class="integer">0</span><br />]<br /><span class="set-word">send-hdr:</span> <span class="word key"title="MAKE type spec">make</span> <span class="word">header!</span> [ ]</p></div><p>We're using a random number sequence for output messages ("output sequence"); by default
it is initialized with <span class="code"><span class="word">magic-number</span></span> as the seed (the actual encryption starts only after
the handshake is done; before that, messages are obfuscated but can be decrypted by anyone).</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Session variables<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">output-sequence:</span> <span class="word">make-sequence</span> <span class="word">magic-number</span></p></div></div><div class="section"><h2 id="section-5">5. Process the next message in <span class="code"><span class="word">buffer</span></span></h2><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Process the next message in <span class="code"><span class="word">buffer</span></span><span class="bra">&#9002;</span> &#8801;</p><p><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"receive-message:"</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">buffer</span> <span class="string">"bytes in the buffer"</span>]<br /><span class="word key"title="UNLESS condition block">unless</span> <span class="path"><span class="word">session</span>/<span class="word">header</span></span> [<br /><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"Scanning for message header"</span>]<br /><span class="tab">&nbsp;</span><span class="comment">; skip any garbage before the header</span><br /><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="REMOVE series /part range">remove</span>/<span class="word">part</span></span> <span class="word">buffer</span> <span class="word key"title="ANY block">any</span> [<span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span> <span class="word">buffer</span> <span class="lit-word">'Hardball</span> <span class="word key"title="TAIL series">tail</span> <span class="word">buffer</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="set-word">mark:</span> <span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span> <span class="word">buffer</span> <span class="char">#"^@"</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="comment">; LOAD will stop at the null character!</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">session/header:</span> <span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">block!</span> <span class="word key"title="AS-STRING string">as-string</span> <span class="word">buffer</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"Received message header:"</span> <span class="path"><span class="word key"title="MOLD value /only /all /flat">mold</span>/<span class="word key"title="ALL block">all</span></span> <span class="path"><span class="word">session</span>/<span class="word">header</span></span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="REMOVE series /part range">remove</span>/<span class="word">part</span></span> <span class="word">buffer</span> <span class="word key"title="NEXT series">next</span> <span class="word">mark</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="UNLESS condition block">unless</span> <span class="word key"title="PARSE input rules /all /case">parse</span> <span class="path"><span class="word">session</span>/<span class="word">header</span></span> <span class="word">header-rule</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">mark:</span> <span class="path"><span class="word">session</span>/<span class="word">header</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">reset-session</span> <span class="word">session</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">throw-error</span> [<span class="lit-word">'Invalid-Header</span> <span class="word">mark</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"Message header not found or not complete"</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word">max-header-length</span> <span class="word key"title="&lt; value1 value2">&lt;</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">buffer</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">reset-session</span> <span class="word">session</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="comment">; see if we can find the next message</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="REMOVE series /part range">remove</span>/<span class="word">part</span></span> <span class="word">buffer</span> <span class="integer">8</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">throw-error</span> [<span class="lit-word">'Header-Too-Long</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">buffer</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="ALL block">all</span> [<span class="path"><span class="word">session</span>/<span class="word">header</span></span> <span class="word key"title="NOT value">not</span> <span class="path"><span class="word">session</span>/<span class="word">block</span></span>] [<br /><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"Receiving message block"</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="SET word value /any /pad">set</span> <span class="word">recv-hdr</span> <span class="path"><span class="word">session</span>/<span class="word">header</span></span><br /><span class="tab">&nbsp;</span><span class="word key"title="CASE block /all">case</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word">recv-hdr</span>/<span class="word">block-length</span></span> <span class="word key"title="&amp;lt; value1 value2">&lt;</span> <span class="integer">3</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">reset-session</span> <span class="word">session</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">throw-error</span> [<span class="lit-word">'Block-Too-Short</span> <span class="path"><span class="word">recv-hdr</span>/<span class="word">block-length</span></span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word">recv-hdr</span>/<span class="word">block-length</span></span> <span class="word key"title="&gt; value1 value2">&gt;</span> <span class="path"><span class="word">session</span>/<span class="word">max-block-length</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">reset-session</span> <span class="word">session</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="REMOVE series /part range">remove</span>/<span class="word">part</span></span> <span class="word">buffer</span> <span class="path"><span class="word">recv-hdr</span>/<span class="word">block-length</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="REMOVE series /part range">remove</span>/<span class="word">part</span></span> <span class="word">buffer</span> <span class="path"><span class="word">recv-hdr</span>/<span class="word">payload-length</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">throw-error</span> [<span class="lit-word">'Block-Too-Long</span> <span class="path"><span class="word">recv-hdr</span>/<span class="word">block-length</span></span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="lit-word">'else</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"Block length:"</span> <span class="path"><span class="word">recv-hdr</span>/<span class="word">block-length</span></span> <span class="string">"bytes. Received:"</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">buffer</span> <span class="string">"bytes."</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="path"><span class="word">recv-hdr</span>/<span class="word">block-length</span></span> <span class="word key"title="&lt;= value1 value2">&lt;=</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">buffer</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">session/block:</span> <span class="path"><span class="word key"title="COPY value /part range /deep">copy</span>/<span class="word">part</span></span> <span class="word">buffer</span> <span class="path"><span class="word">recv-hdr</span>/<span class="word">block-length</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="set-path">session/block:</span> <span class="word">decrypt-message</span> <span class="word">session</span> <span class="path"><span class="word">session</span>/<span class="word">block</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">session/block:</span> <span class="word">log-attempt</span> [<span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">block!</span> <span class="word key"title="TO type spec">to</span> <span class="word datatype"title="">string!</span> <span class="path"><span class="word">session</span>/<span class="word">block</span></span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"Received message:"</span> <span class="path"><span class="word key"title="MOLD value /only /all /flat">mold</span>/<span class="word key"title="ALL block">all</span></span> <span class="path"><span class="word">session</span>/<span class="word">block</span></span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="REMOVE series /part range">remove</span>/<span class="word">part</span></span> <span class="word">buffer</span> <span class="path"><span class="word">recv-hdr</span>/<span class="word">block-length</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="UNLESS condition block">unless</span> <span class="path"><span class="word">session</span>/<span class="word">block</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">reset-session</span> <span class="word">session</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">throw-error</span> <span class="lit-word">'Can't-Decrypt</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"Message block not complete"</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="path"><span class="word">recv-hdr</span>/<span class="word">payload-length</span></span> <span class="word key"title="&lt;&gt; value1 value2">&lt;&gt;</span> <span class="integer">0</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="THROW value /name word">throw</span> <span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">error!</span> <span class="string">"Expand/compand not supported yet"</span><br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="word key"title="LENGTH? series">length?</span> <span class="word">buffer</span> <span class="string">"bytes still in the buffer"</span>]<br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="path"><span class="word">session</span>/<span class="word">block</span></span> [<br /><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"We have the full message"</span>]<br /><span class="tab">&nbsp;</span><span class="word">also</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word">session</span>/<span class="word">block</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">reset-session</span> <span class="word">session</span><br />]</p></div><p>We need to keep these three variables in the session to be able to reconstruct
messages incrementally (ie. across multiple calls to <span class="code"><span class="word">receive-message</span></span>):</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Session variables<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">header:</span> <span class="set-word">block:</span> <span class="set-word">payload:</span> <span class="word">none</span></p></div><p>The maximum block and payload lengths are also kept in the session object since
they can be changed per-session.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Session variables<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">max-block-length:</span> <span class="integer">64</span> <span class="word key"title="* value1 value2">*</span> <span class="integer">1024</span><br /><span class="set-word">max-payload-length:</span> <span class="integer">0</span> <span class="comment">; not implemented yet</span></p></div><h3 id="section-5.1">5.1 <span class="code"><span class="word">recieve-message</span></span>'s locals</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">recieve-message</span></span>'s locals<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">mark</span></p></div><h3 id="section-5.2">5.2 <span class="code"><span class="word">receive-message</span></span>'s support functions and values</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">receive-message</span></span>'s support functions and values<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">header-rule:</span> [<span class="lit-word">'Hardball</span> <span class="integer">1</span> <span class="integer">1</span> <span class="integer">1</span> <span class="word datatype"title="">integer!</span> <span class="word datatype"title="">integer!</span>]<br /><span class="set-word">recv-hdr:</span> <span class="word key"title="MAKE type spec">make</span> <span class="word">header!</span> [ ]<br /><span class="set-word">reset-session:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">session</span>] [<br /><span class="tab">&nbsp;</span><span class="set-path">session/header:</span> <span class="set-path">session/block:</span> <span class="set-path">session/payload:</span> <span class="word">none</span><br />]<br /><span class="set-word">decrypt-message:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">session</span> <span class="word">data</span> <span class="refinement">/local</span> <span class="word">port</span> <span class="word">hmac</span> <span class="word">d-key</span> <span class="word">hmac-key</span> <span class="word">comp-hmac</span>] [<br /><span class="tab">&nbsp;</span><span class="set-word">hmac:</span> <span class="path"><span class="word key"title="COPY value /part range /deep">copy</span>/<span class="word">part</span></span> <span class="word">data</span> <span class="integer">20</span><br /><span class="tab">&nbsp;</span><span class="set-word">data:</span> <span class="word key"title="SKIP series offset">skip</span> <span class="word">data</span> <span class="integer">20</span><br /><span class="tab">&nbsp;</span><span class="set-word">d-key:</span> <span class="word">next-number</span> <span class="path"><span class="word">session</span>/<span class="word">input-sequence</span></span><br /><span class="tab">&nbsp;</span><span class="set-word">hmac-key:</span> <span class="word">next-number</span> <span class="path"><span class="word">session</span>/<span class="word">input-sequence</span></span><br /><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"Received HMAC:"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="word">hmac</span>]<br /><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug-secret</span> [<span class="string">"HMAC key:"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="word">hmac-key</span>]<br /><span class="tab">&nbsp;</span><span class="set-word">comp-hmac:</span> <span class="path"><span class="word key"title="CHECKSUM data /tcp /secure /hash size /method word /key key-value">checksum</span>/<span class="word key"title="SECURE 'level">secure</span>/<span class="word">key</span></span> <span class="word">data</span> <span class="word">hmac-key</span><br /><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"Computed HMAC:"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="word">comp-hmac</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word">hmac</span> <span class="word key"title="&amp;lt;&amp;gt; value1 value2">&lt;&gt;</span> <span class="word">comp-hmac</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'error</span> [<span class="string">"Message HMAC mismatch"</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="RETURN value">return</span> <span class="word">none</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug-secret</span> [<span class="string">"Decrypting using key:"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="word">d-key</span>]<br /><span class="tab">&nbsp;</span><span class="set-word">port:</span> <span class="word key"title="OPEN spec /binary /string /direct /seek /new /read /write /no-wait /lines /with end-of-line /allow access /mode args /custom params /skip length">open</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">scheme:</span> <span class="lit-word">'crypt</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">algorithm:</span> <span class="lit-word">'blowfish</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">direction:</span> <span class="lit-word">'decrypt</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">strength:</span> <span class="integer">160</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">key:</span> <span class="word">d-key</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">padding:</span> <span class="word">true</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">init-vector:</span> <span class="binary">#{48E1041BB8D358D79B3D6D5B6C21A73C90D7B88E}</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word">port</span> <span class="word">data</span><br /><span class="tab">&nbsp;</span><span class="word key"title="UPDATE port">update</span> <span class="word">port</span><br /><span class="tab">&nbsp;</span><span class="word">also</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">port</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="CLOSE port">close</span> <span class="word">port</span><br />]</p></div><p>The input sequence works in the same way as the output sequence. (See <span class="code"><span class="word">sm-support</span></span>.)</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Session variables<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">input-sequence:</span> <span class="word">make-sequence</span> <span class="word">magic-number</span></p></div></div><div class="section"><h2 id="section-6">6. Send the greeting message to the peer</h2><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Send the greeting message to the peer<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">send-message</span> <span class="word">output</span> <span class="word">session</span> <span class="word key"title="REDUCE value /only words">reduce</span> [<span class="lit-word">'Hello</span> <span class="path"><span class="word">config</span>/<span class="word">public-key</span></span>]</p></div></div><div class="section"><h2 id="section-7">7. Handle <span class="code"><span class="word">message</span></span> and return response message</h2><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Handle <span class="code"><span class="word">message</span></span> and return response message<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">append-test-trace</span> <span class="path"><span class="word">session</span>/<span class="word">state</span></span><br /><span class="word key"title="SWITCH value cases /default case">switch</span> <span class="path"><span class="word">session</span>/<span class="word">state</span></span> [<br /><span class="tab">&nbsp;</span><span class="word">hello</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word">message</span> [<span class="lit-word">'Hello</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">key</span> <span class="word datatype"title="">binary!</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="FIND series value /part range /only /case /any /with wild /skip size /match /tail /last /reverse">find</span> <span class="path"><span class="word">config</span>/<span class="word">allowed-peers</span></span> <span class="word">key</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'allowed</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"Accepted peer:"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="word">key</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">session/peer-public-key:</span> <span class="word">key</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">session/session-key:</span> <span class="word">next-number</span> <span class="word">master-sequence</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug-secret</span> [<span class="string">"Generated random number:"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="path"><span class="word">session</span>/<span class="word">session-key</span></span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">message:</span> <span class="word">encrypt-rsa</span> <span class="word">key</span> <span class="path"><span class="word">session</span>/<span class="word">session-key</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"Sending encrypted random number:"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="word">message</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">session/state:</span> <span class="lit-word">'key</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="REDUCE value /only words">reduce</span> [<span class="lit-word">'Key</span> <span class="word">message</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'error</span> [<span class="string">"Peer is not welcome:"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="word">key</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">throw-error</span> [<span class="lit-word">'Not-Welcome</span> <span class="word">key</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'error</span> [<span class="string">"Peer is being rude:^/"</span> <span class="path"><span class="word key"title="COPY value /part range /deep">copy</span>/<span class="word">part</span></span> <span class="path"><span class="word key"title="MOLD value /only /all /flat">mold</span>/<span class="word">only</span>/<span class="word key"title="ALL block">all</span></span> <span class="word">message</span> <span class="integer">30</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">throw-error</span> <span class="lit-word">'Rude</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word">key</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word">message</span> [<span class="lit-word">'Key</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">key</span> <span class="word datatype"title="">binary!</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> [<span class="lit-word">'got-key</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">key</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"Got peer's random number:"</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">key</span> <span class="string">"bytes"</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">key:</span> <span class="word">decrypt-rsa</span> <span class="path"><span class="word">config</span>/<span class="word">private-key</span></span> <span class="word">key</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug-secret</span> [<span class="string">"Peer's random number:"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="word">key</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug-secret</span> [<span class="string">"My random number:"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="path"><span class="word">session</span>/<span class="word">session-key</span></span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> [<span class="lit-word">'decrypted</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">key</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="integer">20</span> <span class="word key"title="= value1 value2">=</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">key</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'key-ok</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">key:</span> <span class="word">key</span> <span class="word key"title="XOR value1 value2">xor</span> <span class="path"><span class="word">session</span>/<span class="word">session-key</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug-secret</span> [<span class="string">"Session secret:"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="word">key</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">key:</span> <span class="word">make-sequence</span> <span class="word">key</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> [<span class="lit-word">'role</span> <span class="path"><span class="word">session</span>/<span class="word">role</span></span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="path"><span class="word">session</span>/<span class="word">role</span></span> <span class="word key"title="= value1 value2">=</span> <span class="lit-word">'server</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">session/input-sequence:</span> <span class="word">make-sequence</span> <span class="word">next-number</span> <span class="word">key</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">session/output-sequence:</span> <span class="word">make-sequence</span> <span class="word">next-number</span> <span class="word">key</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">session/output-sequence:</span> <span class="word">make-sequence</span> <span class="word">next-number</span> <span class="word">key</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">session/input-sequence:</span> <span class="word">make-sequence</span> <span class="word">next-number</span> <span class="word">key</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug-secret</span> [<span class="string">"Input sequence:^/"</span> <span class="path"><span class="word key"title="MOLD value /only /all /flat">mold</span>/<span class="word key"title="ALL block">all</span></span> <span class="path"><span class="word">session</span>/<span class="word">input-sequence</span></span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug-secret</span> [<span class="string">"Output sequence:^/"</span> <span class="path"><span class="word key"title="MOLD value /only /all /flat">mold</span>/<span class="word key"title="ALL block">all</span></span> <span class="path"><span class="word">session</span>/<span class="word">output-sequence</span></span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">session/verification:</span> <span class="word">next-number</span> <span class="word">key</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"Verification number:"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="path"><span class="word">session</span>/<span class="word">verification</span></span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">key:</span> <span class="word">encrypt-rsa</span> <span class="path"><span class="word">config</span>/<span class="word">private-key</span></span> <span class="path"><span class="word">session</span>/<span class="word">verification</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">session/state:</span> <span class="lit-word">'verify</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> [<span class="lit-word">'encrypted-ver-number</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">key</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="REDUCE value /only words">reduce</span> [<span class="lit-word">'Verify</span> <span class="word">key</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'error</span> [<span class="string">"Peer's random number is not 20 bytes long"</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">throw-error</span> [<span class="lit-word">'Key-Length</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">key</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'error</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="string">{Unexpected message (expecting peer's random number):
}</span> <span class="path"><span class="word key"title="COPY value /part range /deep">copy</span>/<span class="word">part</span></span> <span class="path"><span class="word key"title="MOLD value /only /all /flat">mold</span>/<span class="word">only</span>/<span class="word key"title="ALL block">all</span></span> <span class="word">message</span> <span class="integer">30</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">throw-error</span> <span class="lit-word">'Key-Expected</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word">verify</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="PARSE input rules /all /case">parse</span> <span class="word">message</span> [<span class="lit-word">'Verify</span> <span class="word key"title="SET word value /any /pad">set</span> <span class="word">key</span> <span class="word datatype"title="">binary!</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> [<span class="lit-word">'got-ver-number</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">key</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"Got verification number:"</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">key</span> <span class="string">"bytes"</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">key:</span> <span class="word">decrypt-rsa</span> <span class="path"><span class="word">session</span>/<span class="word">peer-public-key</span></span> <span class="word">key</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> [<span class="lit-word">'decrypted-ver-number</span> <span class="word key"title="LENGTH? series">length?</span> <span class="word">key</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="string">"My verification number:"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="path"><span class="word">session</span>/<span class="word">verification</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="string">"Peer's verification number:"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="word">key</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word">key</span> <span class="word key"title="= value1 value2">=</span> <span class="path"><span class="word">session</span>/<span class="word">verification</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-test-trace</span> <span class="lit-word">'all-good</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'debug</span> [<span class="string">"All is good! Session established"</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">session/state:</span> <span class="lit-word">'data</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">true</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'error</span> [<span class="string">"Verification number does not match"</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">throw-error</span> [<span class="lit-word">'Liar</span> <span class="word">key</span> <span class="path"><span class="word">session</span>/<span class="word">verification</span></span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'error</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="string">{Unexpected message (expecting verification number):
}</span> <span class="path"><span class="word key"title="COPY value /part range /deep">copy</span>/<span class="word">part</span></span> <span class="path"><span class="word key"title="MOLD value /only /all /flat">mold</span>/<span class="word">only</span>/<span class="word key"title="ALL block">all</span></span> <span class="word">message</span> <span class="integer">30</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">throw-error</span> <span class="lit-word">'Verification-Expected</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word">data</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">throw-error</span> <span class="lit-word">'Handshake-Complete</span><br /><span class="tab">&nbsp;</span>]<br />]</p></div><p>The handshake phase uses the following session variables:</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Session variables<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">state:</span> <span class="lit-word">'hello</span><br /><span class="set-word">peer-public-key:</span> <span class="set-word">session-key:</span> <span class="word">none</span><br /><span class="set-word">role:</span> <span class="lit-word">'server</span><br /><span class="set-word">verification:</span> <span class="word">none</span></p></div><h3 id="section-7.1">7.1 <span class="code"><span class="word">handle-handshake-message</span></span>'s locals</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">handle-handshake-message</span></span>'s locals<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">key</span></p></div><h3 id="section-7.2">7.2 RSA encryption and decryption functions</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>RSA encryption and decryption functions<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">encrypt-rsa:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">key</span> <span class="word">value</span> <span class="refinement">/local</span> <span class="word">key'</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="OBJECT? value">object?</span> <span class="word">key</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="comment">; private key</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="RSA-ENCRYPT obj data /decrypt /private /padding padding-type">rsa-encrypt</span>/<span class="word">private</span></span> <span class="word">key</span> <span class="word">value</span><br /><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="comment">; public key</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">key':</span> <span class="word key"title="RSA-MAKE-KEY ">rsa-make-key</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">key'/e:</span> <span class="integer">3</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">key'/n:</span> <span class="word">key</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="RSA-ENCRYPT obj data /decrypt /private /padding padding-type">rsa-encrypt</span> <span class="word">key'</span> <span class="word">value</span><br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="set-word">decrypt-rsa:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">key</span> <span class="word">value</span> <span class="refinement">/local</span> <span class="word">key'</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="OBJECT? value">object?</span> <span class="word">key</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="comment">; private key</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="RSA-ENCRYPT obj data /decrypt /private /padding padding-type">rsa-encrypt</span>/<span class="word">decrypt</span>/<span class="word">private</span></span> <span class="word">key</span> <span class="word">value</span><br /><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="comment">; public key</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">key':</span> <span class="word key"title="RSA-MAKE-KEY ">rsa-make-key</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">key'/e:</span> <span class="integer">3</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">key'/n:</span> <span class="word">key</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="RSA-ENCRYPT obj data /decrypt /private /padding padding-type">rsa-encrypt</span>/<span class="word">decrypt</span></span> <span class="word">key'</span> <span class="word">value</span><br /><span class="tab">&nbsp;</span>]<br />]</p></div></div><div class="section"><h2 id="section-8">8. Support functions</h2><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Support functions<span class="bra">&#9002;</span> &#8801;</p><p><span class="ref"><span class="bra">&#9001;</span><a href="#section-4.1"><span class="code"><span class="word">send-message</span></span>'s support functions and values</a><span class="bra">&#9002;</span></span><br /><span class="ref"><span class="bra">&#9001;</span><a href="#section-5.2"><span class="code"><span class="word">receive-message</span></span>'s support functions and values</a><span class="bra">&#9002;</span></span><br /><span class="ref"><span class="bra">&#9001;</span><a href="#section-7.2">RSA encryption and decryption functions</a><span class="bra">&#9002;</span></span></p></div></div><div class="section"><h2 id="section-9">9. Hardball errors</h2><p>In this section we list and define all the message-level errors.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Hardball errors<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-path">system/error:</span> <span class="word key"title="MAKE type spec">make</span> <span class="path"><span class="word">system</span>/<span class="word">error</span></span> [<br /><span class="tab">&nbsp;</span><span class="set-word">Hardball:</span> <span class="word key"title="CONTEXT blk">context</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">code:</span> <span class="integer">1000</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">type:</span> <span class="string">"Hardball Error"</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-9.1">List of error values</a><span class="bra">&#9002;</span></span><br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="set-word">throw-error:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">args</span> [<span class="word datatype"title="">block!</span> <span class="word datatype"title="">word!</span>]] [<br /><span class="tab">&nbsp;</span><span class="word key"title="THROW value /name word">throw</span> <span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">error!</span> <span class="word key"title="JOIN value rest">join</span> [<span class="word">Hardball</span>] <span class="word">args</span><br />]<br /><span class="set-word">log-attempt:</span> <span class="word key"title="FUNC spec body">func</span> [<span class="word">value</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="ERROR? value">error?</span> <span class="path"><span class="word key"title="SET word value /any /pad">set</span>/<span class="word key"title="ANY block">any</span></span> <span class="lit-word">'value</span> <span class="word key"title="TRY block">try</span> <span class="get-word">:value</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">append-log</span> <span class="lit-word">'error</span> [<span class="path"><span class="word">form-error</span>/<span class="word key"title="ALL block">all</span></span> <span class="word key"title="DISARM error">disarm</span> <span class="word">value</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">none</span><br /><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="GET word /any">get</span>/<span class="word key"title="ANY block">any</span></span> <span class="lit-word">'value</span><br /><span class="tab">&nbsp;</span>]<br />]</p></div><h3 id="section-9.1">9.1 List of error values</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>List of error values<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">Invalid-Header:</span> [<span class="string">"Invalid message header:"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="get-word">:arg1</span>]<br /><span class="set-word">Header-Too-Long:</span> [<span class="string">"Message header too long ("</span> <span class="get-word">:arg1</span> <span class="string">"bytes)"</span>]<br /><span class="set-word">Block-Too-Short:</span> [<span class="string">"Message too short ("</span> <span class="get-word">:arg1</span> <span class="string">"bytes)"</span>]<br /><span class="set-word">Block-Too-Long:</span> [<span class="string">"Message too long ("</span> <span class="get-word">:arg1</span> <span class="string">"bytes)"</span>]<br /><span class="set-word">Can't-Decrypt:</span> <span class="string">"Unable to decrypt message"</span><br /><span class="set-word">Not-Welcome:</span> [<span class="string">"Peer"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="path"><span class="word key"title="COPY value /part range /deep">copy</span>/<span class="word">part</span></span> <span class="get-word">:arg1</span> <span class="integer">5</span> <span class="string">"is not welcome"</span>]<br /><span class="set-word">Rude:</span> <span class="string">"Peer is being rude (expected Hello message)"</span><br /><span class="set-word">Key-Length:</span> [<span class="string">"Invalid random number length"</span> <span class="get-word">:arg1</span> <span class="string">"(expected 20)"</span>]<br /><span class="set-word">Key-Expected:</span> <span class="string">{Unexpected message (expected 160 bit random number)}</span><br /><span class="set-word">Liar:</span> [<span class="string">"Peer attempted to deceive us (received"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="path"><span class="word key"title="COPY value /part range /deep">copy</span>/<span class="word">part</span></span> <span class="get-word">:arg1</span> <span class="integer">5</span> <span class="string">", expected"</span> <span class="word key"title="MOLD value /only /all /flat">mold</span> <span class="path"><span class="word key"title="COPY value /part range /deep">copy</span>/<span class="word">part</span></span> <span class="get-word">:arg2</span> <span class="integer">5</span> <span class="string">")"</span>]<br /><span class="set-word">Verification-Expected:</span> <span class="string">"Unexpected message (expected verification number)"</span><br /><span class="set-word">Handshake-Complete:</span> <span class="string">{Handshake phase already complete, please don't call handle-handshake-message}</span></p></div></div><div class="section"><h2 id="section-10">10. Random number generator initialization</h2><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Random number generator initialization<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">random-seed:</span> <span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word key"title="ALL block">all</span> [<span class="path"><span class="word">system</span>/<span class="word">version</span>/<span class="integer">4</span></span> <span class="word key"title="&amp;amp;lt;&amp;amp;gt; value1 value2">&lt;&gt;</span> <span class="integer">3</span> <span class="word key"title="EXISTS? target">exists?</span> <span class="file">%/dev/urandom</span>] [<br /><span class="tab">&nbsp;</span><span class="set-word">p:</span> <span class="path"><span class="word key"title="OPEN spec /binary /string /direct /seek /new /read /write /no-wait /lines /with end-of-line /allow access /mode args /custom params /skip length">open</span>/<span class="word">direct</span>/<span class="word">binary</span>/<span class="word key"title="READ source /binary /string /direct /no-wait /lines /part size /with end-of-line /mode args /custom params /skip length">read</span></span> <span class="file">%/dev/urandom</span><br /><span class="tab">&nbsp;</span><span class="word">also</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="COPY value /part range /deep">copy</span>/<span class="word">part</span></span> <span class="word">p</span> <span class="integer">20</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<span class="word key"title="CLOSE port">close</span> <span class="word">p</span> <span class="word key"title="UNSET word">unset</span> <span class="lit-word">'p</span>)<br />] [<br /><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="RANDOM value /seed /secure /only">random</span>/<span class="word">seed</span></span> <span class="word key"title="NOW /year /month /day /time /zone /date /weekday /yearday /precise">now</span><br /><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="CHECKSUM data /tcp /secure /hash size /method word /key key-value">checksum</span>/<span class="word key"title="SECURE 'level">secure</span></span> <span class="word key"title="FORM value">form</span> <span class="path"><span class="word key"title="RANDOM value /seed /secure /only">random</span>/<span class="word key"title="SECURE 'level">secure</span></span> <span class="integer">2</span> <span class="word key"title="** number exponent">**</span> <span class="integer">48</span><br />]<br /><span class="set-word">master-sequence:</span> <span class="word">make-sequence</span> <span class="word">random-seed</span></p></div></div><div class="section"><h2 id="section-11">11. Definition of constants used by the code</h2><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Definition of constants used by the code<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">magic-number:</span> <span class="binary">#{FD6BF3E23DB9A5317FAF36B2A5779B63D2225D22}</span><br /><span class="set-word">max-header-length:</span> <span class="integer">64</span></p></div></div>
    <div id="footer"><p><a href="http://www.rebol.com/">MakeDoc3 by REBOL</a> - 2-Sep-2018</p></div>
</body>
</html>
