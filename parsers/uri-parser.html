<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta name="generator" content="REBOL" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

  <title>A standards-compliant URI parser</title>

<style type="text/css">
/*<![CDATA[*/
html, body, p, li {font-family: Georgia, Times New Roman, serif; text-align: justify;}
.code, .code p {font-family: Trebuchet MS, Arial, Helvetica, sans-serif;}
.code .string, .code .tag, .code .issue {font-family: Lucida Console, Courier New, Courier, fixed;}
.code .word, .code .set-word, .code .lit-word, .code .get-word, .code .refinement {font-style: italic;}
.code .key {font-style: normal; font-weight: bold;}
.code .function {font-weight: bold; font-style: normal;}
.code .ref a {text-decoration: none; color: black;}
.code .ref a:hover {text-decoration: underline; color: blue;}
.code .issue, .code .tag, .code .datatype {color: green;}
.code .datatype {font-style: normal;}
.code .url, .code .file, .code .refinement, .code .lit-word {color: brown;}
.code .integer, .code .decimal, .code .tuple, .code .pair {color: blue;}
.code .comment {color: gray;}
div.code {margin-left: 95pt;}
div.code p.sectdef {font-style: normal; margin: 0 0 0 -30pt;}
div.code p {margin: 0;}
div.code span.tab {padding-left: .75cm; border-left: dotted thin #CCCCCC;}
div.code span.directive {background-color: #F0FFF0; border: dotted thin black;}
#header {margin: 34pt 140pt 140pt 140pt; padding: 0;}
#title {text-align: center; margin: 0 0 34pt 0;}
#author {text-align: center; margin: 13pt 0 0 0; font-size: 13pt;}
#dateversion {text-align: center; margin: 0 0 24pt 0; font-size: 12pt;}
#purpose {text-align: justify; font-style: italic;}
#license {font-size: 7pt; color: gray; margin: 2pt 10pt 2pt 10pt; width: 200pt; float: right; white-space: pre;}
#history {width: 60%; font-size: 10pt; margin-left: auto; margin-right: auto;}
#history thead tr {background-color: #E0E0E0;}
#history td.date {text-align: right;}
#history td.version {text-align: center;}
#history td.desc {width: 100%; text-align: justify;}
#history td.name {text-align: left;}
#toc {margin: 70pt;}
#toc li {list-style: none;}
.section {margin: 70pt 70pt 70pt 100pt;}
.section h2, .section h3 {margin-left: -30pt;}
pre {font-family: Lucida Console; overflow: scroll;}
.center {margin-left: auto; margin-right: auto; text-align: center;}
span.bra {font-family: Arial Unicode MS;}
div.note {margin: 3pt; margin-bottom: 14pt; padding: 0 12pt 6pt 12pt; background-color: #E0E0E0;}
div.note h2 {
    margin: 0 -12pt 12pt -12pt;
    padding: 5pt;
    text-align: center;
    background-color: #606060;
    color: white;
    font-size: 14pt;
}
div.image {text-align: center;}
div.image img {padding: 10px; border: dashed thin black;}
/*]]>*/
</style>
</head>

<body>
    <div id="header"><h1 id="title">A standards-compliant URI parser</h1><h2 id="author">Gabriele Santilli</h2><h2 id="dateversion">2.0.1</h2><p id="purpose">
        Defines the PARSE-URI function, that can parse both absolute
        and relative URIs.
    </p><div id="license">
        =================================
        A message from Qtask about this source code:

        We have selected the MIT license (as of 2010-Jan-1) because
        it is the closest “standard” license to our intent.  If we had our way,
        we would declare this source as public domain, with absolutely no
        strings attached, not even the string that says you have to have
        strings.  We want to help people, so please feel free to contact us
        at API@Qtask.com if you have questions.
         

        (you only need to include the standard license text below in your
        homage to this source code)
        =================================

        Copyright 2009 Qtask, Inc.

        Permission is hereby granted, free of charge, to any person obtaining
        a copy of this software and associated documentation files
        (the "Software"), to deal in the Software without restriction, including
        without limitation the rights to use, copy, modify, merge, publish,
        distribute, sublicense, and/or sell copies of the Software, and to
        permit persons to whom the Software is furnished to do so, subject
        to the following conditions:

        The above copyright notice and this permission notice shall be included
        in all copies or substantial portions of the Software.

        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
        OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
        FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
        THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
        OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
        ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
        OTHER DEALINGS IN THE SOFTWARE.
    </div></div><div id="toc"><h2>Contents:</h2><ul><li><a href="#section-1">1. Introduction</a></li><li><a href="#section-2">2. Overview</a></li><li><a href="#section-3">3. Parse rules</a></li><ul><li><a href="#section-3.1">3.1 Words used by the rules</a></li><li><a href="#section-3.2">3.2 <span class="code"><span class="word">parse-uri</span></span>'s body</a></li><li><a href="#section-3.3">3.3 Decode <span class="code"><span class="word">obj</span></span>'s fields into subfields</a></li></ul><li><a href="#section-4">4. The <span class="code"><span class="word">percent-decode</span></span> and <span class="code"><span class="word">percent-encode</span></span> functions</a></li><li><a href="#section-5">5. Form an URI string from its components</a></li><ul><li><a href="#section-5.1">5.1 <span class="code"><span class="word">form-uri</span></span>'s locals</a></li><li><a href="#section-5.2">5.2 Encode the URI's fields</a></li></ul></ul></div><div class="section"><h2 id="section-1">1. Introduction</h2><p>URL parsing code in REBOL 2, despite being quite good for the job it needs to do,
has a number of problems and limitations:</p><ul><li>it does not handle percent-encoding (since this is <em>incorrectly</em> handled by
the <span class="code"><span class="word datatype"title="">url!</span></span> datatype parser - see note below);</li><li>it only works on URLs, as they were intended to be used with REBOL ports: it
does not handle the more generic URI syntax;</li><li>lacks support for IPv6 (since REBOL 2 does not support IPv6 anyway), which I hope
can be added to REBOL 3.</li></ul><p>Also, REBOL 2 does not provide any tools for handling URIs, such as URI normalization,
comparison, relative URI resolution and so on. I propose to improve the current code
for use in REBOL 3.</p><div class="note"><h2>Design flaw in <span class="code"><span class="word datatype"title="">url!</span></span> <span class="code"><span class="word key"title="LOAD source /header /next /library /markup /all">load</span></span>'ing</h2><p>REBOL 2 has a design flaw in the way <span class="code"><span class="word datatype"title="">url!</span></span> values are <span class="code"><span class="word key"title="LOAD source /header /next /library /markup /all">load</span></span>'ed and <span class="code"><span class="word key"title="MOLD value /only /all /flat">mold</span></span>'ed.
<span class="code"><span class="word key"title="LOAD source /header /next /library /markup /all">load</span></span> will decode <em>all</em> percent-encoded characters, while <span class="code"><span class="word key"title="MOLD value /only /all /flat">mold</span></span> re-encodes only
characters with an ASCII code less than 33. This is incorrect, and it makes it
impossible to use URLs in some cases (the common example being a user name which
contains a @ character). The standard states that "the components and subcomponents
significant to the scheme-specific dereferencing process (if any) must be parsed
and separated before the percent-encoded octets within those components can be
safely decoded", with the exception of "percent-encoded octets corresponding to
characters in the unreserved set, which can be decoded at any time".</p><p>I propose that REBOL 3 should follow the rules in the standard specification.</p></div></div><div class="section"><h2 id="section-2">2. Overview</h2><p>The <span class="code"><span class="word">parse-uri</span></span> function takes a URI as input (relative URIs are accepted if the
<span class="code"><span class="refinement">/relative</span></span> refinement is used) and returns an object containing the <span class="code"><span class="word">scheme</span></span>,
<span class="code"><span class="word">userinfo</span></span>, <span class="code"><span class="word">host</span></span>, <span class="code"><span class="word">port</span></span>, <span class="code"><span class="word key"title="PATH value selector">path</span></span>, <span class="code"><span class="word key"title="QUERY target /clear">query</span></span> and <span class="code"><span class="word">fragment</span></span> elements of the URI. Note
that only <span class="code"><span class="word key"title="PATH value selector">path</span></span> is guaranteed to never be <span class="code"><span class="word">none</span></span>, and is always a block of path
segments; if it is an absolute path, then the first element of the block is the
word <span class="code"><span class="lit-word">'root</span></span>; if a <span class="code"><span class="word">host</span></span> is present, then the path is always absolute, so the <span class="code"><span class="lit-word">'root</span></span>
word is omitted.</p><p>No syntax is assumed for the URI components. The <span class="code"><span class="word">decode-uri-fields</span></span> function can
be used to further decode the URI components according to the following syntax: 
<span class="code"><span class="word">userinfo</span></span> is subdelimited by <span class="code"><span class="string">":"</span></span> and gets
parsed to a block of segments (usually, username and password), and <span class="code"><span class="word key"title="QUERY target /clear">query</span></span> is
subdelimited by <span class="code"><span class="string">"&amp;"</span></span> and <span class="code"><span class="string">"="</span></span> and gets parsed to a block of blocks (in the form
<span class="code">[[<span class="string">"name1"</span> <span class="string">"value1"</span>] [<span class="string">"name2"</span> <span class="string">"value2"</span>] <span class="word">...</span>]</span>); the fragment is also checked
for the common Web 2.0 usage of <span class="code"><span class="string">"?"</span></span>, <span class="code"><span class="string">"&amp;"</span></span> and <span class="code"><span class="string">"="</span></span> and parsed to a block
if that's the case, with the format <span class="code">[<span class="string">"fragment"</span> [<span class="string">"name1"</span> <span class="string">"value1"</span>] [<span class="string">"name2"</span> <span class="string">"value2"</span>] <span class="word">...</span>]</span>;
all segments are then percent-decoded.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Overview<span class="bra">&#9002;</span> &#8801;</p><p><span class="ref"><span class="bra">&#9001;</span><a href="#section-3">Parse rules</a><span class="bra">&#9002;</span></span><br /><br /><span class="set-word">parse-uri:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Parse a URI into its components"</span><br /><span class="tab">&nbsp;</span><span class="word">uri</span> [<span class="word datatype"title="">any-string!</span>]<br /><span class="tab">&nbsp;</span><span class="refinement">/relative</span> <span class="string">"Allow relative URIs"</span><br /><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="ref"><span class="bra">&#9001;</span><a href="#section-3.2.1"><span class="code"><span class="word">parse-uri</span></span>'s locals</a><span class="bra">&#9002;</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3.2"><span class="code"><span class="word">parse-uri</span></span>'s body</a><span class="bra">&#9002;</span></span><br />]<br /><span class="set-word">decode-uri-fields:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Decode the fields of a URI object (see docs)"</span><br /><span class="tab">&nbsp;</span><span class="word">obj</span> [<span class="word datatype"title="">object!</span>]<br /><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="ref"><span class="bra">&#9001;</span><a href="#section-3.3.1"><span class="code"><span class="word">decode-uri-fields</span></span>' locals</a><span class="bra">&#9002;</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-3.3">Decode <span class="code"><span class="word">obj</span></span>'s fields into subfields</a><span class="bra">&#9002;</span></span><br />]</p></div><p>The <span class="code"><span class="word">form-uri</span></span> function is the inverse of <span class="code"><span class="word">parse-uri</span></span>. It takes an object like the
one resulting from <span class="code"><span class="word">parse-uri</span></span> as input and returns a <span class="code"><span class="word datatype"title="">string!</span></span> (we don't use <span class="code"><span class="word datatype"title="">url!</span></span>
for the problem cited above, to avoid percent-encoding confusions). (You can also
supply a <span class="code"><span class="word datatype"title="">block!</span></span> like in <span class="code">[<span class="set-word">scheme:</span> <span class="string">"http"</span> <span class="set-word">host:</span> <span class="string">"www.rebol.com"</span> <span class="word">...</span>]</span>.)</p><p>All the components are assumed to be already percent-encoded etc., otherwise you must
use the <span class="code"><span class="word">encode-uri-fields</span></span> function to properly encode them: in that case, <span class="code"><span class="word">userinfo</span></span>
(if not <span class="code"><span class="word">none</span></span>) should be a block and its elements will be joined and
separated by a <span class="code"><span class="string">":"</span></span>, <span class="code"><span class="word key"title="QUERY target /clear">query</span></span> (if not <span class="code"><span class="word">none</span></span>) should be a block of name/value pairs like
the one returned by <span class="code"><span class="word">decode-uri-fields</span></span> and it will be formed into a query using <span class="code"><span class="string">"&amp;"</span></span> and <span class="code"><span class="string">"="</span></span> with
each name and value percent-encoded, <span class="code"><span class="word">fragment</span></span> can also be a block as described above,
and the other components will be percent-encoded.</p><p>Please note that <span class="code"><span class="word">scheme</span></span> (if not <span class="code"><span class="word">none</span></span>) <strong>must</strong> be a valid URI scheme name and that <span class="code"><span class="word">port</span></span>
(if not <span class="code"><span class="word">none</span></span>) <strong>must</strong> only contain digits.</p><p>Note that in the current implementation of <span class="code"><span class="word">encode-uri-fields</span></span> is not used the components are
percent-encoded in place, thus <em>the passed object is modified</em>.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Overview<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">encode-uri-fields:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Encode the fields of a URI object (see docs)"</span><br /><span class="tab">&nbsp;</span><span class="word">obj</span> [<span class="word datatype"title="">object!</span> <span class="word datatype"title="">block!</span>]<br /><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="ref"><span class="bra">&#9001;</span><a href="#section-5.2.1"><span class="code"><span class="word">encode-uri-fields</span></span>' locals</a><span class="bra">&#9002;</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-5.2">Encode the URI's fields</a><span class="bra">&#9002;</span></span><br />]<br /><span class="set-word">form-uri:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="string">"Form an URI string from its components"</span><br /><span class="tab">&nbsp;</span><span class="word">obj</span> [<span class="word datatype"title="">object!</span> <span class="word datatype"title="">block!</span>] <span class="string">{URI components (scheme, userinfo, host, port, path, query, fragment)}</span><br /><br /><span class="tab">&nbsp;</span><span class="refinement">/local</span> <span class="ref"><span class="bra">&#9001;</span><a href="#section-5.1"><span class="code"><span class="word">form-uri</span></span>'s locals</a><span class="bra">&#9002;</span></span><br />] [<br /><span class="tab">&nbsp;</span><span class="ref"><span class="bra">&#9001;</span><a href="#section-5">Form an URI string from its components</a><span class="bra">&#9002;</span></span><br />]</p></div></div><div class="section"><h2 id="section-3">3. Parse rules</h2><p>These rules are taken almost literally from the specification. I just adapted them
to <span class="code"><span class="word key"title="PARSE input rules /all /case">parse</span></span> and relaxed them a bit to allow non-ascii chars that are not percent-encoded
(so we can parse technically invalid but commonly used URLs and normalize them as valid
URLs). Please see RFC3986 (http://www.gbiv.com/protocols/uri/rfc/rfc3986.html) for
more details and an explanation of the rules.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Parse rules<span class="bra">&#9002;</span> &#8801;</p><p><span class="set-word">uri-rule:</span> [<span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">seg</span> <span class="word">scheme-rule</span> <span class="char">#":"</span> (<span class="set-word">scheme:</span> <span class="word">seg</span>) <span class="word">hier-part</span> <span class="word">opt</span> [<span class="char">#"?"</span> <span class="word">query-rule</span>] <span class="word">opt</span> [<span class="char">#"#"</span> <span class="word">fragment-rule</span>]]<br /><br /><span class="set-word">hier-part:</span> [<span class="string">"//"</span> <span class="word">authority</span> <span class="word">path-abempty</span> <span class="word">|</span> <span class="word">path-absolute</span> <span class="word">|</span> <span class="word">path-rootless</span> <span class="word">|</span> <span class="word">none</span>]<br /><br /><span class="set-word">uri-reference:</span> [<span class="word">uri-rule</span> <span class="word">|</span> <span class="word">relative-ref</span>]<br /><br /><span class="set-word">absolute-uri:</span> [<span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">seg</span> <span class="word">scheme-rule</span> <span class="char">#":"</span> (<span class="set-word">scheme:</span> <span class="word">seg</span>) <span class="word">hier-part</span> <span class="word">opt</span> [<span class="char">#"?"</span> <span class="word">query-rule</span>]]<br /><br /><span class="set-word">relative-ref:</span> [<span class="word">relative-part</span> <span class="word">opt</span> [<span class="char">#"?"</span> <span class="word">query-rule</span>] <span class="word">opt</span> [<span class="char">#"#"</span> <span class="word">fragment-rule</span>]]<br /><br /><span class="set-word">relative-part:</span> [<span class="string">"//"</span> <span class="word">authority</span> <span class="word">path-abempty</span> <span class="word">|</span> <span class="word">path-absolute</span> <span class="word">|</span> <span class="word">path-noscheme</span> <span class="word">|</span> <span class="word">none</span>]<br /><br /><span class="set-word">scheme-rule:</span> [<span class="word">alpha-char</span> <span class="word key"title="ANY block">any</span> [<span class="word">alpha-char</span> <span class="word">|</span> <span class="word">digit</span> <span class="word">|</span> <span class="char">#"+"</span> <span class="word">|</span> <span class="char">#"-"</span> <span class="word">|</span> <span class="char">#"."</span>]]<br /><br /><span class="set-word">authority:</span> [<span class="word">opt</span> [<span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">seg</span> <span class="word">userinfo-rule</span> <span class="char">#"@"</span> (<span class="set-word">userinfo:</span> <span class="word">seg</span>)] <span class="word">host-rule</span> <span class="word">opt</span> [<span class="char">#":"</span> <span class="word">port-rule</span>]]<br /><span class="set-word">userinfo-rule:</span> [<span class="word key"title="ANY block">any</span> [<span class="word">relaxed</span> <span class="word">|</span> <span class="word">pct-encoded</span> <span class="word">|</span> <span class="word">sub-delims</span> <span class="word">|</span> <span class="char">#":"</span>]]<br /><span class="set-word">host-rule:</span> [<span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">host</span> [<span class="word">ip-literal</span> <span class="word">|</span> <span class="word">ipv4address</span> <span class="word">|</span> <span class="word">reg-name</span>]]<br /><span class="set-word">port-rule:</span> [<span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">port</span> <span class="word key"title="ANY block">any</span> <span class="word">digit</span>]<br /><br /><span class="set-word">ip-literal:</span> [<span class="char">#"["</span> [<span class="word">ipvfuture</span> <span class="word">|</span> <span class="word">ipv6address</span>] <span class="char">#"]"</span>]<br /><br /><span class="set-word">ipvfuture:</span> [<span class="char">#"v"</span> <span class="word">some</span> <span class="word">hexdigit</span> <span class="char">#"."</span> <span class="word">some</span> [<span class="word">unreserved</span> <span class="word">|</span> <span class="word">sub-delims</span> <span class="word">|</span> <span class="char">#":"</span>]]<br /><br /><span class="set-word">ipv6address:</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="integer">6</span> [<span class="word">h16</span> <span class="char">#":"</span>] <span class="word">ls32</span><br /><span class="tab">&nbsp;</span><span class="word">|</span> <span class="string">"::"</span> <span class="integer">5</span> [<span class="word">h16</span> <span class="char">#":"</span>] <span class="word">ls32</span><br /><span class="tab">&nbsp;</span><span class="word">|</span> <span class="word">opt</span> <span class="word">h16</span> <span class="string">"::"</span> <span class="integer">4</span> [<span class="word">h16</span> <span class="char">#":"</span>] <span class="word">ls32</span><br /><span class="tab">&nbsp;</span><span class="word">|</span> <span class="word">opt</span> [<span class="word">h16</span> <span class="word">opt</span> [<span class="char">#":"</span> <span class="word">h16</span>]] <span class="string">"::"</span> <span class="integer">3</span> [<span class="word">h16</span> <span class="char">#":"</span>] <span class="word">ls32</span><br /><span class="tab">&nbsp;</span><span class="word">|</span> <span class="word">opt</span> [<span class="word">h16</span> <span class="integer">1</span> <span class="integer">2</span> [<span class="char">#":"</span> <span class="word">h16</span>]] <span class="string">"::"</span> <span class="integer">2</span> [<span class="word">h16</span> <span class="char">#":"</span>] <span class="word">ls32</span><br /><span class="tab">&nbsp;</span><span class="word">|</span> <span class="word">opt</span> [<span class="word">h16</span> <span class="integer">1</span> <span class="integer">3</span> [<span class="char">#":"</span> <span class="word">h16</span>]] <span class="string">"::"</span> <span class="word">h16</span> <span class="char">#":"</span> <span class="word">ls32</span><br /><span class="tab">&nbsp;</span><span class="word">|</span> <span class="word">opt</span> [<span class="word">h16</span> <span class="integer">1</span> <span class="integer">4</span> [<span class="char">#":"</span> <span class="word">h16</span>]] <span class="string">"::"</span> <span class="word">ls32</span><br /><span class="tab">&nbsp;</span><span class="word">|</span> <span class="word">opt</span> [<span class="word">h16</span> <span class="integer">1</span> <span class="integer">5</span> [<span class="char">#":"</span> <span class="word">h16</span>]] <span class="string">"::"</span> <span class="word">h16</span><br /><span class="tab">&nbsp;</span><span class="word">|</span> <span class="word">opt</span> [<span class="word">h16</span> <span class="integer">1</span> <span class="integer">6</span> [<span class="char">#":"</span> <span class="word">h16</span>]] <span class="string">"::"</span><br />] <br /><br /><span class="set-word">h16:</span> [<span class="integer">1</span> <span class="integer">4</span> <span class="word">hexdigit</span>]<br /><span class="set-word">ls32:</span> [<span class="word">h16</span> <span class="char">#":"</span> <span class="word">h16</span> <span class="word">|</span> <span class="word">ipv4address</span>]<br /><br /><span class="set-word">ipv4address:</span> [<span class="word">dec-octet</span> <span class="char">#"."</span> <span class="word">dec-octet</span> <span class="char">#"."</span> <span class="word">dec-octet</span> <span class="char">#"."</span> <span class="word">dec-octet</span>]<br /><br /><span class="set-word">dec-octet:</span> [<span class="string">"25"</span> <span class="word">digit0-5</span> <span class="word">|</span> <span class="char">#"2"</span> <span class="word">digit0-4</span> <span class="word">digit</span> <span class="word">|</span> <span class="char">#"1"</span> <span class="integer">2</span> <span class="word">digit</span> <span class="word">|</span> <span class="word">digit1-9</span> <span class="word">digit</span> <span class="word">|</span> <span class="word">digit</span>]<br /><br /><span class="set-word">reg-name:</span> [<span class="word key"title="ANY block">any</span> [<span class="word">unreserved</span> <span class="word">|</span> <span class="word">pct-encoded</span> <span class="word">|</span> <span class="word">sub-delims</span>]]<br /><br /><span class="set-word">path-abempty:</span> [<span class="word key"title="ANY block">any</span> [<span class="char">#"/"</span> <span class="word">segment</span> (<span class="word key"title="APPEND series value /only">append</span> <span class="word key"title="PATH value selector">path</span> <span class="word">seg</span>)]]<br /><span class="set-word">path-absolute:</span> [<span class="char">#"/"</span> (<span class="word key"title="APPEND series value /only">append</span> <span class="word key"title="PATH value selector">path</span> <span class="lit-word">'root</span>) [<span class="word">segment-nz</span> (<span class="word key"title="APPEND series value /only">append</span> <span class="word key"title="PATH value selector">path</span> <span class="word">seg</span>) <span class="word key"title="ANY block">any</span> [<span class="char">#"/"</span> <span class="word">segment</span> (<span class="word key"title="APPEND series value /only">append</span> <span class="word key"title="PATH value selector">path</span> <span class="word">seg</span>)] <span class="word">|</span> (<span class="word key"title="APPEND series value /only">append</span> <span class="word key"title="PATH value selector">path</span> <span class="string">""</span>)]]<br /><span class="set-word">path-noscheme:</span> [<span class="word">segment-nz-nc</span> (<span class="word key"title="APPEND series value /only">append</span> <span class="word key"title="PATH value selector">path</span> <span class="word">seg</span>) <span class="word key"title="ANY block">any</span> [<span class="char">#"/"</span> <span class="word">segment</span> (<span class="word key"title="APPEND series value /only">append</span> <span class="word key"title="PATH value selector">path</span> <span class="word">seg</span>)]]<br /><span class="set-word">path-rootless:</span> [<span class="word">segment-nz</span> (<span class="word key"title="APPEND series value /only">append</span> <span class="word key"title="PATH value selector">path</span> <span class="word">seg</span>) <span class="word key"title="ANY block">any</span> [<span class="char">#"/"</span> <span class="word">segment</span> (<span class="word key"title="APPEND series value /only">append</span> <span class="word key"title="PATH value selector">path</span> <span class="word">seg</span>)]]<br /><br /><span class="set-word">segment:</span> [<span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">seg</span> <span class="word key"title="ANY block">any</span> <span class="word">pchar</span> (<span class="set-word">seg:</span> <span class="word key"title="ANY block">any</span> [<span class="word">seg</span> <span class="string">""</span>])]<br /><span class="set-word">segment-nz:</span> [<span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">seg</span> <span class="word">some</span> <span class="word">pchar</span>]<br /><span class="set-word">segment-nz-nc:</span> [<span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">seg</span> <span class="word">some</span> [<span class="word">relaxed</span> <span class="word">|</span> <span class="word">pct-encoded</span> <span class="word">|</span> <span class="word">sub-delims</span> <span class="word">|</span> <span class="char">#"@"</span>]]<br /><br /><span class="set-word">pchar:</span> [<span class="word">relaxed</span> <span class="word">|</span> <span class="word">pct-encoded</span> <span class="word">|</span> <span class="word">sub-delims</span> <span class="word">|</span> <span class="char">#":"</span> <span class="word">|</span> <span class="char">#"@"</span>]<br /><br /><span class="set-word">query-rule:</span> [<span class="word key"title="COPY value /part range /deep">copy</span> <span class="word key"title="QUERY target /clear">query</span> <span class="word key"title="ANY block">any</span> [<span class="word">pchar</span> <span class="word">|</span> <span class="char">#"/"</span> <span class="word">|</span> <span class="char">#"?"</span>]]<br /><span class="set-word">fragment-rule:</span> [<span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">fragment</span> <span class="word key"title="ANY block">any</span> [<span class="word">pchar</span> <span class="word">|</span> <span class="char">#"/"</span> <span class="word">|</span> <span class="char">#"?"</span>]]<br /><br /><span class="set-word">pct-encoded:</span> [<span class="char">#"%"</span> <span class="integer">2</span> <span class="word">hexdigit</span>]<br /><br /><span class="set-word">digit0-5:</span> <span class="word key"title="CHARSET chars">charset</span> <span class="string">"012345"</span><br /><span class="set-word">digit0-4:</span> <span class="word key"title="CHARSET chars">charset</span> <span class="string">"01234"</span><br /><span class="set-word">digit1-9:</span> <span class="word key"title="CHARSET chars">charset</span> <span class="string">"123456789"</span><br /><span class="set-word">unreserved:</span> <span class="word key"title="UNION set1 set2 /case /skip size">union</span> <span class="word">alpha-char</span> <span class="word key"title="UNION set1 set2 /case /skip size">union</span> <span class="word">digit</span> <span class="word key"title="CHARSET chars">charset</span> <span class="string">"-._~"</span><br /><span class="set-word">gen-delims:</span> <span class="word key"title="CHARSET chars">charset</span> <span class="string">":/?#[]@"</span><br /><span class="set-word">sub-delims:</span> <span class="word key"title="CHARSET chars">charset</span> <span class="string">"!$&amp;'()*+,;="</span><br /><span class="set-word">reserved:</span> <span class="word key"title="UNION set1 set2 /case /skip size">union</span> <span class="word">gen-delims</span> <span class="word">sub-delims</span><br /><span class="set-word">relaxed:</span> <span class="word key"title="EXCLUDE set1 set2 /case /skip size">exclude</span> <span class="word key"title="COMPLEMENT value">complement</span> <span class="word">reserved</span> <span class="word key"title="CHARSET chars">charset</span> <span class="string">"%"</span></p></div><h3 id="section-3.1">3.1 Words used by the rules</h3><p>The words used by the rules need to be made local to the <span class="code"><span class="word">uri-parser</span></span> object.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Parse rules<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">scheme:</span> <span class="set-word">userinfo:</span> <span class="set-word">host:</span> <span class="set-word">port:</span> <span class="set-word">seg:</span> <span class="set-word">query:</span> <span class="set-word">fragment:</span> <span class="word">none</span><br /><span class="set-word">path:</span> [ ]<br /><span class="set-word">vars:</span> [<span class="word">scheme</span> <span class="word">userinfo</span> <span class="word">host</span> <span class="word">port</span> <span class="word key"title="PATH value selector">path</span> <span class="word key"title="QUERY target /clear">query</span> <span class="word">fragment</span>]</p></div><h3 id="section-3.2">3.2 <span class="code"><span class="word">parse-uri</span></span>'s body</h3><p>We initialize the words in <span class="code"><span class="word">vars</span></span> to <span class="code"><span class="word">none</span></span>, and <span class="code"><span class="word key"title="PATH value selector">path</span></span>
to an empty block. (A path is always present in an URI, but can be empty.)</p><p>Depending on the use of the <span class="code"><span class="refinement">/relative</span></span> refinement, we use the <span class="code"><span class="word">uri-reference</span></span>
or the <span class="code"><span class="word">uri-rule</span></span> rule to parse the URI; if parsing is successfull, we return
an object containing the words in <span class="code"><span class="word">vars</span></span>.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">parse-uri</span></span>'s body<span class="bra">&#9002;</span> &#8801;</p><p><span class="word key"title="SET word value /any /pad">set</span> <span class="word">vars</span> <span class="word">none</span><br /><span class="set-word">path:</span> <span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">block!</span> <span class="integer">8</span><br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="path"><span class="word key"title="PARSE input rules /all /case">parse</span>/<span class="word key"title="ALL block">all</span></span> <span class="word">uri</span> <span class="word key"title="EITHER condition true-block false-block">either</span> <span class="word">relative</span> [<span class="word">uri-reference</span>] [<span class="word">uri-rule</span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="SET word value /any /pad">set</span> <span class="set-word">obj:</span> <span class="word key"title="CONTEXT blk">context</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">scheme:</span> <span class="set-word">userinfo:</span> <span class="set-word">host:</span> <span class="set-word">port:</span> <span class="set-word">path:</span> <span class="set-word">query:</span> <span class="set-word">fragment:</span> <span class="word">none</span><br /><span class="tab">&nbsp;</span>] <span class="word key"title="REDUCE value /only words">reduce</span> <span class="word">vars</span><br /><span class="tab">&nbsp;</span><span class="word">obj</span><br />]</p></div><h4 id="section-3.2.1">3.2.1 <span class="code"><span class="word">parse-uri</span></span>'s locals</h4><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">parse-uri</span></span>'s locals<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">obj</span></p></div><h3 id="section-3.3">3.3 Decode <span class="code"><span class="word">obj</span></span>'s fields into subfields</h3><p>Decoding the URI fields in the most common case means:</p><ul><li>splitting <span class="code"><span class="word">userinfo</span></span> into parts separated by <span class="code"><span class="string">":"</span></span>, and <span class="code"><span class="word">percent-decode</span></span> them;</li><li>decode the <span class="code"><span class="word">host</span></span>;</li><li>decode each segment in the <span class="code"><span class="word key"title="PATH value selector">path</span></span> (of course skipping <span class="code"><span class="lit-word">'root</span></span> if present);</li><li>split the query into <span class="code">[<span class="word">name</span> <span class="word">value</span>]</span> pairs using <span class="code"><span class="string">"&amp;"</span></span> and <span class="code"><span class="string">"="</span></span> as delimiters, and
decode them;</li><li>decode the <span class="code"><span class="word">fragment</span></span>, and split it if necessary (see above).</li></ul><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Decode <span class="code"><span class="word">obj</span></span>'s fields into subfields<span class="bra">&#9002;</span> &#8801;</p><p><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="path"><span class="word">obj</span>/<span class="word">userinfo</span></span> [<br /><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="PARSE input rules /all /case">parse</span>/<span class="word key"title="ALL block">all</span></span> <span class="path"><span class="word">obj</span>/<span class="word">userinfo</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<span class="set-path">obj/userinfo:</span> <span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">block!</span> <span class="integer">3</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="ANY block">any</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">name</span> <span class="word key"title="TO type spec">to</span> <span class="char">#":"</span> <span class="word key"title="SKIP series offset">skip</span> (<span class="word key"title="APPEND series value /only">append</span> <span class="path"><span class="word">obj</span>/<span class="word">userinfo</span></span> <span class="word">percent-decode</span> <span class="word key"title="ANY block">any</span> [<span class="word">name</span> <span class="string">""</span>])<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">name</span> <span class="word key"title="TO type spec">to</span> <span class="word">end</span> (<span class="word key"title="APPEND series value /only">append</span> <span class="path"><span class="word">obj</span>/<span class="word">userinfo</span></span> <span class="word">percent-decode</span> <span class="word key"title="ANY block">any</span> [<span class="word">name</span> <span class="string">""</span>])<br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="path"><span class="word">obj</span>/<span class="word">host</span></span> [<span class="word">percent-decode</span> <span class="path"><span class="word">obj</span>/<span class="word">host</span></span>]<br /><span class="word key"title="FOREACH 'word data body">foreach</span> <span class="word">segment</span> <span class="path"><span class="word">obj</span>/<span class="word key"title="PATH value selector">path</span></span> [<span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="STRING? value">string?</span> <span class="word">segment</span> [<span class="word">percent-decode</span> <span class="word">segment</span>]]<br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="path"><span class="word">obj</span>/<span class="word key"title="QUERY target /clear">query</span></span> [<br /><span class="tab">&nbsp;</span><span class="path"><span class="word key"title="PARSE input rules /all /case">parse</span>/<span class="word key"title="ALL block">all</span></span> <span class="path"><span class="word">obj</span>/<span class="word key"title="QUERY target /clear">query</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<span class="set-path">obj/query:</span> <span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">block!</span> <span class="integer">16</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">some</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">name</span> <span class="word">some</span> <span class="word">query-chars</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="char">#"="</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">val</span> <span class="word">some</span> <span class="word">query-chars</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="char">#"="</span> (<span class="set-word">val:</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="string">""</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<span class="set-word">val:</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="string">""</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<span class="path"><span class="word key"title="APPEND series value /only">append</span>/<span class="word">only</span></span> <span class="path"><span class="word">obj</span>/<span class="word key"title="QUERY target /clear">query</span></span> <span class="word key"title="REDUCE value /only words">reduce</span> [<span class="word">percent-decode</span> <span class="word">name</span> <span class="word">percent-decode</span> <span class="word">val</span>])<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<span class="char">#"&amp;"</span> <span class="word">|</span> <span class="word">end</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">some</span> [<span class="char">#"&amp;"</span> <span class="word">|</span> <span class="char">#"="</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="path"><span class="word">obj</span>/<span class="word">fragment</span></span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="EITHER condition true-block false-block">either</span> <span class="path"><span class="word key"title="PARSE input rules /all /case">parse</span>/<span class="word key"title="ALL block">all</span></span> <span class="path"><span class="word">obj</span>/<span class="word">fragment</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<span class="set-word">fragments:</span> <span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">block!</span> <span class="integer">5</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">name</span> <span class="word key"title="TO type spec">to</span> <span class="char">#"?"</span> <span class="word key"title="SKIP series offset">skip</span> (<span class="word key"title="APPEND series value /only">append</span> <span class="word">fragments</span> <span class="word">percent-decode</span> <span class="word">name</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">some</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">name</span> <span class="word">some</span> <span class="word">query-chars</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="char">#"="</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="word">val</span> <span class="word">some</span> <span class="word">query-chars</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="char">#"="</span> (<span class="set-word">val:</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="string">""</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<span class="set-word">val:</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="string">""</span>)<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>(<span class="path"><span class="word key"title="APPEND series value /only">append</span>/<span class="word">only</span></span> <span class="word">fragments</span> <span class="word key"title="REDUCE value /only words">reduce</span> [<span class="word">percent-decode</span> <span class="word">name</span> <span class="word">percent-decode</span> <span class="word">val</span>])<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>[<span class="char">#"&amp;"</span> <span class="word">|</span> <span class="word">end</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">|</span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">some</span> [<span class="char">#"&amp;"</span> <span class="word">|</span> <span class="char">#"="</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">obj/fragment:</span> <span class="word">fragments</span><br /><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">percent-decode</span> <span class="path"><span class="word">obj</span>/<span class="word">fragment</span></span><br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="word">obj</span></p></div><p>We need a charset in the rule for decoding the <span class="code"><span class="word key"title="QUERY target /clear">query</span></span>:</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Parse rules<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">query-chars:</span> <span class="word key"title="COMPLEMENT value">complement</span> <span class="word key"title="CHARSET chars">charset</span> <span class="string">"&amp;="</span></p></div><h4 id="section-3.3.1">3.3.1 <span class="code"><span class="word">decode-uri-fields</span></span>' locals</h4><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">decode-uri-fields</span></span>' locals<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">name</span> <span class="word">val</span> <span class="word">fragments</span></p></div></div><div class="section"><h2 id="section-4">4. The <span class="code"><span class="word">percent-decode</span></span> and <span class="code"><span class="word">percent-encode</span></span> functions</h2><p>The functions are optimized for the common case of few percent-encoded
characters per string (most usually zero), so they work in place.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Parse rules<span class="bra">&#9002;</span> +&#8801;</p><p><span class="set-word">percent-decode:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="word">string</span> [<span class="word datatype"title="">any-string!</span>]<br />] [<br /><span class="tab">&nbsp;</span><span class="path"><span class="word">decode-text</span>/<span class="word key"title="TO type spec">to</span></span> <span class="word">string</span> <span class="lit-word">'url</span> <span class="word">string</span><br />]<br /><span class="set-word">percent-encode:</span> <span class="word key"title="FUNC spec body">func</span> [<br /><span class="tab">&nbsp;</span><span class="word">string</span> [<span class="word datatype"title="">any-string!</span>]<br />] [<br /><span class="tab">&nbsp;</span><span class="path"><span class="word">encode-text</span>/<span class="word key"title="TO type spec">to</span></span> <span class="word">string</span> <span class="lit-word">'url</span> <span class="word">string</span><br />]</p></div></div><div class="section"><h2 id="section-5">5. Form an URI string from its components</h2><p>The code follows the pseudo-code in the specifications.</p><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Form an URI string from its components<span class="bra">&#9002;</span> &#8801;</p><p><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="BLOCK? value">block?</span> <span class="word">obj</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">obj:</span> <span class="word key"title="MAKE type spec">make</span> <span class="word key"title="CONTEXT blk">context</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">scheme:</span> <span class="set-word">userinfo:</span> <span class="set-word">host:</span> <span class="set-word">port:</span> <span class="set-word">path:</span> <span class="set-word">query:</span> <span class="set-word">fragment:</span> <span class="word">none</span><br /><span class="tab">&nbsp;</span>] <span class="word">obj</span><br />]<br /><br /><span class="set-word">result:</span> <span class="word key"title="MAKE type spec">make</span> <span class="word datatype"title="">string!</span> <span class="integer">256</span><br /><br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="path"><span class="word">obj</span>/<span class="word">scheme</span></span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word">result</span> <span class="path"><span class="word">obj</span>/<span class="word">scheme</span></span> <span class="char">#":"</span><br />]<br /><br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="ANY block">any</span> [<span class="path"><span class="word">obj</span>/<span class="word">userinfo</span></span> <span class="path"><span class="word">obj</span>/<span class="word">host</span></span> <span class="path"><span class="word">obj</span>/<span class="word">port</span></span>] [<br /><span class="tab">&nbsp;</span><span class="word key"title="APPEND series value /only">append</span> <span class="word">result</span> <span class="string">"//"</span><br /><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="path"><span class="word">obj</span>/<span class="word">userinfo</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="TAIL series">tail</span> <span class="word">result</span> <span class="path"><span class="word">obj</span>/<span class="word">userinfo</span></span> <span class="char">#"@"</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="path"><span class="word">obj</span>/<span class="word">host</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="APPEND series value /only">append</span> <span class="word">result</span> <span class="path"><span class="word">obj</span>/<span class="word">host</span></span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="path"><span class="word">obj</span>/<span class="word">port</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="TAIL series">tail</span> <span class="word">result</span> <span class="char">#":"</span> <span class="path"><span class="word">obj</span>/<span class="word">port</span></span><br /><span class="tab">&nbsp;</span>]<br />]<br /><br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="NOT value">not</span> <span class="word key"title="EMPTY? series">empty?</span> <span class="path"><span class="word">obj</span>/<span class="word key"title="PATH value selector">path</span></span> [<br /><span class="tab">&nbsp;</span><span class="set-word">path:</span> <span class="path"><span class="word">obj</span>/<span class="word key"title="PATH value selector">path</span></span><br /><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="NOT value">not</span> <span class="word key"title="ANY block">any</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="path"><span class="word">obj</span>/<span class="word">userinfo</span></span> <span class="path"><span class="word">obj</span>/<span class="word">host</span></span> <span class="path"><span class="word">obj</span>/<span class="word">port</span></span><br /><span class="tab">&nbsp;</span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="STRING? value">string?</span> <span class="path"><span class="word key"title="PATH value selector">path</span>/<span class="integer">1</span></span> [<span class="word key"title="APPEND series value /only">append</span> <span class="word">result</span> <span class="path"><span class="word key"title="PATH value selector">path</span>/<span class="integer">1</span></span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">path:</span> <span class="word key"title="NEXT series">next</span> <span class="word key"title="PATH value selector">path</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="FOREACH 'word data body">foreach</span> <span class="word">segment</span> <span class="word key"title="PATH value selector">path</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="STRING? value">string?</span> <span class="word">segment</span> [<span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="TAIL series">tail</span> <span class="word">result</span> <span class="char">#"/"</span> <span class="word">segment</span>]<br /><span class="tab">&nbsp;</span>]<br />]<br /><br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="path"><span class="word">obj</span>/<span class="word key"title="QUERY target /clear">query</span></span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="TAIL series">tail</span> <span class="word">result</span> <span class="char">#"?"</span> <span class="path"><span class="word">obj</span>/<span class="word key"title="QUERY target /clear">query</span></span><br />]<br /><br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="path"><span class="word">obj</span>/<span class="word">fragment</span></span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="TAIL series">tail</span> <span class="word">result</span> <span class="char">#"#"</span> <span class="path"><span class="word">obj</span>/<span class="word">fragment</span></span><br />]<br /><br /><span class="word">result</span></p></div><h3 id="section-5.1">5.1 <span class="code"><span class="word">form-uri</span></span>'s locals</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">form-uri</span></span>'s locals<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">result</span> <span class="word key"title="PATH value selector">path</span></p></div><h3 id="section-5.2">5.2 Encode the URI's fields</h3><div class="code"><p class="sectdef"><span class="bra">&#9001;</span>Encode the URI's fields<span class="bra">&#9002;</span> &#8801;</p><p><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="BLOCK? value">block?</span> <span class="word">obj</span> [<br /><span class="tab">&nbsp;</span><span class="set-word">obj:</span> <span class="word key"title="MAKE type spec">make</span> <span class="word key"title="CONTEXT blk">context</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">scheme:</span> <span class="set-word">userinfo:</span> <span class="set-word">host:</span> <span class="set-word">port:</span> <span class="set-word">path:</span> <span class="set-word">query:</span> <span class="set-word">fragment:</span> <span class="word">none</span><br /><span class="tab">&nbsp;</span>] <span class="word">obj</span><br />]<br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="ALL block">all</span> [<span class="word key"title="BLOCK? value">block?</span> <span class="path"><span class="word">obj</span>/<span class="word">userinfo</span></span> <span class="word key"title="NOT value">not</span> <span class="word key"title="EMPTY? series">empty?</span> <span class="path"><span class="word">obj</span>/<span class="word">userinfo</span></span>] [<br /><span class="tab">&nbsp;</span><span class="set-word">result:</span> <span class="word">percent-encode</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">obj</span>/<span class="word">userinfo</span>/<span class="integer">1</span></span><br /><span class="tab">&nbsp;</span><span class="word key"title="FOREACH 'word data body">foreach</span> <span class="word">value</span> <span class="word key"title="NEXT series">next</span> <span class="path"><span class="word">obj</span>/<span class="word">userinfo</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="TAIL series">tail</span> <span class="word">result</span> <span class="char">#":"</span> <span class="word">percent-encode</span> <span class="word">value</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="set-path">obj/userinfo:</span> <span class="word">result</span><br />]<br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="path"><span class="word">obj</span>/<span class="word">host</span></span> [<br /><span class="tab">&nbsp;</span><span class="comment">; ip-literal must not be encoded</span><br /><span class="tab">&nbsp;</span><span class="word key"title="UNLESS condition block">unless</span> <span class="path"><span class="word key"title="PARSE input rules /all /case">parse</span>/<span class="word key"title="ALL block">all</span></span> <span class="path"><span class="word">obj</span>/<span class="word">host</span></span> <span class="word">ip-literal</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word">percent-encode</span> <span class="path"><span class="word">obj</span>/<span class="word">host</span></span><br /><span class="tab">&nbsp;</span>]<br />]<br /><span class="word key"title="FOREACH 'word data body">foreach</span> <span class="word">segment</span> <span class="path"><span class="word">obj</span>/<span class="word key"title="PATH value selector">path</span></span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="STRING? value">string?</span> <span class="word">segment</span> [<span class="word">percent-encode</span> <span class="word">segment</span>]<br />]<br /><span class="word key"title="IF condition then-block /else else-block">if</span> <span class="word key"title="ALL block">all</span> [<span class="word key"title="BLOCK? value">block?</span> <span class="path"><span class="word">obj</span>/<span class="word key"title="QUERY target /clear">query</span></span> <span class="word key"title="NOT value">not</span> <span class="word key"title="EMPTY? series">empty?</span> <span class="path"><span class="word">obj</span>/<span class="word key"title="QUERY target /clear">query</span></span>] [<br /><span class="tab">&nbsp;</span><span class="set-word">result:</span> <span class="word">percent-encode</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">obj</span>/<span class="word key"title="QUERY target /clear">query</span>/<span class="integer">1</span>/<span class="integer">1</span></span><br /><span class="tab">&nbsp;</span><span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="INSERT series value /part range /only /dup count">insert</span> <span class="word key"title="TAIL series">tail</span> <span class="word">result</span> <span class="char">#"="</span> <span class="word">percent-encode</span> <span class="path"><span class="word">obj</span>/<span class="word key"title="QUERY target /clear">query</span>/<span class="integer">1</span>/<span class="integer">2</span></span><br /><span class="tab">&nbsp;</span><span class="word key"title="FOREACH 'word data body">foreach</span> <span class="word">pair</span> <span class="word key"title="NEXT series">next</span> <span class="path"><span class="word">obj</span>/<span class="word key"title="QUERY target /clear">query</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="REPEND series value /only">repend</span> <span class="word">result</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="char">#"&amp;"</span> <span class="word">percent-encode</span> <span class="path"><span class="word">pair</span>/<span class="integer">1</span></span> <span class="char">#"="</span> <span class="word">percent-encode</span> <span class="path"><span class="word">pair</span>/<span class="integer">2</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="set-path">obj/query:</span> <span class="word">result</span><br />]<br /><span class="word key"title="CASE block /all">case</span> [<br /><span class="tab">&nbsp;</span><span class="word key"title="ALL block">all</span> [<span class="word key"title="BLOCK? value">block?</span> <span class="path"><span class="word">obj</span>/<span class="word">fragment</span></span> <span class="integer">1</span> <span class="word key"title="&lt; value1 value2">&lt;</span> <span class="word key"title="LENGTH? series">length?</span> <span class="path"><span class="word">obj</span>/<span class="word">fragment</span></span>] [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-word">result:</span> <span class="word">percent-encode</span> <span class="word key"title="COPY value /part range /deep">copy</span> <span class="path"><span class="word">obj</span>/<span class="word">fragment</span>/<span class="integer">1</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="REPEND series value /only">repend</span> <span class="word">result</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="char">#"?"</span> <span class="word">percent-encode</span> <span class="path"><span class="word">obj</span>/<span class="word">fragment</span>/<span class="integer">2</span>/<span class="integer">1</span></span> <span class="char">#"="</span> <span class="word">percent-encode</span> <span class="path"><span class="word">obj</span>/<span class="word">fragment</span>/<span class="integer">2</span>/<span class="integer">2</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="FOREACH 'word data body">foreach</span> <span class="word">pair</span> <span class="word key"title="NEXT series">next</span> <span class="word key"title="NEXT series">next</span> <span class="path"><span class="word">obj</span>/<span class="word">fragment</span></span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="word key"title="REPEND series value /only">repend</span> <span class="word">result</span> [<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="char">#"&amp;"</span> <span class="word">percent-encode</span> <span class="path"><span class="word">pair</span>/<span class="integer">1</span></span> <span class="char">#"="</span> <span class="word">percent-encode</span> <span class="path"><span class="word">pair</span>/<span class="integer">2</span></span><br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="tab">&nbsp;</span><span class="set-path">obj/fragment:</span> <span class="word">result</span><br /><span class="tab">&nbsp;</span>]<br /><span class="tab">&nbsp;</span><span class="word key"title="STRING? value">string?</span> <span class="path"><span class="word">obj</span>/<span class="word">fragment</span></span> [<span class="word">percent-encode</span> <span class="path"><span class="word">obj</span>/<span class="word">fragment</span></span>]<br />]<br /><span class="word">obj</span></p></div><h4 id="section-5.2.1">5.2.1 <span class="code"><span class="word">encode-uri-fields</span></span>' locals</h4><div class="code"><p class="sectdef"><span class="bra">&#9001;</span><span class="code"><span class="word">encode-uri-fields</span></span>' locals<span class="bra">&#9002;</span> &#8801;</p><p><span class="word">result</span></p></div></div>
    <div id="footer"><p><a href="http://www.rebol.com/">MakeDoc3 by REBOL</a> - 2-Sep-2018</p></div>
</body>
</html>
